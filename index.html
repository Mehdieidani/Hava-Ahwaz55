<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>هواشناسی پیشرفته</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif; background: #eef6ff; margin: 0; padding: 0; color: #222; direction: rtl;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background-color: #121212; color: #eee;
    }
    header {
      background: #0077cc; color: white; padding: 15px; text-align: center;
    }
    .container {
      max-width: 700px; margin: 20px auto; padding: 15px; background: white; border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label, input, button, select {
      font-size: 1rem; margin: 5px 0; width: 100%;
      box-sizing: border-box;
    }
    input {
      padding: 8px; border: 1px solid #aaa; border-radius: 5px;
    }
    button {
      background: #0077cc; color: white; border: none; padding: 10px; border-radius: 6px;
      cursor: pointer; transition: background-color 0.3s;
    }
    button:hover {
      background: #005fa3;
    }
    .wind-dir {
      display: inline-block; transition: transform 0.3s ease; font-size: 1.3rem;
    }
    .weather-info {
      margin-top: 15px;
      line-height: 1.6;
    }
    .chart-container {
      margin-top: 25px;
    }
  </style>
</head>
<body>

<header>
  <h1>هواشناسی پیشرفته</h1>
  <p>روستای کاظمی دو و همه شهرهای جهان</p>
</header>

<div class="container" dir="rtl">
  <label for="cityInput">نام شهر یا روستا:</label>
  <input type="text" id="cityInput" placeholder="مثلاً Kazemi Do یا Tehran یا Baghdad" />
  <button id="searchBtn">جستجو</button>
  <button id="geoBtn">📍 موقعیت من</button>
  <button id="themeBtn">تغییر تم</button>

  <div id="weatherInfo" class="weather-info">اطلاعات آب‌وهوا اینجا نمایش داده می‌شود.</div>

  <div class="chart-container">
    <canvas id="windChart" aria-label="نمودار سرعت باد" role="img"></canvas>
  </div>
</div>

<script>
  const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";
  const cityInput = document.getElementById("cityInput");
  const searchBtn = document.getElementById("searchBtn");
  const geoBtn = document.getElementById("geoBtn");
  const themeBtn = document.getElementById("themeBtn");
  const weatherInfo = document.getElementById("weatherInfo");
  const windChartCtx = document.getElementById("windChart").getContext("2d");

  let windChartInstance = null;
  let isDark = false;

  function displayWeather(data) {
    const city = data.city;
    const list = data.list;

    let html = `<h2>${city.name}, ${city.country}</h2>`;
    html += `<p>📍 مختصات: ${city.coord.lat.toFixed(4)}, ${city.coord.lon.toFixed(4)}</p>`;

    // نمایش اطلاعات اولین لحظه (اکنون)
    const now = list[0];
    html += `<p>🌡️ دما: ${now.main.temp}°C</p>`;
    html += `<p>💧 رطوبت: ${now.main.humidity}%</p>`;
    html += `<p>🌬️ باد: ${now.wind.speed} m/s 
      <span class="wind-dir" style="transform: rotate(${now.wind.deg}deg)">🧭</span>
    </p>`;
    html += `<p>☁️ وضعیت: ${now.weather[0].description}</p>`;
    html += `<p>🌅 طلوع خورشید: ${new Date(city.sunrise * 1000).toLocaleTimeString("fa-IR")}</p>`;
    html += `<p>🌇 غروب خورشید: ${new Date(city.sunset * 1000).toLocaleTimeString("fa-IR")}</p>`;

    weatherInfo.innerHTML = html;

    // نمودار سرعت باد (5 روز ساعتی، هر 3 ساعت یک نقطه)
    const labels = [];
    const speeds = [];

    list.slice(0, 40).forEach(item => {
      const dt = new Date(item.dt * 1000);
      labels.push(dt.toLocaleString("fa-IR", { hour: "2-digit", day: "numeric", month: "numeric" }));
      speeds.push(item.wind.speed);
    });

    if (windChartInstance) windChartInstance.destroy();

    windChartInstance = new Chart(windChartCtx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "سرعت باد (m/s)",
          data: speeds,
          borderColor: "#0077cc",
          backgroundColor: "rgba(0, 119, 204, 0.3)",
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "سرعت باد (m/s)" } },
          x: { ticks: { maxRotation: 90, minRotation: 45 } }
        }
      }
    });
  }

  async function fetchWeather(city) {
    weatherInfo.textContent = "در حال دریافت اطلاعات...";
    try {
      const res = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=fa`
      );
      if (!res.ok) throw new Error("City not found");
      const data = await res.json();
      displayWeather(data);
    } catch {
      weatherInfo.textContent = "❌ شهر یافت نشد، لطفاً دوباره تلاش کنید.";
    }
  }

  function toggleTheme() {
    isDark = !isDark;
    if (isDark) document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }

  function getLocationAndFetchWeather() {
    if (!navigator.geolocation) {
      alert("موقعیت‌یاب در مرورگر شما فعال نیست.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      fetchWeatherByCoords(lat, lon);
    }, () => alert("خطا در دریافت موقعیت."));
  }

  async function fetchWeatherByCoords(lat, lon) {
    weatherInfo.textContent = "در حال دریافت اطلاعات...";
    try {
      const res = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=fa`
      );
      if (!res.ok) throw new Error("Location not found");
      const data = await res.json();
      displayWeather(data);
    } catch {
      weatherInfo.textContent = "❌ اطلاعات موقعیت یافت نشد.";
    }
  }

  // رویدادها
  searchBtn.addEventListener("click", () => {
    const city = cityInput.value.trim();
    if (city) fetchWeather(city);
  });

  geoBtn.addEventListener("click", () => {
    getLocationAndFetchWeather();
  });

  themeBtn.addEventListener("click", () => {
    toggleTheme();
  });

  // بارگذاری اولیه با روستای کاظمی دو
  cityInput.value = "Kazemi Do";
  fetchWeather("Kazemi Do");
</script>

</body>
</html>
