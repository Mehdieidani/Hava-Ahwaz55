<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>هواشناسی حرفه‌ای</title>
<link href="https://cdn.jsdelivr.net/npm/vazir-font@v1.1.2/dist/font-face.css" rel="stylesheet" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-oGZj6j7l75Qo6Sj01WZb2n08+36a3L8aV7Qw+iYXF0k="
  crossorigin=""
/>
<style>
  /* ... همان استایل‌هایی که شما گذاشتید ... */
</style>
</head>
<body>

<header>
  <h1 id="title">وضعیت آب‌وهوا</h1>
  <button id="langToggle" onclick="toggleLang()">AR</button>
</header>

<main>
  <section id="leftPanel">
    <div id="searchSection">
      <input id="cityInput" type="text" placeholder="نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)" />
      <button id="searchBtn" onclick="searchCity()">جستجو</button>
    </div>
    <div id="favorites"></div>

    <div id="currentWeather"></div>
  </section>

  <section id="forecastContainer">
    <div id="dailyForecast"></div>
    <div id="hourlyForecast"></div>
    <div id="map"></div>
  </section>
</main>

<footer>
  <div>تماس: <a href="tel:09332356547">09332356547</a></div>
  <div>اینستاگرام: <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a></div>
  <div>ایمیل: <a href="mailto:mehdi1eidani@gmail.com">mehdi1eidani@gmail.com</a></div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-oW7l7NhKX0iSXXEe4BfPvvCJS8+PpL3e2pA6cd9vXNk="
  crossorigin="">
</script>
<script>
  const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88"; 
  let currentLang = "fa";
  let currentUnits = "metric";
  let currentCity = null;
  let map, mapMarker;

  const labels = {
    fa: {
      title: "وضعیت آب‌وهوا",
      searchPlaceholder: "نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)",
      searchBtn: "جستجو",
      hourlyTitle: "پیش‌بینی ساعتی",
      temp: "دما",
      humidity: "رطوبت",
      pressure: "فشار هوا",
      windSpeed: "سرعت باد",
      windDir: "جهت باد",
      sunrise: "طلوع آفتاب",
      sunset: "غروب آفتاب",
      aqi: "کیفیت هوا",
      favoritesTitle: "شهرهای مورد علاقه",
      addFav: "افزودن به علاقه‌مندی‌ها",
      removeFav: "حذف از علاقه‌مندی‌ها",
      noFav: "شهر مورد علاقه وجود ندارد.",
      errorCity: "شهر مورد نظر پیدا نشد.",
      callText: "📞 تماس با 09332356547",
      instagram: "اینستاگرام",
      email: "ایمیل",
      visibility: "دید افقی",
      uvIndex: "شاخص UV",
      pop: "احتمال بارش",
      feelsLike: "احساس واقعی",
      dewPoint: "نقطه شبنم",
      clouds: "ابرها",
      description: "توضیحات",
    },
    ar: {
      title: "حالة الطقس",
      searchPlaceholder: "أدخل اسم المدينة أو القرية",
      searchBtn: "بحث",
      hourlyTitle: "توقعات كل ساعة",
      temp: "درجة الحرارة",
      humidity: "الرطوبة",
      pressure: "الضغط الجوي",
      windSpeed: "سرعة الرياح",
      windDir: "اتجاه الرياح",
      sunrise: "شروق الشمس",
      sunset: "غروب الشمس",
      aqi: "جودة الهواء",
      favoritesTitle: "المدن المفضلة",
      addFav: "أضف للمفضلات",
      removeFav: "حذف من المفضلات",
      noFav: "لا توجد مدن مفضلة.",
      errorCity: "لم يتم العثور على المدينة.",
      callText: "📞 اتصل بـ 09332356547",
      instagram: "انستغرام",
      email: "البريد الإلكتروني",
      visibility: "الرؤية الأفقية",
      uvIndex: "مؤشر الأشعة فوق البنفسجية",
      pop: "احتمال هطول الأمطار",
      feelsLike: "الحرارة المحسوسة",
      dewPoint: "نقطة الندى",
      clouds: "الغيوم",
      description: "الوصف",
    }
  };

  let favorites = JSON.parse(localStorage.getItem("favorites_weather")) || [];

  function toggleLang() {
    currentLang = currentLang === "fa" ? "ar" : "fa";
    document.getElementById("title").innerText = labels[currentLang].title;
    document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
    document.getElementById("searchBtn").innerText = labels[currentLang].searchBtn;
    renderFavorites();
    if(currentCity) searchCity();
  }

  function toggleFavorite(cityName) {
    if (favorites.includes(cityName)) {
      favorites = favorites.filter(c => c !== cityName);
    } else {
      favorites.push(cityName);
    }
    localStorage.setItem("favorites_weather", JSON.stringify(favorites));
    renderFavorites();
  }

  function renderFavorites() {
    const favDiv = document.getElementById("favorites");
    favDiv.innerHTML = "";
    if (favorites.length === 0) {
      favDiv.innerText = labels[currentLang].noFav;
      return;
    }
    favorites.forEach(city => {
      const btn = document.createElement("button");
      btn.textContent = city;
      btn.onclick = () => {
        document.getElementById("cityInput").value = city;
        searchCity();
      };
      favDiv.appendChild(btn);
    });
  }

  async function searchCity() {
    const city = document.getElementById("cityInput").value.trim();
    if (!city) return alert(labels[currentLang].errorCity);

    try {
      const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`);
      const geoData = await geoRes.json();
      if (!geoData.length) return alert(labels[currentLang].errorCity);

      const { lat, lon, name, country } = geoData[0];
      currentCity = { lat, lon, name, country };

      if (!map) initMap(lat, lon);
      else {
        map.setView([lat, lon], 10);
        if (mapMarker) map.removeLayer(mapMarker);
        mapMarker = L.marker([lat, lon]).addTo(map).bindPopup(`${name}, ${country}`).openPopup();
      }

      const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`);
      const weatherData = await weatherRes.json();

      const currentRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`);
      const currentData = await currentRes.json();

      const aqiRes = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`);
      const aqiData = await aqiRes.json();

      renderCurrentWeather(currentData, aqiData);
      renderForecast(weatherData);
    } catch (e) {
      alert("خطا در دریافت داده‌ها. لطفا دوباره تلاش کنید.");
      console.error(e);
    }
  }

  function degToDirection(deg) {
    const directionsFa = ["شمال", "شمال‌شرق", "شرق", "جنوب‌شرق", "جنوب", "جنوب‌غرب", "غرب", "شمال‌غرب"];
    const directionsAr = ["شمال", "شمال شرقي", "شرق", "جنوب شرقي", "جنوب", "جنوب غربي", "غرب", "شمال غربي"];
    const directions = currentLang === "fa" ? directionsFa : directionsAr;
    const index = Math.round(deg / 45) % 8;
    return directions[index];
  }

  function renderCurrentWeather(currentData, aqiData) {
    if (!currentData) return;
    const container = document.getElementById("currentWeather");
    container.innerHTML = "";

    const cityName = `${currentData.name}, ${currentData.sys.country}`;
    const iconUrl = `https://openweathermap.org/img/wn/${currentData.weather[0].icon}@4x.png`;
    const desc = currentData.weather[0].description;
    const temp = currentData.main.temp.toFixed(1);
    const humidity = currentData.main.humidity;
    const pressure = currentData.main.pressure;
    const windSpeed = currentData.wind.speed.toFixed(1);
    const windDeg = currentData.wind.deg;
    const visibility = currentData.visibility / 1000;
    const sunrise = new Date(currentData.sys.sunrise * 1000);
    const sunset = new Date(currentData.sys.sunset * 1000);
    const sunriseStr = sunrise.toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG", {hour: "2-digit", minute: "2-digit"});
    const sunsetStr = sunset.toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG", {hour: "2-digit", minute: "2-digit"});

    let aqiText = "";
    let aqiColor = "";
    if (aqiData && aqiData.list && aqiData.list.length) {
      const aqi = aqiData.list[0].main.aqi;
      switch (aqi) {
        case 1: aqiText = currentLang === "fa" ? "خوب" : "جيد"; aqiColor = "green"; break;
        case 2: aqiText = currentLang === "fa" ? "معمولی" : "متوسط"; aqiColor = "yellow"; break;
        case 3: aqiText = currentLang === "fa" ? "ناسالم برای گروه‌های حساس" : "غير صحي للمجموعات الحساسة"; aqiColor = "orange"; break;
        case 4: aqiText = currentLang === "fa" ? "ناسالم" : "غير صحي"; aqiColor = "red"; break;
        case 5: aqiText = currentLang === "fa" ? "بسیار ناسالم" : "سيء جدا"; aqiColor = "purple"; break;
      }
    }

    const feelsLike = currentData.main.feels_like.toFixed(1);
    const dewPoint = (currentData.main.temp - ((100 - humidity) / 5)).toFixed(1);
    const clouds = currentData.clouds.all;

    container.innerHTML = `
      <h2>${cityName}</h2>
      <img src="${iconUrl}" alt="${desc}" />
      <div class="temp">${temp} °C</div>
      <div class="desc">${desc}</div>
      <div class="details">
        <div><strong>${labels[currentLang].humidity}:</strong> ${humidity} %</div>
        <div><strong>${labels[currentLang].pressure}:</strong> ${pressure} hPa</div>
        <div><strong>${labels[currentLang].windSpeed}:</strong> ${windSpeed} m/s</div>
        <div><strong>${labels[currentLang].windDir}:</strong> ${degToDirection(windDeg)}</div>
        <div><strong>${labels[currentLang].visibility}:</strong> ${visibility} km</div>
        <div><strong>${labels[currentLang].sunrise}:</strong> ${sunriseStr}</div>
        <div><strong>${labels[currentLang].sunset}:</strong> ${sunsetStr}</div>
        <div><strong>${labels[currentLang].aqi}:</strong> <span style="color:${aqiColor};font-weight:bold;">${aqiText}</span></div>
        <div><strong>${labels[currentLang].feelsLike}:</strong> ${feelsLike} °C</div>
        <div><strong>${labels[currentLang].dewPoint}:</strong> ${dewPoint} °C</div>
        <div><strong>${labels[currentLang].clouds}:</strong> ${clouds} %</div>
      </div>
    `;
  }

  function renderForecast(data) {
    if (!data) return;
    const dailyDiv = document.getElementById("dailyForecast");
    const hourlyDiv = document.getElementById("hourlyForecast");
    dailyDiv.innerHTML = "";
    hourlyDiv.innerHTML = "";

    const days = {};
    data.list.forEach(item => {
      const date = item.dt_txt.split(" ")[0];
      if (!days[date]) days[date] = [];
      days[date].push(item);
    });

    const dayKeys = Object.keys(days).slice(0, 5);

    dayKeys.forEach((date, i) => {
      const dayItems = days[date];
      const avgTemp = (
        dayItems.reduce((acc, it) => acc + it.main.temp, 0) / dayItems.length
      ).toFixed(1);

      const icon = dayItems[0].weather[0].icon;
      const desc = dayItems[0].weather[0].description;

      const dayCard = document.createElement("div");
      dayCard.classList.add("day-card");
      if (i === 0) dayCard.classList.add("active");

      const dateObj = new Date(date);
      const optionsFa = { weekday: 'long', month: 'long', day: 'numeric' };
      const optionsAr = { weekday: 'long', month: 'long', day: 'numeric' };

      const dateStr = currentLang === "fa"
        ? dateObj.toLocaleDateString("fa-IR", optionsFa)
        : dateObj.toLocaleDateString("ar-EG", optionsAr);

      dayCard.innerHTML = `
        <h3>${dateStr}</h3>
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${desc}" />
        <div class="temp">${avgTemp} °C</div>
        <div style="text-align:center;">${desc}</div>
      `;

      dayCard.onclick = () => {
        document.querySelectorAll(".day-card").forEach(el => el.classList.remove("active"));
        dayCard.classList.add("active");
        renderHourly(dayItems);
      };

      dailyDiv.appendChild(dayCard);
    });

    renderHourly(days[dayKeys[0]]);
  }

  function renderHourly(hourItems) {
    const hourlyDiv = document.getElementById("hourlyForecast");
    hourlyDiv.innerHTML = `<h3>${labels[currentLang].hourlyTitle}</h3>`;

    hourItems.forEach(item => {
      const time = item.dt_txt.split(" ")[1].slice(0, 5);
      const icon = item.weather[0].icon;
      const desc = item.weather[0].description;
      const temp = item.main.temp.toFixed(1);
      const humidity = item.main.humidity;
      const pressure = item.main.pressure;
      const windSpeed = item.wind.speed.toFixed(1);
      const windDeg = item.wind.deg;
      const pop = item.pop ? (item.pop * 100).toFixed(0) : "0";
      const clouds = item.clouds.all;
      const feelsLike = item.main.feels_like.toFixed(1);
      const dewPoint = (item.main.temp - ((100 - humidity) / 5)).toFixed(1);

      hourlyDiv.innerHTML += `
        <div class="hour-card">
          <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${desc}" />
          <div class="hour-info">
            <div><strong>${time}</strong></div>
            <div>${desc}</div>
            <div>${labels[currentLang].temp}: ${temp} °C ( ${labels[currentLang].feelsLike}: ${feelsLike} °C )</div>
            <div>${labels[currentLang].humidity}: ${humidity}%</div>
            <div>${labels[currentLang].pressure}: ${pressure} hPa</div>
            <div>${labels[currentLang].windSpeed}: ${windSpeed}
