<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>هواشناسی پیشرفته با ثبت نام و چت خصوصی</title>
<style>
  /* تنظیمات پایه */
  body {
    font-family: 'Tahoma', sans-serif;
    margin: 0; padding: 0;
    background: #0077b6;
    color: #fff;
    direction: rtl;
    transition: background 0.3s, color 0.3s;
  }
  header {
    background: linear-gradient(to left, #023e8a, #0096c7);
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    position: relative;
  }
  button {
    cursor: pointer;
  }
  /* دکمه زبان و تنظیمات */
  #language-toggle, #settings-btn {
    position: absolute;
    top: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    font-weight: bold;
  }
  #language-toggle { left: 1rem; }
  #settings-btn { left: 5.5rem; }

  /* کانتینر صفحه */
  #container {
    max-width: 900px;
    margin: 1rem auto;
    padding: 0 1rem;
  }

  /* فرم ثبت نام / ورود */
  #auth-section {
    background: #023047;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  #auth-section h2 {
    margin-top: 0;
  }
  #auth-section input, #auth-section select {
    width: 100%;
    padding: 0.5rem;
    margin: 0.3rem 0 1rem 0;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
  }
  #auth-section label {
    display: block;
    margin-bottom: 0.3rem;
  }
  #auth-section .error {
    color: #f44336;
    margin-bottom: 1rem;
  }
  #auth-section button {
    background: #ffb703;
    border: none;
    color: #023047;
    font-weight: bold;
    padding: 0.7rem;
    border-radius: 5px;
    width: 100%;
  }
  #auth-toggle {
    margin-top: 0.5rem;
    text-align: center;
    color: #ffb703;
    cursor: pointer;
    user-select: none;
  }

  /* چت خصوصی */
  #chat-section {
    background: #023047;
    border-radius: 10px;
    padding: 1rem;
    display: none;
    flex-direction: column;
    height: 400px;
  }
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    background: #011f4b;
    border-radius: 5px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .message {
    margin-bottom: 0.5rem;
    padding: 0.5rem 0.7rem;
    border-radius: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .message.user {
    background: #ffb703;
    color: #023047;
    align-self: flex-start;
  }
  .message.admin {
    background: #90e0ef;
    color: #023047;
    align-self: flex-end;
  }
  #chat-input {
    display: flex;
  }
  #chat-input textarea {
    flex-grow: 1;
    resize: none;
    padding: 0.5rem;
    border-radius: 5px 0 0 5px;
    border: none;
    font-size: 1rem;
  }
  #chat-input button {
    background: #ffb703;
    border: none;
    color: #023047;
    padding: 0 1rem;
    font-weight: bold;
    border-radius: 0 5px 5px 0;
  }

  /* بخش تنظیمات */
  #settings-modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #023047;
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 0 10px #0008;
    display: none;
    z-index: 1000;
    width: 320px;
  }
  #settings-modal h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
  }
  #settings-modal label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
  }
  #settings-modal select, #settings-modal input[type=range] {
    width: 100%;
    padding: 0.3rem;
    border-radius: 5px;
    border: none;
  }
  #settings-modal button.close-settings {
    margin-top: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.5rem;
    width: 100%;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
  }

  /* تم تاریک */
  body.dark {
    background: #011627;
    color: #eee;
  }
  body.dark header {
    background: linear-gradient(to left, #001f3f, #004080);
  }
  body.dark #auth-section,
  body.dark #chat-section,
  body.dark #settings-modal {
    background: #001f3f;
    color: #eee;
  }
  body.dark #chat-messages {
    background: #001733;
  }

  /* فونت‌ها */
  body.font-tahoma { font-family: 'Tahoma', sans-serif; }
  body.font-vazir { font-family: 'Vazir', sans-serif; }
  body.font-irsans { font-family: 'IRANSans', sans-serif; }
  body.font-sahel { font-family: 'Sahel', sans-serif; }

</style>

<!-- فونت‌های وب -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/iransans-web@3.1.1/dist/css/iransans.css" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v2.0.1/dist/font-face.css" rel="stylesheet" type="text/css" />

</head>
<body class="font-tahoma">

<header>
  هواشناسی پیشرفته
  <button id="language-toggle">AR</button>
  <button id="settings-btn" title="تنظیمات">⚙️</button>
</header>

<div id="container">

  <!-- فرم ثبت نام و ورود -->
  <section id="auth-section">
    <h2 id="auth-title">ثبت نام</h2>
    <div class="error" id="auth-error"></div>
    <form id="auth-form">
      <label for="phone">شماره موبایل:</label>
      <input type="tel" id="phone" name="phone" placeholder="مثال: 09123456789" required pattern="09[0-9]{9}" />
      
      <label for="password">رمز عبور:</label>
      <input type="password" id="password" name="password" required minlength="6" />

      <label for="password-repeat" id="label-repeat">تکرار رمز عبور:</label>
      <input type="password" id="password-repeat" name="password-repeat" required minlength="6" />

      <label for="recovery-question">سوال بازیابی رمز (مثلا اولین مدرسه شما؟):</label>
      <input type="text" id="recovery-question" name="recovery-question" required />

      <button type="submit" id="auth-submit">ثبت نام</button>
    </form>
    <div id="auth-toggle">حالا وارد شوید</div>
  </section>

  <!-- بخش هواشناسی (همیشه نمایش داده می‌شود) -->
  <section id="weather-section">
    <div id="weather-app">
      <!-- اینجا کد هواشناسی شما قرار می‌گیرد -->
      <p>اینجا پیش‌بینی هواشناسی قرار می‌گیرد...</p>
    </div>
  </section>

  <!-- بخش چت خصوصی (فقط بعد از ورود فعال می‌شود) -->
  <section id="chat-section">
    <div id="chat-messages"></div>
    <div id="chat-input">
      <textarea id="chat-text" rows="2" placeholder="پیام خود را بنویسید..."></textarea>
      <button id="chat-send">ارسال</button>
    </div>
  </section>

</div>

<!-- پنجره تنظیمات -->
<div id="settings-modal">
  <h3>تنظیمات</h3>
  <label for="theme-select">تم:</label>
  <select id="theme-select">
    <option value="light">روشن</option>
    <option value="dark">تاریک</option>
  </select>

  <label for="font-select">فونت:</label>
  <select id="font-select">
    <option value="font-tahoma">Tahoma</option>
    <option value="font-vazir">Vazir</option>
    <option value="font-irsans">IRANSans</option>
    <option value="font-sahel">Sahel</option>
  </select>

  <label for="font-size-range">اندازه فونت:</label>
  <input type="range" id="font-size-range" min="12" max="28" value="16" />

  <button class="close-settings">بستن</button>
</div>

<script>
  // --- تنظیمات پایه ---

  const authSection = document.getElementById('auth-section');
  const weatherSection = document.getElementById('weather-section');
  const chatSection = document.getElementById('chat-section');
  const chatMessages = document.getElementById('chat-messages');
  const chatText = document.getElementById('chat-text');
  const chatSendBtn = document.getElementById('chat-send');
  const authForm = document.getElementById('auth-form');
  const authError = document.getElementById('auth-error');
  const authTitle = document.getElementById('auth-title');
  const authToggle = document.getElementById('auth-toggle');
  const passwordRepeatLabel = document.getElementById('label-repeat');
  const passwordRepeatInput = document.getElementById('password-repeat');

  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const themeSelect = document.getElementById('theme-select');
  const fontSelect = document.getElementById('font-select');
  const fontSizeRange = document.getElementById('font-size-range');
  const closeSettingsBtn = document.querySelector('.close-settings');

  let isRegisterMode = true;
  let currentUser = null;

  // --- کار با LocalStorage برای کاربران ---
  function getUsers() {
    return JSON.parse(localStorage.getItem('users') || '{}');
  }
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  // --- ثبت نام ---
  function registerUser(phone, password, recoveryQuestion) {
    const users = getUsers();
    if(users[phone]) {
      return { success: false, message: 'این شماره قبلاً ثبت شده است.' };
    }
    users[phone] = {
      password,
      recoveryQuestion,
      messages: []
    };
    saveUsers(users);
    return { success: true };
  }

  // --- ورود ---
  function loginUser(phone, password) {
    const users = getUsers();
    if(!users[phone]) {
      return { success: false, message: 'این شماره ثبت نشده است.' };
    }
    if(users[phone].password !== password) {
      return { success: false, message: 'رمز عبور اشتباه است.' };
    }
    return { success: true, user: users[phone] };
  }

  // --- ارسال پیام (ذخیره پیام‌ها در LocalStorage برای هر کاربر) ---
  function saveMessage(phone, message, sender) {
    const users = getUsers();
    if(!users[phone]) return;
    users[phone].messages.push({ sender, text: message, time: new Date().toISOString() });
    saveUsers(users);
  }

  // --- بارگذاری پیام‌ها ---
  function loadMessages(phone) {
    const users = getUsers();
    if(!users[phone]) return [];
    return users[phone].messages || [];
  }

  // --- نمایش پیام‌ها ---
  function renderMessages(messages) {
    chatMessages.innerHTML = "";
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender === 'user' ? 'user' : 'admin');
      const time = new Date(msg.time).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
      div.textContent = `[${time}] ${msg.text}`;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // --- سوئیچ ثبت نام/ورود ---
  authToggle.addEventListener('click', () => {
    isRegisterMode = !isRegisterMode;
    authError.textContent = '';
    if(isRegisterMode) {
      authTitle.textContent = 'ثبت نام';
      authSubmit.textContent = 'ثبت نام';
      passwordRepeatLabel.style.display = 'block';
      passwordRepeatInput.style.display = 'block';
      authToggle.textContent = 'حالا وارد شوید';
    } else {
      authTitle.textContent = 'ورود';
      authSubmit.textContent = 'ورود';
      passwordRepeatLabel.style.display = 'none';
      passwordRepeatInput.style.display = 'none';
      authToggle.textContent = 'ثبت نام کنید';
    }
  });

  // --- ارسال فرم ثبت نام / ورود ---
  const authSubmit = document.getElementById('auth-submit');
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    authError.textContent = '';

    const phone = authForm.phone.value.trim();
    const password = authForm.password.value.trim();
    const passwordRepeat = authForm['password-repeat'].value.trim();
    const recoveryQuestion = authForm['recovery-question'].value.trim();

    if(isRegisterMode){
      if(password !== passwordRepeat){
        authError.textContent = 'رمز عبور و تکرار آن مطابقت ندارند.';
        return;
      }
      if(password.length < 6){
        authError.textContent = 'رمز عبور باید حداقل 6 کاراکتر باشد.';
        return;
      }
      const res = registerUser(phone, password, recoveryQuestion);
      if(!res.success){
        authError.textContent = res.message;
        return;
      }
      alert('ثبت نام با موفقیت انجام شد. حالا وارد شوید.');
      isRegisterMode = false;
      authToggle.click();
      authForm.reset();
    } else {
      const res = loginUser(phone, password);
      if(!res.success){
        authError.textContent = res.message;
        return;
      }
      currentUser = phone;
      authSection.style.display = 'none';
      chatSection.style.display = 'flex';
      loadAndRenderMessages();
      applySettingsFromStorage();
    }
  });

  // --- بارگذاری و نمایش پیام‌ها ---
  function loadAndRenderMessages(){
    if(!currentUser) return;
    const messages = loadMessages(currentUser);
    renderMessages(messages);
  }

  // --- ارسال پیام در چت ---
  chatSendBtn.addEventListener('click', () => {
    const text = chatText.value.trim();
    if(text === '') return;
    // ذخیره پیام کاربر
    saveMessage(currentUser, text, 'user');
    renderMessages(loadMessages(currentUser));
    chatText.value = '';

    // شبیه‌سازی پاسخ شما (ادمین)
    setTimeout(() => {
      const adminReply = "پیام شما دریافت شد. در اسرع وقت پاسخ می‌دهیم.";
      saveMessage(currentUser, adminReply, 'admin');
      renderMessages(loadMessages(currentUser));
    }, 1000);
  });

  // ارسال با اینتر در textarea چت
  chatText.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      chatSendBtn.click();
    }
  });

  // --- تنظیمات ---

  // باز/بسته کردن مودال تنظیمات
  settingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'block';
  });
  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'none';
  });

  // تغییر تم
  themeSelect.addEventListener('change', () => {
    if(themeSelect.value === 'dark'){
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
    localStorage.setItem('theme', themeSelect.value);
  });

  // تغییر فونت
  fontSelect.addEventListener('change', () => {
    document.body.classList.remove('font-tahoma','font-vazir','font-irsans','font-sahel');
    document.body.classList.add(fontSelect.value);
    localStorage.setItem('font', fontSelect.value);
  });

  // تغییر اندازه فونت
  fontSizeRange.addEventListener('input', () => {
    document.body.style.fontSize = fontSizeRange.value + 'px';
    localStorage.setItem('fontSize', fontSizeRange.value);
  });

  // بارگذاری تنظیمات ذخیره شده
  function applySettingsFromStorage(){
    const theme = localStorage.getItem('theme') || 'light';
    themeSelect.value = theme;
    if(theme === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');

    const font = localStorage.getItem('font') || 'font-tahoma';
    fontSelect.value = font;
    document.body.classList.remove('font-tahoma','font-vazir','font-irsans','font-sahel');
    document.body.classList.add(font);

    const fontSize = localStorage.getItem('fontSize') || '16';
    fontSizeRange.value = fontSize;
    document.body.style.fontSize = fontSize + 'px';
  }

  // بارگذاری تنظیمات هنگام لود صفحه
  window.addEventListener('load', () => {
    applySettingsFromStorage();
  });

  // دکمه تغییر زبان (فارسی/عربی) - فقط نمایشی
  const languageToggle = document.getElementById('language-toggle');
  languageToggle.addEventListener('click', () => {
    if(languageToggle.textContent === 'AR'){
      languageToggle.textContent = 'FA';
      alert('زبان به عربی تغییر کرد (نمایشی)');
      // اینجا می‌توانید ترجمه‌ها یا تغییرات زبان را اضافه کنید
    } else {
      languageToggle.textContent = 'AR';
      alert('زبان به فارسی تغییر کرد (نمایشی)');
    }
  });

</script>

</body>
</html>
