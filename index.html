<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>هواشناسی کاظمی دو - پیشرفته</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Reset */
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e6f0ff; color: #222;
      direction: rtl; text-align: right;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background: #121212;
      color: #ddd;
    }
    header {
      background: #005bbb; color: white; padding: 20px; text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .container {
      max-width: 900px; margin: auto; padding: 15px;
    }
    .box {
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: background 0.3s, color 0.3s;
    }
    .dark .box {
      background: #222;
      color: #ddd;
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    label {
      display: block; margin-bottom: 8px; font-weight: bold; font-size: 1.1rem;
    }
    input[type="text"], select {
      width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px;
      border: 1px solid #ccc; transition: border-color 0.3s;
    }
    input[type="text"]:focus, select:focus {
      border-color: #005bbb; outline: none;
    }
    button {
      margin-top: 10px; padding: 12px 25px;
      background-color: #005bbb; color: white; font-weight: bold;
      border: none; border-radius: 8px;
      cursor: pointer; font-size: 1.1rem;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #003f8a;
    }
    .rtl {
      direction: rtl; text-align: right;
    }
    .wind-dir {
      display: inline-block; transition: transform 0.4s ease;
      font-size: 1.3rem;
    }
    .icon {
      vertical-align: middle; width: 48px; height: 48px;
    }
    .forecast-list {
      list-style: none; padding: 0; margin: 0;
      max-height: 300px; overflow-y: auto;
      border-top: 1px solid #ddd;
    }
    .forecast-list li {
      padding: 12px 0; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.9rem;
    }
    .forecast-list li:last-child {
      border-bottom: none;
    }
    .chart-container {
      position: relative; height: 300px; width: 100%;
    }
    #map {
      width: 100%; height: 250px; border-radius: 12px; margin-top: 20px;
    }
    .moon-phase {
      font-size: 1.3rem; margin-top: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    .moon-phase span {
      font-size: 2rem;
    }
    /* Scrollbar for forecast list */
    .forecast-list::-webkit-scrollbar {
      width: 8px;
    }
    .forecast-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 8px;
    }
    .forecast-list::-webkit-scrollbar-thumb {
      background: #005bbb;
      border-radius: 8px;
    }
    /* Dark scrollbar */
    .dark .forecast-list::-webkit-scrollbar-track {
      background: #222;
    }
    .dark .forecast-list::-webkit-scrollbar-thumb {
      background: #3399ff;
    }
    /* Print styles */
    @media print {
      button, #themeToggle, #langSelect, #cityInput { display: none !important; }
      body { background: white; color: black; }
      .box { box-shadow: none; border: none; }
    }
    /* Responsive */
    @media(max-width:600px) {
      button { width: 100%; }
      .forecast-list li { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body class="rtl">

<header>
  <h1 id="title">هواشناسی کاظمی دو - پیشرفته</h1>
  <p id="subtitle">پیش‌بینی دقیق آب‌وهوا با امکانات کامل</p>
</header>

<div class="container">

  <div class="box">
    <label for="langSelect">زبان / اللغة:</label>
    <select id="langSelect" aria-label="انتخاب زبان">
      <option value="fa" selected>فارسی</option>
      <option value="ar">العربية</option>
    </select>
  </div>

  <div class="box">
    <label for="cityInput" id="cityLabel">نام شهر یا روستا:</label>
    <input type="text" id="cityInput" placeholder="مثلاً کاظمی دو یا Ahvaz or بغداد" aria-describedby="cityLabel" />
    <button id="fetchBtn">جستجو</button>
    <button id="geoBtn" title="یافتن موقعیت فعلی">📍 موقعیت من</button>
    <button id="themeToggle" title="تغییر تم">🌗 تم تاریک/روشن</button>
  </div>

  <div class="box" id="weatherInfo" aria-live="polite" aria-atomic="true">
    لطفاً یک شهر یا روستا وارد کنید و روی جستجو کلیک کنید.
  </div>

  <div class="box">
    <h3 id="forecastTitle">پیش‌بینی ۵ روزه</h3>
    <ul class="forecast-list" id="forecastList" role="list"></ul>
  </div>

  <div class="box chart-container">
    <canvas id="windChart" aria-label="نمودار سرعت باد" role="img"></canvas>
  </div>

  <div class="box moon-phase" id="moonPhase"></div>

  <div class="box" id="map" aria-label="نقشه موقعیت"></div>

  <div class="box">
    <button id="printBtn">چاپ گزارش</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6RpvmC9f9fEclXrbt2tyb13VGdZ8ktyTx8a+vY="
  crossorigin=""></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+Bk9saU4AyPXnfuUHXQxp3O4WmwXvXbDq2tjGq6Lk="
  crossorigin=""/>

<script>
  "use strict";

  // متن‌ها برای دو زبان
  const texts = {
    fa: {
      title: "هواشناسی کاظمی دو - پیشرفته",
      subtitle: "پیش‌بینی دقیق آب‌وهوا با امکانات کامل",
      langLabel: "زبان / اللغة:",
      cityLabel: "نام شهر یا روستا:",
      cityPlaceholder: "مثلاً کاظمی دو یا Ahvaz or بغداد",
      search: "جستجو",
      locateMe: "📍 موقعیت من",
      toggleTheme: "🌗 تم تاریک/روشن",
      forecastTitle: "پیش‌بینی ۵ روزه",
      windSpeed: "سرعت باد",
      windDirection: "جهت باد",
      temperature: "دما",
      humidity: "رطوبت",
      pressure: "فشار",
      visibility: "دید افقی",
      clouds: "ابرها",
      sunrise: "طلوع خورشید",
      sunset: "غروب خورشید",
      moonPhase: "وضعیت ماه",
      printReport: "چاپ گزارش",
      errorCity: "❌ شهر پیدا نشد. لطفاً نام را بررسی کنید.",
      loading: "در حال دریافت اطلاعات...",
    },
    ar: {
      title: "الأرصاد الجوية - كاظمي دو",
      subtitle: "توقعات دقيقة مع جميع الميزات",
      langLabel: "اللغة / زبان:",
      cityLabel: "اسم المدينة أو القرية:",
      cityPlaceholder: "مثلاً كاظمي دو أو Ahvaz أو بغداد",
      search: "بحث",
      locateMe: "📍 موقعي",
      toggleTheme: "🌗 الوضع الداكن / الفاتح",
      forecastTitle: "توقعات ٥ أيام",
      windSpeed: "سرعة الرياح",
      windDirection: "اتجاه الرياح",
      temperature: "درجة الحرارة",
      humidity: "الرطوبة",
      pressure: "الضغط",
      visibility: "الرؤية",
      clouds: "السحب",
      sunrise: "شروق الشمس",
      sunset: "غروب الشمس",
      moonPhase: "طور القمر",
      printReport: "طباعة التقرير",
      errorCity: "❌ لم يتم العثور على المدينة. يرجى التحقق من الاسم.",
      loading: "جارٍ جلب البيانات...",
    }
  };

  // حالت تم (روشن/تاریک)
  const body = document.body;

  // المان‌ها
  const langSelect = document.getElementById("langSelect");
  const cityInput = document.getElementById("cityInput");
  const fetchBtn = document.getElementById("fetchBtn");
  const weatherInfo = document.getElementById("weatherInfo");
  const forecastList = document.getElementById("forecastList");
  const windChartCtx = document.getElementById("windChart").getContext("2d");
  const moonPhaseBox = document.getElementById("moonPhase");
  const mapDiv = document.getElementById("map");
  const geoBtn = document.getElementById("geoBtn");
  const themeToggleBtn = document.getElementById("themeToggle");
  const cityLabel = document.getElementById("cityLabel");
  const titleH1 = document.getElementById("title");
  const subtitleP = document.getElementById("subtitle");
  const printBtn = document.getElementById("printBtn");

  let currentLang = "fa";
  let currentChart = null;
  let currentCity = "Kazemi Do";
  let currentCoords = { lat: 31.2215, lon: 48.6037 }; // مختصات پیش‌فرض کاظمی دو

  // کلید API
  const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";

  // نقشه Leaflet
  let map = L.map(mapDiv).setView([currentCoords.lat, currentCoords.lon], 10);
  let marker = L.marker([currentCoords.lat, currentCoords.lon]).addTo(map);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // تغییر زبان رابط
  function updateLanguage() {
    currentLang = langSelect.value;
    titleH1.textContent = texts[currentLang].title;
    subtitleP.textContent = texts[currentLang].subtitle;
    cityLabel.textContent = texts[currentLang].cityLabel;
    cityInput.placeholder = texts[currentLang].cityPlaceholder;
    fetchBtn.textContent = texts[currentLang].search;
    geoBtn.textContent = texts[currentLang].locateMe;
    themeToggleBtn.textContent = texts[currentLang].toggleTheme;
    document.getElementById("forecastTitle").textContent = texts[currentLang].forecastTitle;
    printBtn.textContent = texts[currentLang].printReport;
    weatherInfo.textContent = texts[currentLang].loading;
  }

  // محاسبه وضعیت ماه (moon phase) از تاریخ یونیکس
  function getMoonPhase(date) {
    // https://www.subsystems.us/uploads/9/8/9/4/98948044/moonphase.pdf
    const lp = 2551443; // طول دوره ماه به ثانیه
    let now = date.getTime();
    let new_moon = new Date(1970, 0, 7, 20, 35, 0).getTime(); // تاریخ نزدیک به ماه نو
    let phase = ((now - new_moon) / 1000) % lp;
    let phaseIndex = Math.floor((phase / lp) * 8);
    const phases = ["🌑", "🌒", "🌓", "🌔", "🌕", "🌖", "🌗", "🌘"];
    const namesFa = ["ماه نو", "هلال اول", "ربع اول", "ماه نیمه", "ماه کامل", "ربع آخر", "هلال آخر", "ماه رو به پایان"];
    const namesAr = ["القمر الجديد", "الهلال الأول", "الربع الأول", "المنتصف", "القمر الكامل", "الربع الأخير", "الهلال الأخير", "القمر المتناقص"];
    return {
      icon: phases[phaseIndex],
      name: currentLang === "fa" ? namesFa[phaseIndex] : namesAr[phaseIndex]
    };
  }

  // رسم نمودار سرعت باد
  function drawWindChart(labels, speeds) {
    if (currentChart) currentChart.destroy();
    currentChart = new Chart(windChartCtx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: texts[currentLang].windSpeed + " (m/s)",
          data: speeds,
          fill: true,
          borderColor: "#0077cc",
          backgroundColor: "rgba(0, 119, 204, 0.2)",
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: texts[currentLang].windSpeed + " (m/s)" }
          },
          x: {
            ticks: { maxRotation: 90, minRotation: 45 }
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });
  }

  // نمایش داده‌های هواشناسی
  function displayWeather(data) {
    const city = data.city;
    const list = data.list;

    currentCoords.lat = city.coord.lat;
    currentCoords.lon = city.coord.lon;

    // به‌روزرسانی نقشه
    map.setView([currentCoords.lat, currentCoords.lon], 10);
    marker.setLatLng([currentCoords.lat, currentCoords.lon]).bindPopup(city.name).openPopup();

    // نمایش اطلاعات آب و هوا برای اولین بازه زمانی (اکنون)
    const now = list[0];
    const dNow = new Date(now.dt * 1000);

    const moon = getMoonPhase(dNow);

    // اطلاعات اصلی
    let html = `
      <h2>${city.name}, ${city.country}</h2>
      <p>📍 ${currentCoords.lat.toFixed(4)}, ${currentCoords.lon.toFixed(4)}</p>
      <p>🌡️ ${texts[currentLang].temperature}: ${now.main.temp} °C</p>
      <p>💧 ${texts[currentLang].humidity}: ${now.main.humidity} %</p>
      <p>🌬️ ${texts[currentLang].windSpeed}: ${now.wind.speed} m/s 
         <span class="wind-dir" style="transform: rotate(${now.wind.deg}deg)">🧭</span>
      </p>
      <p>🔆 ${texts[currentLang].pressure}: ${now.main.pressure} hPa</p>
      <p>🌫️ ${texts[currentLang].visibility}: ${(now.visibility / 1000).toFixed(1)} km</p>
      <p>☁️ ${texts[currentLang].clouds}: ${now.clouds.all} %</p>
      <p>🌅 ${texts[currentLang].sunrise}: ${new Date(city.sunrise * 1000).toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG")}</p>
      <p>🌇 ${texts[currentLang].sunset}: ${new Date(city.sunset * 1000).toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG")}</p>
      <div class="moon-phase">${texts[currentLang].moonPhase}: <span>${moon.icon}</span> ${moon.name}</div>
      <p>⚙️ ${now.weather[0].description} <img class="icon" src="https://openweathermap.org/img/wn/${now.weather[0].icon}@2x.png" alt="icon"/></p>
    `;

    weatherInfo.innerHTML = html;

    // لیست پیش‌بینی 5 روزه ساعتی
    forecastList.innerHTML = "";
    let labels = [], speeds = [];

    list.forEach(item => {
      const dt = new Date(item.dt * 1000);
      const timeStr = dt.toLocaleString(currentLang === "fa" ? "fa-IR" : "ar-EG", {
        weekday: "short", hour: "2-digit", minute: "2-digit"
      });

      labels.push(timeStr);
      speeds.push(item.wind.speed);

      const li = document.createElement("li");
      li.innerHTML = `
        <div><strong>${timeStr}</strong></div>
        <div>${texts[currentLang].temperature}: ${item.main.temp}°C</div>
        <div>${texts[currentLang].windSpeed}: ${item.wind.speed} m/s
          <span class="wind-dir" style="transform: rotate(${item.wind.deg}deg)">🧭</span>
        </div>
      `;
      forecastList.appendChild(li);
    });

    drawWindChart(labels, speeds);
  }

  // واکشی داده‌ها
  async function fetchWeatherData(cityName) {
    weatherInfo.textContent = texts[currentLang].loading;
    forecastList.innerHTML = "";
    try {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(cityName)}&appid=${apiKey}&units=metric&lang=${currentLang}`
      );
      if (!response.ok) throw new Error("city not found");
      const data = await response.json();
      displayWeather(data);
    } catch (error) {
      weatherInfo.textContent = texts[currentLang].errorCity;
      forecastList.innerHTML = "";
    }
  }

  // استفاده از موقعیت جغرافیایی
  function getGeolocation() {
    if (!navigator.geolocation) {
      alert(currentLang === "fa" ? "موقعیت‌یاب پشتیبانی نمی‌شود." : "الموقع الجغرافي غير مدعوم.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetchWeatherByCoords(lat, lon);
      },
      () => {
        alert(currentLang === "fa" ? "خطا در دریافت موقعیت." : "خطأ في الحصول على الموقع.");
      }
    );
  }

  async function fetchWeatherByCoords(lat, lon) {
    weatherInfo.textContent = texts[currentLang].loading;
    forecastList.innerHTML = "";
    try {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${currentLang}`
      );
      if (!response.ok) throw new Error("location not found");
      const data = await response.json();
      displayWeather(data);
    } catch (error) {
      weatherInfo.textContent = texts[currentLang].errorCity;
      forecastList.innerHTML = "";
    }
  }

  // ذخیره زبان و شهر در localStorage
  function saveSettings() {
    localStorage.setItem("weatherLang", currentLang);
    localStorage.setItem("weatherCity", cityInput.value || currentCity);
  }

  function loadSettings() {
    const lang = localStorage.getItem("weatherLang");
    const city = localStorage.getItem("weatherCity");
    if (lang && (lang === "fa" || lang === "ar")) {
      langSelect.value = lang;
      currentLang = lang;
    }
    if (city) {
      cityInput.value = city;
      currentCity = city;
    }
  }

  // تغییر تم
  function toggleTheme() {
    body.classList.toggle("dark");
  }

  // رویدادها
  langSelect.addEventListener("change", () => {
    updateLanguage();
    saveSettings();
    fetchWeatherData(cityInput.value || currentCity);
  });
  fetchBtn.addEventListener("click", () => {
    currentCity = cityInput.value || currentCity;
    fetchWeatherData(currentCity);
    saveSettings();
  });
  geoBtn.addEventListener("click", getGeolocation);
  themeToggleBtn.addEventListener("click", () => {
    toggleTheme();
    saveSettings();
  });
  printBtn.addEventListener("click", () => window.print());

  // بارگذاری اولیه
  loadSettings();
  updateLanguage();
  fetchWeatherData(currentCity);

</script>

</body>
</html>
