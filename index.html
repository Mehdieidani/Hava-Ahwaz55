<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>پیش‌بینی هواشناسی - تم تاریک</title>
<link href="https://cdn.jsdelivr.net/npm/vazir-font@v1.1.2/dist/font-face.css" rel="stylesheet" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  /* تم تاریک */
  body {
    font-family: Vazir, sans-serif;
    margin: 0; padding: 0;
    background: #121212;
    color: #eee;
    direction: rtl;
  }
  header {
    background: #1f1f1f;
    color: #66b2ff;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 0 15px #0d47a1;
  }
  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }
  #langToggle {
    background: #66b2ff;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    color: #121212;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 0 8px #66b2ffaa;
    transition: background 0.3s;
  }
  #langToggle:hover {
    background: #4a90e2;
  }

  #searchSection {
    margin: 15px 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  #cityInput {
    width: 260px;
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1.5px solid #66b2ff;
    outline: none;
    background: #222;
    color: #eee;
  }
  #cityInput::placeholder {
    color: #aaa;
  }
  #searchBtn {
    background: #66b2ff;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    color: #121212;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 0 8px #66b2ffaa;
    transition: background 0.3s;
  }
  #searchBtn:hover {
    background: #4a90e2;
  }
  #cityName {
    margin: 12px auto;
    text-align: center;
    font-size: 1.4rem;
    font-weight: bold;
    color: #88c0ff;
  }
  #mapFrame {
    display: block;
    margin: 10px auto 20px;
    border-radius: 12px;
    border: none;
    width: 90vw;
    max-width: 600px;
    height: 280px;
    box-shadow: 0 0 15px #2196f3aa;
  }

  /* پیش‌بینی ۵ روزه */
  #dailyForecast {
    display: flex;
    justify-content: center;
    gap: 18px;
    flex-wrap: wrap;
    padding: 15px 10px;
  }
  .day-card {
    background: #222;
    border-radius: 16px;
    box-shadow: 0 0 10px #0d47a1aa;
    width: 130px;
    padding: 14px 12px 20px;
    text-align: center;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
    user-select: none;
  }
  .day-card:hover, .day-card.active {
    transform: scale(1.05);
    box-shadow: 0 0 25px #66b2ffcc;
  }
  .day-card h3 {
    margin: 6px 0 10px;
    font-weight: 700;
  }
  .day-icon {
    width: 64px;
    height: 64px;
  }
  .temp-day, .temp-night {
    margin: 6px 0;
    font-weight: 600;
  }

  /* پیش‌بینی ساعتی */
  #hourlyForecast {
    margin: 20px auto;
    max-width: 95vw;
    overflow-x: auto;
    padding-bottom: 10px;
    border-top: 1px solid #444;
    padding-top: 15px;
    display: none;
  }
  #hourlyForecast .hour-card {
    display: inline-block;
    background: #222;
    border-radius: 14px;
    padding: 10px 14px;
    margin: 0 8px;
    width: 120px;
    box-shadow: 0 0 12px #66b2ffaa;
    text-align: center;
    font-size: 0.95rem;
  }
  .hour-time {
    font-weight: 700;
    margin-bottom: 8px;
    color: #a0c4ff;
  }
  .hour-icon {
    width: 44px;
    height: 44px;
  }
  .hour-temp {
    margin: 6px 0;
    font-weight: 600;
  }
  .hour-desc {
    font-size: 0.85rem;
    color: #ccc;
  }
  .hour-wind, .hour-humidity {
    font-size: 0.8rem;
    color: #bbb;
    margin-top: 4px;
  }

  /* نمودار دما و باد */
  #plots {
    margin: 35px auto 50px;
    max-width: 700px;
  }

  /* تبلیغات تماس */
  .ad-box {
    position: fixed;
    bottom: 15px;
    left: 15px;
    background: #333;
    border: 2px solid #66b2ff;
    border-radius: 14px;
    padding: 10px 18px;
    font-weight: bold;
    color: #66b2ff;
    box-shadow: 0 0 20px #66b2ffaa;
    cursor: pointer;
    user-select: none;
    z-index: 1000;
  }
  .ad-box a {
    color: #66b2ff;
    text-decoration: none;
  }

  @media (max-width: 480px) {
    #dailyForecast {
      justify-content: center;
    }
    #hourlyForecast .hour-card {
      width: 90px;
      margin: 0 6px;
      padding: 8px 10px;
      font-size: 0.8rem;
    }
    #plots {
      width: 95vw;
    }
  }
</style>
</head>
<body>

<header>
  <h1 id="title">پیش‌بینی هواشناسی</h1>
  <button id="langToggle" onclick="toggleLang()">AR</button>
</header>

<section id="searchSection">
  <input id="cityInput" placeholder="نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)" />
  <button id="searchBtn" onclick="searchCity()">🔍 جستجو</button>
</section>

<div id="cityName">اهواز</div>
<iframe id="mapFrame" src="" allowfullscreen loading="lazy"></iframe>

<section id="dailyForecast"></section>

<section id="hourlyForecast"></section>

<div id="plots"></div>

<div class="ad-box">
  <a href="tel:09332356547" id="callLink">📞 تماس با 09332356547</a>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88";
let currentLang = "fa";

const labels = {
  fa: {
    title: "پیش‌بینی هواشناسی",
    searchPlaceholder: "نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)",
    cityNotFound: "شهر مورد نظر پیدا نشد.",
    dailyTitle: "پیش‌بینی ۵ روزه",
    hourlyTitle: "پیش‌بینی ساعتی",
    tempDay: "روز",
    tempNight: "شب",
    wind: "باد",
    humidity: "رطوبت",
    call: "📞 تماس با 09332356547",
    directionLabels: ["شمال", "شمال‌شرقی", "شرق", "جنوب‌شرقی", "جنوب", "جنوب‌غربی", "غرب", "شمال‌غربی"],
  },
  ar: {
    title: "توقعات الطقس",
    searchPlaceholder: "أدخل اسم المدينة أو القرية",
    cityNotFound: "لم يتم العثور على المدينة.",
    dailyTitle: "توقعات ٥ أيام",
    hourlyTitle: "توقعات كل ساعة",
    tempDay: "نهار",
    tempNight: "ليل",
    wind: "الرياح",
    humidity: "الرطوبة",
    call: "📞 اتصل بـ 09332356547",
    directionLabels: ["شمال", "شمال شرقي", "شرق", "جنوب شرقي", "جنوب", "جنوب غربي", "غرب", "شمال غربي"],
  }
};

function toggleLang(){
  currentLang = currentLang === "fa" ? "ar" : "fa";
  document.getElementById("title").innerText = labels[currentLang].title;
  document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
  document.getElementById("langToggle").innerText = currentLang === "fa" ? "AR" : "FA";
  document.getElementById("callLink").innerText = labels[currentLang].call;
  renderForecast(lastWeatherData);
}

// تبدیل درجه باد به جهت فارسی یا عربی
function degToDir(deg){
  const d = labels[currentLang].directionLabels;
  return d[Math.round(deg / 45) % 8];
}

let lastWeatherData = null;

async function searchCity(){
  const city = document.getElementById("cityInput").value.trim();
  if(!city) return;
  try {
    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`);
    const geoData = await geoRes.json();
    if(!geoData.length){
      alert(labels[currentLang].cityNotFound);
      return;
    }
    const { lat, lon, name, country } = geoData[0];
    document.getElementById("cityName").innerText = `${name}, ${country}`;
    document.getElementById("mapFrame").src =
      `https://www.openstreetmap.org/export/embed.html?bbox=${lon - 0.2},${lat - 0.2},${lon + 0.2},${lat + 0.2}&layer=mapnik`;

    const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=${currentLang}&appid=${API_KEY}`);
    const weatherData = await weatherRes.json();
    lastWeatherData = weatherData;
    renderForecast(weatherData);
  } catch(e){
    alert("خطا در دریافت اطلاعات. لطفا دوباره تلاش کنید.");
    console.error(e);
  }
}

function renderForecast(data){
  if(!data) return;

  // پاک کردن انتخاب قبلی ساعت ها
  selectedDay = null;
  document.getElementById("hourlyForecast").style.display = "none";
  document.getElementById("hourlyForecast").innerHTML = "";

  // پیش‌بینی ۵ روزه
  const dailySection = document.getElementById("dailyForecast");
  dailySection.innerHTML = `<h2 style="text-align:center;margin-bottom:12px;">${labels[currentLang].dailyTitle}</h2>`;

  let dailyMap = {};
  data.list.forEach(item=>{
    const date = item.dt_txt.split(" ")[0];
    if(!dailyMap[date]) dailyMap[date] = [];
    dailyMap[date].push(item);
  });
  const days = Object.keys(dailyMap).slice(0,5);

  days.forEach(day => {
    const dayTemps = dailyMap[day].filter(i=> {
      const hour = parseInt(i.dt_txt.split(" ")[1].split(":")[0]);
      return hour >= 6 && hour <= 18;
    });
    const nightTemps = dailyMap[day].filter(i=>{
      const hour = parseInt(i.dt_txt.split(" ")[1].split(":")[0]);
      return hour < 6 || hour > 18;
    });
    const avgDayTemp = dayTemps.reduce((a,b)=>a+b.main.temp,0)/dayTemps.length || 0;
    const avgNightTemp = nightTemps.reduce((a,b)=>a+b.main.temp,0)/nightTemps.length || 0;
    const dayIcon = dayTemps.length ? dayTemps[0].weather[0].icon : dailyMap[day][0].weather[0].icon;
    const dayDesc = dayTemps.length ? dayTemps[0].weather[0].description : dailyMap[day][0].weather[0].description;

    dailySection.innerHTML += `
      <div class="day-card" data-day="${day}" onclick="showHourly('${day}')">
        <h3>${day}</h3>
        <img src="https://openweathermap.org/img/wn/${dayIcon}@2x.png" alt="weather icon" class="day-icon" />
        <div class="temp-day">${labels[currentLang].tempDay}: ${avgDayTemp.toFixed(1)}°C</div>
        <div class="temp-night">${labels[currentLang].tempNight}: ${avgNightTemp.toFixed(1)}°C</div>
        <div>${dayDesc}</div>
      </div>
    `;
  });

  // نمودار دما و باد کل 5 روز (هر 3 ساعت)
  plotCharts(data.list);

}

let selectedDay = null;

function showHourly(day){
  if(selectedDay === day){
    // دوباره کلیک روی همون روز پیش بینی ساعتی رو مخفی کن
    selectedDay = null;
    document.getElementById("hourlyForecast").style.display = "none";
    return;
  }
  selectedDay = day;

  const hourlySection = document.getElementById("hourlyForecast");
  hourlySection.style.display = "block";
  hourlySection.innerHTML = `<h2 style="text-align:center;margin-bottom:12px;">${labels[currentLang].hourlyTitle} - ${day}</h2>`;

  // فیلتر فقط ساعت‌های آن روز
  const hours = lastWeatherData.list.filter(item => item.dt_txt.startsWith(day));

  hours.forEach(item=>{
    const hour = item.dt_txt.split(" ")[1].slice(0,5);
    const windDir = degToDir(item.wind.deg);
    hourlySection.innerHTML += `
      <div class="hour-card">
        <div class="hour-time">${hour}</div>
        <img src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png" alt="icon" class="hour-icon" />
        <div class="hour-temp">${item.main.temp.toFixed(1)}°C</div>
        <div class="hour-desc">${item.weather[0].description}</div>
        <div class="hour-wind">${labels[currentLang].wind}: ${item.wind.speed} m/s ${windDir}</div>
        <div class="hour-humidity">${labels[currentLang].humidity}: ${item.main.humidity}%</div>
      </div>
    `;
  });
}

function plotCharts(dataList){
  const hours = dataList.map(i => i.dt_txt.replace(" ", "\n"));
  const temps = dataList.map(i => i.main.temp);
  const winds = dataList.map(i => i.wind.speed);

  const tempTrace = {
    x: hours,
    y: temps,
    name: labels[currentLang].tempDay + " (°C)",
    type: 'scatter',
    mode: 'lines+markers',
    line: { color: '#ff6b6b' },
  };

  const windTrace = {
    x: hours,
    y: winds,
    name: labels[currentLang].wind + " (m/s)",
    type: 'scatter',
    mode: 'lines+markers',
    line: { color: '#1e90ff' },
    yaxis: 'y2'
  };

  const layout = {
    title: '',
    font: {family: 'Vazir, sans-serif', color: '#eee'},
    plot_bgcolor: '#222',
    paper_bgcolor: '#222',
    legend: {x: 0, y: 1, font: {color: '#eee'}},
    margin: {t: 20, b: 60, l: 60, r: 60},
    height: 360,
    hovermode: 'x unified',
    yaxis: {
      title: labels[currentLang].tempDay + ' (°C)',
      color: '#ff6b6b',
      zerolinecolor: '#555'
    },
    yaxis2: {
      title: labels[currentLang].wind + ' (m/s)',
      overlaying: 'y',
      side: 'right',
      color: '#1e90ff',
      zerolinecolor: '#555'
    },
    xaxis: {
      title: labels[currentLang].hourlyTitle,
      tickangle: -45,
      color: '#ccc',
      tickfont: {size: 10}
    }
  };

  Plotly.newPlot('plots', [tempTrace, windTrace], layout, {responsive: true});
}

// بارگذاری اولیه با اهواز
window.onload = () => {
  document.getElementById("cityInput").value = "اهواز";
  searchCity();
};
</script>

</body>
</html>
