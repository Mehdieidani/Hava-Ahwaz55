<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
<link href="https://cdn.jsdelivr.net/npm/vazir-font@v1.1.2/dist/font-face.css" rel="stylesheet" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-oGZj6j7l75Qo6Sj01WZb2n08+36a3L8aV7Qw+iYXF0k="
  crossorigin=""
/>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Vazir, sans-serif;
    background: linear-gradient(to top, #001529, #0a2749);
    color: #eee;
    direction: rtl;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow: hidden;
  }
  body {
    display: flex;
    flex-direction: column;
  }
  header {
    background-color: #003366;
    padding: 0.8rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.7rem;
  }
  #langToggle {
    background: #00509e;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.4rem 1rem;
    cursor: pointer;
    font-weight: bold;
  }
  main {
    flex: 1 1 auto;
    display: flex;
    height: calc(100vh - 56px);
    gap: 8px;
    padding: 8px;
    box-sizing: border-box;
    overflow: hidden;
  }
  #leftPanel {
    flex: 1 1 360px;
    max-width: 400px;
    background: #013a63;
    border-radius: 12px;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #searchSection {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }
  #cityInput {
    flex: 1;
    padding: 0.5rem 0.7rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  #searchBtn {
    background: #00509e;
    color: white;
    border: none;
    padding: 0 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  #favorites {
    margin-bottom: 12px;
    overflow-x: auto;
    white-space: nowrap;
  }
  #favorites button {
    background: #00509e;
    color: white;
    border: none;
    margin: 0 6px 6px 0;
    padding: 0.3rem 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    display: inline-block;
    white-space: nowrap;
  }
  #favorites button:hover {
    background: #1a73e8;
  }
  #currentWeather {
    background: #01497c;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    flex-shrink: 0;
  }
  #currentWeather img {
    width: 90px;
    height: 90px;
  }
  #currentWeather h2 {
    margin: 0.3rem 0 0.6rem 0;
    font-size: 1.3rem;
  }
  #currentWeather .temp {
    font-size: 2.4rem;
    font-weight: 700;
  }
  #currentWeather .desc {
    font-size: 1.1rem;
    margin: 0.4rem 0 0.8rem 0;
  }
  #currentWeather .details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    font-size: 0.85rem;
  }
  #forecastContainer {
    flex: 2 1 600px;
    background: #013a63;
    border-radius: 12px;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #dailyForecast {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 6px;
    scrollbar-width: thin;
    scrollbar-color: #3399ff #013a63;
    flex-shrink: 0;
  }
  .day-card {
    background: #00509e;
    flex: 0 0 120px;
    border-radius: 10px;
    padding: 0.4rem 0.5rem;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
    color: #eee;
    font-size: 0.85rem;
    text-align: center;
  }
  .day-card.active,
  .day-card:hover {
    background: #1a73e8;
  }
  .day-card h3 {
    margin: 0 0 0.3rem 0;
    font-size: 1rem;
    font-weight: 700;
  }
  .day-card img {
    display: block;
    margin: 0 auto 0.3rem auto;
    width: 50px;
    height: 50px;
  }
  #hourlyForecast {
    margin-top: 8px;
    background: #01497c;
    border-radius: 12px;
    padding: 8px;
    box-sizing: border-box;
    color: #eee;
    overflow-y: auto;
    flex: 1 1 auto;
    font-size: 0.85rem;
  }
  .hour-card {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 0.6rem;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid #0277bd;
  }
  .hour-card img {
    width: 40px;
    height: 40px;
  }
  .hour-info {
    flex: 1;
  }
  .hour-info div {
    margin-bottom: 0.15rem;
  }
  .detail-label {
    font-weight: 700;
  }
  #map {
    height: 140px;
    border-radius: 12px;
    margin-top: 8px;
    flex-shrink: 0;
  }
  footer {
    text-align: center;
    padding: 0.6rem 1rem;
    font-size: 0.85rem;
    background: #002143;
    color: #bbb;
    flex-shrink: 0;
  }
  footer a {
    color: #3399ff;
    text-decoration: none;
    margin: 0 0.3rem;
  }
  footer a:hover {
    text-decoration: underline;
  }
  /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø¯Ø§Ù„ÛŒ ÙÙØ±Ú©Ø§Ø³Øª */
  #dailyForecast::-webkit-scrollbar {
    height: 6px;
  }
  #dailyForecast::-webkit-scrollbar-thumb {
    background: #3399ff;
    border-radius: 10px;
  }
  #dailyForecast::-webkit-scrollbar-track {
    background: #013a63;
  }
  /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ */
  #hourlyForecast::-webkit-scrollbar {
    width: 6px;
  }
  #hourlyForecast::-webkit-scrollbar-thumb {
    background: #3399ff;
    border-radius: 10px;
  }
  #hourlyForecast::-webkit-scrollbar-track {
    background: #013a63;
  }

  /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  @media (max-width: 820px) {
    main {
      flex-direction: column;
      height: calc(100vh - 56px);
    }
    #leftPanel, #forecastContainer {
      max-width: 100%;
      flex: none;
      height: 50%;
      overflow: hidden;
      padding: 8px 8px 8px 8px;
    }
    #dailyForecast {
      justify-content: flex-start;
    }
    #hourlyForecast {
      height: calc(100% - 220px);
    }
    #map {
      height: 100px;
      margin-top: 4px;
    }
  }
</style>
</head>
<body>

<header>
  <h1 id="title">ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§</h1>
  <button id="langToggle" onclick="toggleLang()">AR</button>
</header>

<main>
  <section id="leftPanel">
    <div id="searchSection">
      <input id="cityInput" type="text" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)" />
      <button id="searchBtn" onclick="searchCity()">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div id="favorites"></div>

    <div id="currentWeather"></div>
  </section>

  <section id="forecastContainer">
    <div id="dailyForecast" aria-label="Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡"></div>
    <div id="hourlyForecast" aria-label="Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ"></div>
    <div id="map" aria-label="Ù†Ù‚Ø´Ù‡"></div>
  </section>
</main>

<footer>
  <div>ØªÙ…Ø§Ø³: <a href="tel:09332356547">09332356547</a></div>
  <div>Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a></div>
  <div>Ø§ÛŒÙ…ÛŒÙ„: <a href="mailto:mehdi1eidani@gmail.com">mehdi1eidani@gmail.com</a></div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-oW7l7NhKX0iSXXEe4BfPvvCJS8+PpL3e2pA6cd9vXNk="
  crossorigin=""></script>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localeData.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekOfYear.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/dayOfYear.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/advancedFormat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isToday.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isTomorrow.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isYesterday.js"></script>

<script>
  dayjs.extend(window.dayjs_plugin_utc);
  dayjs.extend(window.dayjs_plugin_timezone);
  dayjs.extend(window.dayjs_plugin_customParseFormat);
  dayjs.extend(window.dayjs_plugin_localeData);
  dayjs.extend(window.dayjs_plugin_weekOfYear);
  dayjs.extend(window.dayjs_plugin_dayOfYear);
  dayjs.extend(window.dayjs_plugin_advancedFormat);
  dayjs.extend(window.dayjs_plugin_isToday);
  dayjs.extend(window.dayjs_plugin_isTomorrow);
  dayjs.extend(window.dayjs_plugin_isYesterday);

  const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88";
  let currentLang = "fa";
  let currentUnits = "metric";
  let currentCity = null;
  let map, mapMarker;

  const labels = {
    fa: {
      title: "ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§",
      searchPlaceholder: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)",
      searchBtn: "Ø¬Ø³ØªØ¬Ùˆ",
      hourlyTitle: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ",
      temp: "Ø¯Ù…Ø§",
      humidity: "Ø±Ø·ÙˆØ¨Øª",
      pressure: "ÙØ´Ø§Ø± Ù‡ÙˆØ§",
      windSpeed: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯",
      windDir: "Ø¬Ù‡Øª Ø¨Ø§Ø¯",
      sunrise: "Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨",
      sunset: "ØºØ±ÙˆØ¨ Ø¢ÙØªØ§Ø¨",
      aqi: "Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§",
      favoritesTitle: "Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡",
      addFav: "Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§",
      removeFav: "Ø­Ø°Ù Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§",
      noFav: "Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.",
      errorCity: "Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.",
      callText: "ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ 09332356547",
      instagram: "Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…",
      email: "Ø§ÛŒÙ…ÛŒÙ„",
      visibility: "Ø¯ÛŒØ¯ Ø§ÙÙ‚ÛŒ",
      uvIndex: "Ø´Ø§Ø®Øµ UV",
      pop: "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´",
      feelsLike: "Ø§Ø­Ø³Ø§Ø³ ÙˆØ§Ù‚Ø¹ÛŒ",
      dewPoint: "Ù†Ù‚Ø·Ù‡ Ø´Ø¨Ù†Ù…",
      clouds: "Ø§Ø¨Ø±Ù‡Ø§",
      description: "ØªÙˆØ¶ÛŒØ­Ø§Øª",
      day: "Ø±ÙˆØ²",
      night: "Ø´Ø¨",
      max: "Ø¨ÛŒØ´ÛŒÙ†Ù‡",
      min: "Ú©Ù…ÛŒÙ†Ù‡"
    },
    ar: {
      title: "Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³",
      searchPlaceholder: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©",
      searchBtn: "Ø¨Ø­Ø«",
      hourlyTitle: "ØªÙˆÙ‚Ø¹Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø©",
      temp: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
      humidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
      pressure: "Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¬ÙˆÙŠ",
      windSpeed: "Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­",
      windDir: "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­",
      sunrise: "Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³",
      sunset: "ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³",
      aqi: "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡",
      favoritesTitle: "Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©",
      addFav: "Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø§Øª",
      removeFav: "Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª",
      noFav: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ù† Ù…ÙØ¶Ù„Ø©.",
      errorCity: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.",
      callText: "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù€ 09332356547",
      instagram: "Ø§Ù†Ø³ØªØºØ±Ø§Ù…",
      email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
      visibility: "Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙÙ‚ÙŠØ©",
      uvIndex: "Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø´Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠØ©",
      pop: "Ø§Ø­ØªÙ…Ø§Ù„ Ù‡Ø·ÙˆÙ„ Ø§Ù„Ø£Ù…Ø·Ø§Ø±",
      feelsLike: "Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ³Ø©",
      dewPoint: "Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ø¯Ù‰",
      clouds: "Ø§Ù„ØºÙŠÙˆÙ…",
      description: "Ø§Ù„ÙˆØµÙ",
      day: "Ù†Ù‡Ø§Ø±",
      night: "Ù„ÙŠÙ„",
      max: "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰",
      min: "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰"
    }
  };

  let favorites = JSON.parse(localStorage.getItem("favorites_weather")) || [];

  function toggleLang() {
    currentLang = currentLang === "fa" ? "ar" : "fa";
    document.getElementById("title").innerText = labels[currentLang].title;
    document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
    document.getElementById("searchBtn").innerText = labels[currentLang].searchBtn;
    renderFavorites();
    if(currentCity) searchCity(currentCity.name);
  }

  function toggleFavorite(cityName) {
    if (favorites.includes(cityName)) {
      favorites = favorites.filter(c => c !== cityName);
    } else {
      favorites.push(cityName);
    }
    localStorage.setItem("favorites_weather", JSON.stringify(favorites));
    renderFavorites();
  }

  function renderFavorites() {
    const favDiv = document.getElementById("favorites");
    favDiv.innerHTML = "";
    if (favorites.length === 0) {
      favDiv.innerText = labels[currentLang].noFav;
      return;
    }
    favorites.forEach(city => {
      const btn = document.createElement("button");
      btn.textContent = city;
      btn.onclick = () => {
        document.getElementById("cityInput").value = city;
        searchCity(city);
      };
      favDiv.appendChild(btn);
    });
  }

  function searchCity(cityName = null) {
    let city = cityName || document.getElementById("cityInput").value.trim();
    if (!city) return alert(labels[currentLang].errorCity);

    fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`)
    .then(res => res.json())
    .then(geoData => {
      if (!geoData.length) throw new Error(labels[currentLang].errorCity);

      const { lat, lon, name, country } = geoData[0];
      currentCity = { lat, lon, name, country };

      if (!map) initMap(lat, lon);
      else {
        map.setView([lat, lon], 10);
        if (mapMarker) map.removeLayer(mapMarker);
        mapMarker = L.marker([lat, lon]).addTo(map).bindPopup(`${name}, ${country}`).openPopup();
      }

      return Promise.all([
        fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`).then(r => r.json()),
        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`).then(r => r.json()),
        fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`).then(r => r.json())
      ]);
    })
    .then(([forecastData, currentData, airData]) => {
      renderCurrent(currentData, airData);
      renderDaily(forecastData);
      renderHourly(forecastData);
    })
    .catch(e => {
      alert(e.message || labels[currentLang].errorCity);
    });
  }

  function renderCurrent(data, airData) {
    const curDiv = document.getElementById("currentWeather");
    const iconUrl = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
    const sunrise = dayjs.unix(data.sys.sunrise).tz(data.timezone).format("HH:mm");
    const sunset = dayjs.unix(data.sys.sunset).tz(data.timezone).format("HH:mm");

    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const now = dayjs.unix(data.dt).utcOffset(data.timezone/60);
    const shamsiDate = toPersianDate(now);

    let windDeg = data.wind.deg;
    let windDir = getWindDirection(windDeg, currentLang);

    let html = `
      <h2>${data.name}, ${data.sys.country}</h2>
      <div><strong>${shamsiDate}</strong></div>
      <img src="${iconUrl}" alt="${data.weather[0].description}" />
      <div class="temp">${Math.round(data.main.temp)}Â°C</div>
      <div class="desc">${data.weather[0].description}</div>
      <div class="details">
        <div><span class="detail-label">${labels[currentLang].humidity}:</span> ${data.main.humidity}%</div>
        <div><span class="detail-label">${labels[currentLang].pressure}:</span> ${data.main.pressure} hPa</div>
        <div><span class="detail-label">${labels[currentLang].windSpeed}:</span> ${data.wind.speed} m/s</div>
        <div><span class="detail-label">${labels[currentLang].windDir}:</span> ${windDir} (${windDeg}Â°)</div>
        <div><span class="detail-label">${labels[currentLang].sunrise}:</span> ${dayjs.unix(data.sys.sunrise).utcOffset(data.timezone/60).format("HH:mm")}</div>
        <div><span class="detail-label">${labels[currentLang].sunset}:</span> ${dayjs.unix(data.sys.sunset).utcOffset(data.timezone/60).format("HH:mm")}</div>
        <div><span class="detail-label">${labels[currentLang].aqi}:</span> ${airData.list[0].main.aqi}</div>
      </div>
      <button onclick="toggleFavorite('${data.name}')">${favorites.includes(data.name) ? labels[currentLang].removeFav : labels[currentLang].addFav}</button>
    `;
    curDiv.innerHTML = html;
  }

  function renderDaily(data) {
    const dailyDiv = document.getElementById("dailyForecast");
    dailyDiv.innerHTML = "";

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ÛŒ Ø³Ù‡ Ø³Ø§Ø¹ØªÙ‡
    let days = {};
    data.list.forEach(item => {
      const dateStr = item.dt_txt.split(" ")[0];
      if (!days[dateStr]) days[dateStr] = [];
      days[dateStr].push(item);
    });

    const dayKeys = Object.keys(days).slice(0, 5);
    dayKeys.forEach(dateStr => {
      const dayData = days[dateStr];
      // Ù…ÛŒØ§Ù†Ù‡ Ø¯Ù…Ø§ Ùˆ Ø´Ø±Ø§ÛŒØ· Ù‡ÙˆØ§ÛŒÛŒ Ø±ÙˆØ²
      const temps = dayData.map(d => d.main.temp);
      const maxTemp = Math.max(...temps);
      const minTemp = Math.min(...temps);
      const icon = dayData[0].weather[0].icon;
      const desc = dayData[0].weather[0].description;
      const dayJsDate = dayjs(dateStr);
      const labelDay = dayJsDate.locale(currentLang === "fa" ? "fa" : "ar").format("dddd");
      const labelDate = toPersianDate(dayJsDate);

      const card = document.createElement("div");
      card.className = "day-card";
      card.dataset.date = dateStr;
      card.title = desc;
      card.innerHTML = `
        <h3>${labelDay}</h3>
        <div>${labelDate}</div>
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${desc}" />
        <div>${labels[currentLang].max}: ${Math.round(maxTemp)}Â°</div>
        <div>${labels[currentLang].min}: ${Math.round(minTemp)}Â°</div>
      `;
      card.onclick = () => renderHourlyForDate(dateStr);
      dailyDiv.appendChild(card);
    });

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´ ÙØ±Ø¶ Ø³Ø§Ø¹ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ²
    if (dayKeys.length) renderHourlyForDate(dayKeys[0]);
  }

  function renderHourly(data) {
    // Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø±ÙˆÛŒ Ú©Ù„ Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ Ù†ÛŒØ³ØªØ› ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ùˆ Ø®Ø§Ù„ÛŒ Ú¯Ø°Ø§Ø´ØªÛŒÙ… ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ø³Ø§Ø¹ØªÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  }

  function renderHourlyForDate(dateStr) {
    const hourlyDiv = document.getElementById("hourlyForecast");
    hourlyDiv.innerHTML = "";

    // Ø¨Ø±Ø¬Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    document.querySelectorAll(".day-card").forEach(card => {
      card.classList.toggle("active", card.dataset.date === dateStr);
    });

    // ÙÛŒÙ„ØªØ± Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¢Ù† ØªØ§Ø±ÛŒØ®
    fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${currentCity.lat}&lon=${currentCity.lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`)
    .then(res => res.json())
    .then(data => {
      const list = data.list.filter(item => item.dt_txt.startsWith(dateStr));
      list.forEach(item => {
        const iconUrl = `https://openweathermap.org/img/wn/${item.weather[0].icon}@2x.png`;
        const time = dayjs(item.dt_txt).format("HH:mm");
        let windDir = getWindDirection(item.wind.deg, currentLang);

        const hourCard = document.createElement("div");
        hourCard.className = "hour-card";
        hourCard.innerHTML = `
          <img src="${iconUrl}" alt="${item.weather[0].description}" />
          <div class="hour-info">
            <div><strong>${time}</strong></div>
            <div>${item.weather[0].description}</div>
            <div>${labels[currentLang].temp}: ${Math.round(item.main.temp)}Â°C ( ${labels[currentLang].feelsLike}: ${Math.round(item.main.feels_like)}Â°C )</div>
            <div>${labels[currentLang].humidity}: ${item.main.humidity}%</div>
            <div>${labels[currentLang].windSpeed}: ${item.wind.speed} m/s</div>
            <div>${labels[currentLang].windDir}: ${windDir} (${item.wind.deg}Â°)</div>
            <div>${labels[currentLang].pop}: ${Math.round(item.pop*100)}%</div>
            <div>${labels[currentLang].pressure}: ${item.main.pressure} hPa</div>
          </div>
        `;
        hourlyDiv.appendChild(hourCard);
      });
    });
  }

  function getWindDirection(deg, lang) {
    const directionsFA = ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚ÛŒ", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚ÛŒ", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨ÛŒ", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨ÛŒ"];
    const directionsAR = ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ"];
    const directions = lang === "fa" ? directionsFA : directionsAR;
    const index = Math.floor((deg + 22.5) / 45) % 8;
    return directions[index];
  }

  function toPersianDate(dayjsObj) {
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø¨Ø¯ÙˆÙ† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
    // Ø§ÛŒÙ† Ú©Ø¯ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Intl.DateTimeFormat (Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ù†Ø¯)
    try {
      const formatter = new Intl.DateTimeFormat("fa-IR-u-ca-persian", {
        year: "numeric",
        month: "numeric",
        day: "numeric",
      });
      return formatter.format(dayjsObj.toDate());
    } catch {
      // Ø§Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´Ø¯ØŒ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ Ù…ÛŒØ¯Ù‡Ø¯
      return dayjsObj.format("YYYY/MM/DD");
    }
  }

  function initMap(lat, lon) {
    map = L.map("map").setView([lat, lon], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution:
        'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);
    mapMarker = L.marker([lat, lon]).addTo(map);
  }

  // Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø´Ù‡Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ù‡ÙˆØ§Ø²
  window.onload = () => {
    renderFavorites();
    document.getElementById("cityInput").value = "Ø§Ù‡ÙˆØ§Ø²";
    searchCity("Ø§Ù‡ÙˆØ§Ø²");
  };
</script>

</body>
</html>
