<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>پیش‌بینی هواشناسی پیشرفته</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: #111;
      color: #eee;
    }
    header {
      background: #222;
      padding: 1rem;
      text-align: center;
    }
    #searchBox {
      padding: 0.5rem;
      width: 80%;
      max-width: 300px;
      margin-top: 0.5rem;
      border-radius: 5px;
    }
    .lang-toggle, .settings {
      position: absolute;
      top: 1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .lang-toggle {
      left: 1rem;
    }
    .settings {
      right: 1rem;
    }
    .weather-card {
      background: #1c1c1c;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem;
    }
    .forecast-hourly {
      display: none;
      margin-top: 1rem;
      padding: 0.5rem;
      background: #191919;
      border-radius: 6px;
    }
    .forecast-day {
      cursor: pointer;
      margin-bottom: 1rem;
      background: #2a2a2a;
      border-radius: 8px;
      padding: 1rem;
    }
    .forecast-day:hover {
      background: #444;
    }
    .icon {
      width: 50px;
      vertical-align: middle;
    }
    .favorite-btn {
      color: gold;
      font-size: 1.2rem;
      cursor: pointer;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background: #222;
      font-size: 0.85rem;
    }
    .ad-banner {
      background: #444;
      padding: 0.5rem;
      text-align: center;
      margin: 1rem;
      border-radius: 6px;
    }
    .ad-banner a {
      color: #00f7ff;
      text-decoration: none;
      font-weight: bold;
    }
    .feedback {
      margin: 2rem;
      background: #222;
      padding: 1rem;
      border-radius: 8px;
    }
    .feedback textarea {
      width: 100%;
      height: 80px;
      padding: 0.5rem;
      border-radius: 6px;
      border: none;
      resize: none;
    }
    .feedback button {
      margin-top: 0.5rem;
      background: teal;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <h2 id="title">پیش‌بینی آب‌وهوا</h2>
  <input type="text" id="searchBox" placeholder="نام شهر یا روستا...">
  <div class="lang-toggle" onclick="toggleLang()">🌐</div>
  <div class="settings" onclick="alert('تنظیمات هنوز فعال نشده')">⚙️</div>
</header>

<div class="ad-banner">
  <a href="tel:09332356547">📞 تماس با 09332356547</a>
</div>

<main id="forecast"></main>

<div class="feedback">
  <h4>ارسال نظر یا پیشنهاد:</h4>
  <textarea placeholder="نظر شما..."></textarea>
  <button onclick="alert('ارسال شد')">ارسال</button>
</div>

<footer>
  <p>© کلیه حقوق محفوظ است Mehdi Eidani</p>
  <p>📧 mehdi1eidani@gmail.com | 📷 <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a></p>
</footer>

<script>
const langData = {
  fa: {
    title: "پیش‌بینی آب‌وهوا",
    placeholder: "نام شهر یا روستا...",
    send: "ارسال",
    feedback: "ارسال نظر یا پیشنهاد:",
    call: "📞 تماس با",
    rights: "© کلیه حقوق محفوظ است Mehdi Eidani"
  },
  ar: {
    title: "توقعات الطقس",
    placeholder: "اكتب اسم المدينة...",
    send: "إرسال",
    feedback: "اقتراح أو ملاحظة:",
    call: "📞 اتصل بـ",
    rights: "© جميع الحقوق محفوظة لـ Mehdi Eidani"
  }
};

let currentLang = "fa";
const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";

function toggleLang() {
  currentLang = currentLang === "fa" ? "ar" : "fa";
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === "fa" ? "rtl" : "rtl"; // Both RTL
  document.getElementById("title").innerText = langData[currentLang].title;
  document.getElementById("searchBox").placeholder = langData[currentLang].placeholder;
  document.querySelector(".feedback h4").innerText = langData[currentLang].feedback;
  document.querySelector(".feedback button").innerText = langData[currentLang].send;
  document.querySelector(".ad-banner a").innerText = `${langData[currentLang].call} 09332356547`;
  document.querySelector("footer p").innerText = langData[currentLang].rights;
}

document.getElementById("searchBox").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const city = e.target.value.trim();
    if (city.length > 1) {
      loadWeather(city);
    } else {
      alert("لطفاً نام معتبر وارد کنید");
    }
  }
});

function loadWeather(city) {
  fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=${currentLang}`)
    .then(res => res.json())
    .then(data => {
      if (!data.list) {
        alert("داده‌ای یافت نشد");
        return;
      }
      displayForecast(data);
    })
    .catch(err => {
      console.error(err);
      alert("خطا در دریافت اطلاعات");
    });
}

function displayForecast(data) {
  const forecastEl = document.getElementById("forecast");
  forecastEl.innerHTML = "";

  const grouped = {};

  data.list.forEach(item => {
    const date = item.dt_txt.split(" ")[0];
    if (!grouped[date]) grouped[date] = [];
    grouped[date].push(item);
  });

  Object.keys(grouped).forEach(date => {
    const daily = grouped[date];
    const dayEl = document.createElement("div");
    dayEl.className = "forecast-day";
    const iconUrl = `https://openweathermap.org/img/wn/${daily[0].weather[0].icon}@2x.png`;

    const dir = getWindDirection(daily[0].wind.deg);

    dayEl.innerHTML = `
      <strong>${toPersianDate(date)}</strong><br>
      <img src="${iconUrl}" class="icon"> ${daily[0].weather[0].description}<br>
      🌡️ دما: ${daily[0].main.temp_min}° ~ ${daily[0].main.temp_max}°<br>
      💧 رطوبت: ${daily[0].main.humidity}%<br>
      🧭 باد: ${daily[0].wind.speed}km/h ${dir}
      <div class="forecast-hourly"></div>
    `;
    dayEl.addEventListener("click", () => {
      const sub = dayEl.querySelector(".forecast-hourly");
      sub.style.display = sub.style.display === "block" ? "none" : "block";
      sub.innerHTML = daily.map(i => `
        ${i.dt_txt.split(" ")[1].slice(0,5)}: ${i.main.temp}°C, ${i.weather[0].description}
      `).join("<br>");
    });

    forecastEl.appendChild(dayEl);
  });
}

function getWindDirection(deg) {
  const dirs = ["شمال", "شمال شرق", "شرق", "جنوب شرق", "جنوب", "جنوب غرب", "غرب", "شمال غرب"];
  return dirs[Math.round(deg / 45) % 8];
}

function toPersianDate(dateStr) {
  const g = new Date(dateStr);
  const f = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  return f.format(g);
}

// موقعیت مکانی کاربر
if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${currentLang}`)
      .then(res => res.json())
      .then(data => displayForecast(data));
  });
}
</script>

</body>
</html>
