<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif; background: #eef6ff; margin: 0; padding: 0; color: #222; direction: rtl;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background-color: #121212; color: #eee;
    }
    header {
      background: #0077cc; color: white; padding: 15px; text-align: center;
    }
    .container {
      max-width: 700px; margin: 20px auto; padding: 15px; background: white; border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label, input, button, select {
      font-size: 1rem; margin: 5px 0; width: 100%;
      box-sizing: border-box;
    }
    input {
      padding: 8px; border: 1px solid #aaa; border-radius: 5px;
    }
    button {
      background: #0077cc; color: white; border: none; padding: 10px; border-radius: 6px;
      cursor: pointer; transition: background-color 0.3s;
    }
    button:hover {
      background: #005fa3;
    }
    .wind-dir {
      display: inline-block; transition: transform 0.3s ease; font-size: 1.3rem;
    }
    .weather-info {
      margin-top: 15px;
      line-height: 1.6;
    }
    .chart-container {
      margin-top: 25px;
    }
  </style>
</head>
<body>

<header>
  <h1>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
  <p>Ø±ÙˆØ³ØªØ§ÛŒ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ Ùˆ Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†</p>
</header>

<div class="container" dir="rtl">
  <label for="cityInput">Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§:</label>
  <input type="text" id="cityInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ Kazemi Do ÛŒØ§ Tehran ÛŒØ§ Baghdad" />
  <button id="searchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
  <button id="geoBtn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
  <button id="themeBtn">ØªØºÛŒÛŒØ± ØªÙ…</button>

  <div id="weatherInfo" class="weather-info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>

  <div class="chart-container">
    <canvas id="windChart" aria-label="Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯" role="img"></canvas>
  </div>
</div>

<script>
  const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";
  const cityInput = document.getElementById("cityInput");
  const searchBtn = document.getElementById("searchBtn");
  const geoBtn = document.getElementById("geoBtn");
  const themeBtn = document.getElementById("themeBtn");
  const weatherInfo = document.getElementById("weatherInfo");
  const windChartCtx = document.getElementById("windChart").getContext("2d");

  let windChartInstance = null;
  let isDark = false;

  function displayWeather(data) {
    const city = data.city;
    const list = data.list;

    let html = `<h2>${city.name}, ${city.country}</h2>`;
    html += `<p>ğŸ“ Ù…Ø®ØªØµØ§Øª: ${city.coord.lat.toFixed(4)}, ${city.coord.lon.toFixed(4)}</p>`;

    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ† Ù„Ø­Ø¸Ù‡ (Ø§Ú©Ù†ÙˆÙ†)
    const now = list[0];
    html += `<p>ğŸŒ¡ï¸ Ø¯Ù…Ø§: ${now.main.temp}Â°C</p>`;
    html += `<p>ğŸ’§ Ø±Ø·ÙˆØ¨Øª: ${now.main.humidity}%</p>`;
    html += `<p>ğŸŒ¬ï¸ Ø¨Ø§Ø¯: ${now.wind.speed} m/s 
      <span class="wind-dir" style="transform: rotate(${now.wind.deg}deg)">ğŸ§­</span>
    </p>`;
    html += `<p>â˜ï¸ ÙˆØ¶Ø¹ÛŒØª: ${now.weather[0].description}</p>`;
    html += `<p>ğŸŒ… Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯: ${new Date(city.sunrise * 1000).toLocaleTimeString("fa-IR")}</p>`;
    html += `<p>ğŸŒ‡ ØºØ±ÙˆØ¨ Ø®ÙˆØ±Ø´ÛŒØ¯: ${new Date(city.sunset * 1000).toLocaleTimeString("fa-IR")}</p>`;

    weatherInfo.innerHTML = html;

    // Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯ (5 Ø±ÙˆØ² Ø³Ø§Ø¹ØªÛŒØŒ Ù‡Ø± 3 Ø³Ø§Ø¹Øª ÛŒÚ© Ù†Ù‚Ø·Ù‡)
    const labels = [];
    const speeds = [];

    list.slice(0, 40).forEach(item => {
      const dt = new Date(item.dt * 1000);
      labels.push(dt.toLocaleString("fa-IR", { hour: "2-digit", day: "numeric", month: "numeric" }));
      speeds.push(item.wind.speed);
    });

    if (windChartInstance) windChartInstance.destroy();

    windChartInstance = new Chart(windChartCtx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯ (m/s)",
          data: speeds,
          borderColor: "#0077cc",
          backgroundColor: "rgba(0, 119, 204, 0.3)",
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯ (m/s)" } },
          x: { ticks: { maxRotation: 90, minRotation: 45 } }
        }
      }
    });
  }

  async function fetchWeather(city) {
    weatherInfo.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...";
    try {
      const res = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=fa`
      );
      if (!res.ok) throw new Error("City not found");
      const data = await res.json();
      displayWeather(data);
    } catch {
      weatherInfo.textContent = "âŒ Ø´Ù‡Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
    }
  }

  function toggleTheme() {
    isDark = !isDark;
    if (isDark) document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }

  function getLocationAndFetchWeather() {
    if (!navigator.geolocation) {
      alert("Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      fetchWeatherByCoords(lat, lon);
    }, () => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª."));
  }

  async function fetchWeatherByCoords(lat, lon) {
    weatherInfo.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...";
    try {
      const res = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=fa`
      );
      if (!res.ok) throw new Error("Location not found");
      const data = await res.json();
      displayWeather(data);
    } catch {
      weatherInfo.textContent = "âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª ÛŒØ§ÙØª Ù†Ø´Ø¯.";
    }
  }

  // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
  searchBtn.addEventListener("click", () => {
    const city = cityInput.value.trim();
    if (city) fetchWeather(city);
  });

  geoBtn.addEventListener("click", () => {
    getLocationAndFetchWeather();
  });

  themeBtn.addEventListener("click", () => {
    toggleTheme();
  });

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø±ÙˆØ³ØªØ§ÛŒ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ
  cityInput.value = "Kazemi Do";
  fetchWeather("Kazemi Do");
</script>

</body>
</html>
