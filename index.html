<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ - Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Reset */
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e6f0ff; color: #222;
      direction: rtl; text-align: right;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark {
      background: #121212;
      color: #ddd;
    }
    header {
      background: #005bbb; color: white; padding: 20px; text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .container {
      max-width: 900px; margin: auto; padding: 15px;
    }
    .box {
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: background 0.3s, color 0.3s;
    }
    .dark .box {
      background: #222;
      color: #ddd;
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    label {
      display: block; margin-bottom: 8px; font-weight: bold; font-size: 1.1rem;
    }
    input[type="text"], select {
      width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px;
      border: 1px solid #ccc; transition: border-color 0.3s;
    }
    input[type="text"]:focus, select:focus {
      border-color: #005bbb; outline: none;
    }
    button {
      margin-top: 10px; padding: 12px 25px;
      background-color: #005bbb; color: white; font-weight: bold;
      border: none; border-radius: 8px;
      cursor: pointer; font-size: 1.1rem;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #003f8a;
    }
    .rtl {
      direction: rtl; text-align: right;
    }
    .wind-dir {
      display: inline-block; transition: transform 0.4s ease;
      font-size: 1.3rem;
    }
    .icon {
      vertical-align: middle; width: 48px; height: 48px;
    }
    .forecast-list {
      list-style: none; padding: 0; margin: 0;
      max-height: 300px; overflow-y: auto;
      border-top: 1px solid #ddd;
    }
    .forecast-list li {
      padding: 12px 0; border-bottom: 1px solid #eee;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.9rem;
    }
    .forecast-list li:last-child {
      border-bottom: none;
    }
    .chart-container {
      position: relative; height: 300px; width: 100%;
    }
    #map {
      width: 100%; height: 250px; border-radius: 12px; margin-top: 20px;
    }
    .moon-phase {
      font-size: 1.3rem; margin-top: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    .moon-phase span {
      font-size: 2rem;
    }
    /* Scrollbar for forecast list */
    .forecast-list::-webkit-scrollbar {
      width: 8px;
    }
    .forecast-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 8px;
    }
    .forecast-list::-webkit-scrollbar-thumb {
      background: #005bbb;
      border-radius: 8px;
    }
    /* Dark scrollbar */
    .dark .forecast-list::-webkit-scrollbar-track {
      background: #222;
    }
    .dark .forecast-list::-webkit-scrollbar-thumb {
      background: #3399ff;
    }
    /* Print styles */
    @media print {
      button, #themeToggle, #langSelect, #cityInput { display: none !important; }
      body { background: white; color: black; }
      .box { box-shadow: none; border: none; }
    }
    /* Responsive */
    @media(max-width:600px) {
      button { width: 100%; }
      .forecast-list li { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body class="rtl">

<header>
  <h1 id="title">Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ - Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
  <p id="subtitle">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§ Ø¨Ø§ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ú©Ø§Ù…Ù„</p>
</header>

<div class="container">

  <div class="box">
    <label for="langSelect">Ø²Ø¨Ø§Ù† / Ø§Ù„Ù„ØºØ©:</label>
    <select id="langSelect" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†">
      <option value="fa" selected>ÙØ§Ø±Ø³ÛŒ</option>
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>

  <div class="box">
    <label for="cityInput" id="cityLabel">Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§:</label>
    <input type="text" id="cityInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ ÛŒØ§ Ahvaz or Ø¨ØºØ¯Ø§Ø¯" aria-describedby="cityLabel" />
    <button id="fetchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
    <button id="geoBtn" title="ÛŒØ§ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
    <button id="themeToggle" title="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ— ØªÙ… ØªØ§Ø±ÛŒÚ©/Ø±ÙˆØ´Ù†</button>
  </div>

  <div class="box" id="weatherInfo" aria-live="polite" aria-atomic="true">
    Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø±ÙˆÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.
  </div>

  <div class="box">
    <h3 id="forecastTitle">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡</h3>
    <ul class="forecast-list" id="forecastList" role="list"></ul>
  </div>

  <div class="box chart-container">
    <canvas id="windChart" aria-label="Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯" role="img"></canvas>
  </div>

  <div class="box moon-phase" id="moonPhase"></div>

  <div class="box" id="map" aria-label="Ù†Ù‚Ø´Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª"></div>

  <div class="box">
    <button id="printBtn">Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6RpvmC9f9fEclXrbt2tyb13VGdZ8ktyTx8a+vY="
  crossorigin=""></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+Bk9saU4AyPXnfuUHXQxp3O4WmwXvXbDq2tjGq6Lk="
  crossorigin=""/>

<script>
  "use strict";

  // Ù…ØªÙ†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ùˆ Ø²Ø¨Ø§Ù†
  const texts = {
    fa: {
      title: "Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ - Ù¾ÛŒØ´Ø±ÙØªÙ‡",
      subtitle: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§ Ø¨Ø§ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ú©Ø§Ù…Ù„",
      langLabel: "Ø²Ø¨Ø§Ù† / Ø§Ù„Ù„ØºØ©:",
      cityLabel: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§:",
      cityPlaceholder: "Ù…Ø«Ù„Ø§Ù‹ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ ÛŒØ§ Ahvaz or Ø¨ØºØ¯Ø§Ø¯",
      search: "Ø¬Ø³ØªØ¬Ùˆ",
      locateMe: "ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†",
      toggleTheme: "ğŸŒ— ØªÙ… ØªØ§Ø±ÛŒÚ©/Ø±ÙˆØ´Ù†",
      forecastTitle: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡",
      windSpeed: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯",
      windDirection: "Ø¬Ù‡Øª Ø¨Ø§Ø¯",
      temperature: "Ø¯Ù…Ø§",
      humidity: "Ø±Ø·ÙˆØ¨Øª",
      pressure: "ÙØ´Ø§Ø±",
      visibility: "Ø¯ÛŒØ¯ Ø§ÙÙ‚ÛŒ",
      clouds: "Ø§Ø¨Ø±Ù‡Ø§",
      sunrise: "Ø·Ù„ÙˆØ¹ Ø®ÙˆØ±Ø´ÛŒØ¯",
      sunset: "ØºØ±ÙˆØ¨ Ø®ÙˆØ±Ø´ÛŒØ¯",
      moonPhase: "ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù‡",
      printReport: "Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´",
      errorCity: "âŒ Ø´Ù‡Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
      loading: "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...",
    },
    ar: {
      title: "Ø§Ù„Ø£Ø±ØµØ§Ø¯ Ø§Ù„Ø¬ÙˆÙŠØ© - ÙƒØ§Ø¸Ù…ÙŠ Ø¯Ùˆ",
      subtitle: "ØªÙˆÙ‚Ø¹Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª",
      langLabel: "Ø§Ù„Ù„ØºØ© / Ø²Ø¨Ø§Ù†:",
      cityLabel: "Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©:",
      cityPlaceholder: "Ù…Ø«Ù„Ø§Ù‹ ÙƒØ§Ø¸Ù…ÙŠ Ø¯Ùˆ Ø£Ùˆ Ahvaz Ø£Ùˆ Ø¨ØºØ¯Ø§Ø¯",
      search: "Ø¨Ø­Ø«",
      locateMe: "ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ",
      toggleTheme: "ğŸŒ— Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† / Ø§Ù„ÙØ§ØªØ­",
      forecastTitle: "ØªÙˆÙ‚Ø¹Ø§Øª Ù¥ Ø£ÙŠØ§Ù…",
      windSpeed: "Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­",
      windDirection: "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­",
      temperature: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
      humidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
      pressure: "Ø§Ù„Ø¶ØºØ·",
      visibility: "Ø§Ù„Ø±Ø¤ÙŠØ©",
      clouds: "Ø§Ù„Ø³Ø­Ø¨",
      sunrise: "Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³",
      sunset: "ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³",
      moonPhase: "Ø·ÙˆØ± Ø§Ù„Ù‚Ù…Ø±",
      printReport: "Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
      errorCity: "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù….",
      loading: "Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
    }
  };

  // Ø­Ø§Ù„Øª ØªÙ… (Ø±ÙˆØ´Ù†/ØªØ§Ø±ÛŒÚ©)
  const body = document.body;

  // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§
  const langSelect = document.getElementById("langSelect");
  const cityInput = document.getElementById("cityInput");
  const fetchBtn = document.getElementById("fetchBtn");
  const weatherInfo = document.getElementById("weatherInfo");
  const forecastList = document.getElementById("forecastList");
  const windChartCtx = document.getElementById("windChart").getContext("2d");
  const moonPhaseBox = document.getElementById("moonPhase");
  const mapDiv = document.getElementById("map");
  const geoBtn = document.getElementById("geoBtn");
  const themeToggleBtn = document.getElementById("themeToggle");
  const cityLabel = document.getElementById("cityLabel");
  const titleH1 = document.getElementById("title");
  const subtitleP = document.getElementById("subtitle");
  const printBtn = document.getElementById("printBtn");

  let currentLang = "fa";
  let currentChart = null;
  let currentCity = "Kazemi Do";
  let currentCoords = { lat: 31.2215, lon: 48.6037 }; // Ù…Ø®ØªØµØ§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú©Ø§Ø¸Ù…ÛŒ Ø¯Ùˆ

  // Ú©Ù„ÛŒØ¯ API
  const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";

  // Ù†Ù‚Ø´Ù‡ Leaflet
  let map = L.map(mapDiv).setView([currentCoords.lat, currentCoords.lon], 10);
  let marker = L.marker([currentCoords.lat, currentCoords.lon]).addTo(map);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù† Ø±Ø§Ø¨Ø·
  function updateLanguage() {
    currentLang = langSelect.value;
    titleH1.textContent = texts[currentLang].title;
    subtitleP.textContent = texts[currentLang].subtitle;
    cityLabel.textContent = texts[currentLang].cityLabel;
    cityInput.placeholder = texts[currentLang].cityPlaceholder;
    fetchBtn.textContent = texts[currentLang].search;
    geoBtn.textContent = texts[currentLang].locateMe;
    themeToggleBtn.textContent = texts[currentLang].toggleTheme;
    document.getElementById("forecastTitle").textContent = texts[currentLang].forecastTitle;
    printBtn.textContent = texts[currentLang].printReport;
    weatherInfo.textContent = texts[currentLang].loading;
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù‡ (moon phase) Ø§Ø² ØªØ§Ø±ÛŒØ® ÛŒÙˆÙ†ÛŒÚ©Ø³
  function getMoonPhase(date) {
    // https://www.subsystems.us/uploads/9/8/9/4/98948044/moonphase.pdf
    const lp = 2551443; // Ø·ÙˆÙ„ Ø¯ÙˆØ±Ù‡ Ù…Ø§Ù‡ Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡
    let now = date.getTime();
    let new_moon = new Date(1970, 0, 7, 20, 35, 0).getTime(); // ØªØ§Ø±ÛŒØ® Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ù…Ø§Ù‡ Ù†Ùˆ
    let phase = ((now - new_moon) / 1000) % lp;
    let phaseIndex = Math.floor((phase / lp) * 8);
    const phases = ["ğŸŒ‘", "ğŸŒ’", "ğŸŒ“", "ğŸŒ”", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜"];
    const namesFa = ["Ù…Ø§Ù‡ Ù†Ùˆ", "Ù‡Ù„Ø§Ù„ Ø§ÙˆÙ„", "Ø±Ø¨Ø¹ Ø§ÙˆÙ„", "Ù…Ø§Ù‡ Ù†ÛŒÙ…Ù‡", "Ù…Ø§Ù‡ Ú©Ø§Ù…Ù„", "Ø±Ø¨Ø¹ Ø¢Ø®Ø±", "Ù‡Ù„Ø§Ù„ Ø¢Ø®Ø±", "Ù…Ø§Ù‡ Ø±Ùˆ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù†"];
    const namesAr = ["Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯", "Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ù…Ù†ØªØµÙ", "Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ÙƒØ§Ù…Ù„", "Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®ÙŠØ±", "Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±", "Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ù…ØªÙ†Ø§Ù‚Øµ"];
    return {
      icon: phases[phaseIndex],
      name: currentLang === "fa" ? namesFa[phaseIndex] : namesAr[phaseIndex]
    };
  }

  // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯
  function drawWindChart(labels, speeds) {
    if (currentChart) currentChart.destroy();
    currentChart = new Chart(windChartCtx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: texts[currentLang].windSpeed + " (m/s)",
          data: speeds,
          fill: true,
          borderColor: "#0077cc",
          backgroundColor: "rgba(0, 119, 204, 0.2)",
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: texts[currentLang].windSpeed + " (m/s)" }
          },
          x: {
            ticks: { maxRotation: 90, minRotation: 45 }
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });
  }

  // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ
  function displayWeather(data) {
    const city = data.city;
    const list = data.list;

    currentCoords.lat = city.coord.lat;
    currentCoords.lon = city.coord.lon;

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù‚Ø´Ù‡
    map.setView([currentCoords.lat, currentCoords.lon], 10);
    marker.setLatLng([currentCoords.lat, currentCoords.lon]).bindPopup(city.name).openPopup();

    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ (Ø§Ú©Ù†ÙˆÙ†)
    const now = list[0];
    const dNow = new Date(now.dt * 1000);

    const moon = getMoonPhase(dNow);

    // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ
    let html = `
      <h2>${city.name}, ${city.country}</h2>
      <p>ğŸ“ ${currentCoords.lat.toFixed(4)}, ${currentCoords.lon.toFixed(4)}</p>
      <p>ğŸŒ¡ï¸ ${texts[currentLang].temperature}: ${now.main.temp} Â°C</p>
      <p>ğŸ’§ ${texts[currentLang].humidity}: ${now.main.humidity} %</p>
      <p>ğŸŒ¬ï¸ ${texts[currentLang].windSpeed}: ${now.wind.speed} m/s 
         <span class="wind-dir" style="transform: rotate(${now.wind.deg}deg)">ğŸ§­</span>
      </p>
      <p>ğŸ”† ${texts[currentLang].pressure}: ${now.main.pressure} hPa</p>
      <p>ğŸŒ«ï¸ ${texts[currentLang].visibility}: ${(now.visibility / 1000).toFixed(1)} km</p>
      <p>â˜ï¸ ${texts[currentLang].clouds}: ${now.clouds.all} %</p>
      <p>ğŸŒ… ${texts[currentLang].sunrise}: ${new Date(city.sunrise * 1000).toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG")}</p>
      <p>ğŸŒ‡ ${texts[currentLang].sunset}: ${new Date(city.sunset * 1000).toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG")}</p>
      <div class="moon-phase">${texts[currentLang].moonPhase}: <span>${moon.icon}</span> ${moon.name}</div>
      <p>âš™ï¸ ${now.weather[0].description} <img class="icon" src="https://openweathermap.org/img/wn/${now.weather[0].icon}@2x.png" alt="icon"/></p>
    `;

    weatherInfo.innerHTML = html;

    // Ù„ÛŒØ³Øª Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ 5 Ø±ÙˆØ²Ù‡ Ø³Ø§Ø¹ØªÛŒ
    forecastList.innerHTML = "";
    let labels = [], speeds = [];

    list.forEach(item => {
      const dt = new Date(item.dt * 1000);
      const timeStr = dt.toLocaleString(currentLang === "fa" ? "fa-IR" : "ar-EG", {
        weekday: "short", hour: "2-digit", minute: "2-digit"
      });

      labels.push(timeStr);
      speeds.push(item.wind.speed);

      const li = document.createElement("li");
      li.innerHTML = `
        <div><strong>${timeStr}</strong></div>
        <div>${texts[currentLang].temperature}: ${item.main.temp}Â°C</div>
        <div>${texts[currentLang].windSpeed}: ${item.wind.speed} m/s
          <span class="wind-dir" style="transform: rotate(${item.wind.deg}deg)">ğŸ§­</span>
        </div>
      `;
      forecastList.appendChild(li);
    });

    drawWindChart(labels, speeds);
  }

  // ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  async function fetchWeatherData(cityName) {
    weatherInfo.textContent = texts[currentLang].loading;
    forecastList.innerHTML = "";
    try {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(cityName)}&appid=${apiKey}&units=metric&lang=${currentLang}`
      );
      if (!response.ok) throw new Error("city not found");
      const data = await response.json();
      displayWeather(data);
    } catch (error) {
      weatherInfo.textContent = texts[currentLang].errorCity;
      forecastList.innerHTML = "";
    }
  }

  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
  function getGeolocation() {
    if (!navigator.geolocation) {
      alert(currentLang === "fa" ? "Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetchWeatherByCoords(lat, lon);
      },
      () => {
        alert(currentLang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª." : "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
      }
    );
  }

  async function fetchWeatherByCoords(lat, lon) {
    weatherInfo.textContent = texts[currentLang].loading;
    forecastList.innerHTML = "";
    try {
      const response = await fetch(
        `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${currentLang}`
      );
      if (!response.ok) throw new Error("location not found");
      const data = await response.json();
      displayWeather(data);
    } catch (error) {
      weatherInfo.textContent = texts[currentLang].errorCity;
      forecastList.innerHTML = "";
    }
  }

  // Ø°Ø®ÛŒØ±Ù‡ Ø²Ø¨Ø§Ù† Ùˆ Ø´Ù‡Ø± Ø¯Ø± localStorage
  function saveSettings() {
    localStorage.setItem("weatherLang", currentLang);
    localStorage.setItem("weatherCity", cityInput.value || currentCity);
  }

  function loadSettings() {
    const lang = localStorage.getItem("weatherLang");
    const city = localStorage.getItem("weatherCity");
    if (lang && (lang === "fa" || lang === "ar")) {
      langSelect.value = lang;
      currentLang = lang;
    }
    if (city) {
      cityInput.value = city;
      currentCity = city;
    }
  }

  // ØªØºÛŒÛŒØ± ØªÙ…
  function toggleTheme() {
    body.classList.toggle("dark");
  }

  // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
  langSelect.addEventListener("change", () => {
    updateLanguage();
    saveSettings();
    fetchWeatherData(cityInput.value || currentCity);
  });
  fetchBtn.addEventListener("click", () => {
    currentCity = cityInput.value || currentCity;
    fetchWeatherData(currentCity);
    saveSettings();
  });
  geoBtn.addEventListener("click", getGeolocation);
  themeToggleBtn.addEventListener("click", () => {
    toggleTheme();
    saveSettings();
  });
  printBtn.addEventListener("click", () => window.print());

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
  loadSettings();
  updateLanguage();
  fetchWeatherData(currentCity);

</script>

</body>
</html>
