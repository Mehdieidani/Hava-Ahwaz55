<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
<style>
  body {
    font-family: sans-serif;
    background: #0077b6;
    color: #fff;
    margin: 0;
    padding: 0;
    direction: rtl;
  }
  header {
    background: linear-gradient(to left, #023e8a, #0096c7);
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    position: relative;
  }
  #language-toggle {
    position: absolute;
    left: 1rem;
    top: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  #search-container {
    padding: 1rem;
    text-align: center;
  }
  #searchInput {
    padding: 0.5rem;
    width: 50%;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
    max-width: 400px;
  }
  #searchBtn {
    padding: 0.5rem 1rem;
    border-radius: 5px;
    border: none;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
    margin-right: 10px;
  }
  #get-location {
    padding: 0.5rem 1rem;
    border-radius: 5px;
    border: none;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
  }
  #forecast {
    max-width: 900px;
    margin: 1rem auto;
    padding: 0 1rem;
  }
  .city-header {
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    position: relative;
    padding-left: 40px;
    user-select: none;
  }
  .star {
    position: absolute;
    left: 0;
    top: 0;
    font-size: 2.2rem;
    color: gold;
    cursor: pointer;
    user-select: none;
  }
  .day {
    background: #023047;
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
  }
  .day-section {
    background: #0077b6;
    margin-top: 10px;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #fffbf5;
  }
  .day-section div {
    flex: 1;
    text-align: center;
  }
  .day-section img {
    width: 72px;
    height: 72px;
    vertical-align: middle;
  }
  #comments-section {
    max-width: 900px;
    margin: 2rem auto;
    background: #023047;
    border-radius: 8px;
    padding: 1rem;
  }
  #commentInput {
    width: 100%;
    height: 80px;
    border-radius: 5px;
    border: none;
    padding: 0.5rem;
    resize: vertical;
    font-size: 1rem;
  }
  #submitComment {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
  }
  #commentsContainer {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
    color: #fff;
  }
  footer {
    text-align: center;
    padding: 1rem;
    color: #ddd;
    background: #010a13;
    margin-top: 2rem;
  }
  a {
    color: #ffb703;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  #date-display {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: bold;
    color: #ffb703;
  }
</style>
</head>
<body>
<header>
  <div id="header-title">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§</div>
  <button id="language-toggle">AR</button>
</header>

<div id="search-container">
  <input type="text" id="searchInput" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." />
  <button id="searchBtn">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
  <button id="get-location">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
  <div id="date-display"></div>
</div>

<div id="forecast"></div>

<div id="comments-section">
  <h3 id="comments-title">Ù†Ø¸Ø±Ø§Øª Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</h3>
  <textarea id="commentInput" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
  <br />
  <button id="submitComment">Ø§Ø±Ø³Ø§Ù„</button>
  <div id="commentsContainer"></div>
</div>

<footer>
  ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§: <a href="tel:09332356547">09332356547</a> |
  Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a> |
  Ø§ÛŒÙ…ÛŒÙ„: <a href="mailto:mehdi1eidani@gmail.com">mehdi1eidani@gmail.com</a><br />
  ØªÙ…Ø§Ù… Ø­Ù‚ÙˆÙ‚ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Mehdi Eidani Ø§Ø³Øª
</footer>

<script>
// ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
// Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ js-jalaali (Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ú©Ø§Ù…Ù†Øª)
// Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ØªØ§Ø¨Ø¹ Ú©ÙˆØªØ§Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø±Ø§ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³ÛŒÙ…
// Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù…Ù„ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù… ÙˆÙ„ÛŒ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ Ø®ÙˆØ¨ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

function toJalaali(gy, gm, gd) {
  // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ (Ø®Ù„Ø§ØµÙ‡ Ùˆ Ø³Ø§Ø¯Ù‡)
  const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
  let jy, jm, jd, gy2, days;

  gy2 = (gm > 2) ? (gy + 1) : gy;
  days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) + gd + g_d_m[gm -1];
  jy = -1595 + (33 * Math.floor(days / 12053));
  days %= 12053;
  jy += 4 * Math.floor(days / 1461);
  days %= 1461;
  if(days > 365){
    jy += Math.floor((days - 1) / 365);
    days = (days -1) % 365;
  }
  if(days < 186){
    jm = 1 + Math.floor(days / 31);
    jd = 1 + (days % 31);
  } else {
    jm = 7 + Math.floor((days - 186) / 30);
    jd = 1 + ((days -186) % 30);
  }
  return [jy, jm, jd];
}

// Ø¢Ø±Ø§ÛŒÙ‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¹Ø±Ø¨ÛŒ
const weekdaysFa = ["ÛŒÚ©Ø´Ù†Ø¨Ù‡","Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡"];
const weekdaysAr = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

const langToggle = document.getElementById("language-toggle");
const headerTitle = document.getElementById("header-title");
const searchInput = document.getElementById("searchInput");
const forecastDiv = document.getElementById("forecast");
const getLocationBtn = document.getElementById("get-location");
const searchBtn = document.getElementById("searchBtn");
const dateDisplay = document.getElementById("date-display");
const commentInput = document.getElementById("commentInput");
const submitCommentBtn = document.getElementById("submitComment");
const commentsContainer = document.getElementById("commentsContainer");
const commentsTitle = document.getElementById("comments-title");

let lang = "fa";

const translations = {
  fa: {
    header: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§",
    placeholder: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...",
    locationBtn: "ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†",
    commentsTitle: "Ù†Ø¸Ø±Ø§Øª Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª",
    commentPlaceholder: "Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...",
    sendBtn: "Ø§Ø±Ø³Ø§Ù„",
    alertEmptyComment: "Ù„Ø·ÙØ§ ÛŒÚ© Ù†Ø¸Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.",
    alertCommentSaved: "Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.",
    errorFetch: "â— Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
    wind: "Ø¨Ø§Ø¯",
    windSpeed: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯",
    windDirection: "Ø¬Ù‡Øª Ø¨Ø§Ø¯",
    precipitation: "Ù†Ø³Ø¨Øª Ø¨Ø§Ø±Ù†Ø¯Ú¯ÛŒ",
    tempMax: "Ø¯Ù…Ø§ÛŒ Ø¨ÛŒØ´ÛŒÙ†Ù‡ (Ø±ÙˆØ²)",
    tempMin: "Ø¯Ù…Ø§ÛŒ Ú©Ù…ÛŒÙ†Ù‡ (Ø´Ø¨)",
    favoriteAdded: "Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.",
    favoriteRemoved: "Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯.",
    humidity: "Ø±Ø·ÙˆØ¨Øª",
    pressure: "ÙØ´Ø§Ø±",
    status: "ÙˆØ¶Ø¹ÛŒØª",
    hour: "Ø³Ø§Ø¹Øª",
    temp: "Ø¯Ù…Ø§",
    cityPlaceholder: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...",
    favoriteCityTitle: "Ø´Ù‡Ø± Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯:",
    favoriteBtnTitle: "Ø³ØªØ§Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ",
  },
  ar: {
    header: "ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø·Ù‚Ø³",
    placeholder: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©...",
    locationBtn: "ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ",
    commentsTitle: "Ø¢Ø±Ø§Ø¡ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª",
    commentPlaceholder: "Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§...",
    sendBtn: "Ø¥Ø±Ø³Ø§Ù„",
    alertEmptyComment: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ¹Ù„ÙŠÙ‚.",
    alertCommentSaved: "ØªÙ… Ø­ÙØ¸ ØªØ¹Ù„ÙŠÙ‚Ùƒ.",
    errorFetch: "â— Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
    wind: "Ø§Ù„Ø±ÙŠØ§Ø­",
    windSpeed: "Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­",
    windDirection: "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­",
    precipitation: "Ù†Ø³Ø¨Ø© Ø§Ù„Ù‡Ø·ÙˆÙ„",
    tempMax: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¹Ø¸Ù…Ù‰ (Ù†Ù‡Ø§Ø±Ù‹Ø§)",
    tempMin: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„ØµØºØ±Ù‰ (Ù„ÙŠÙ„Ù‹Ø§)",
    favoriteAdded: "Ø£ÙØ¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©.",
    favoriteRemoved: "ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.",
    humidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
    pressure: "Ø§Ù„Ø¶ØºØ·",
    status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    hour: "Ø§Ù„Ø³Ø§Ø¹Ø©",
    temp: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
    cityPlaceholder: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©...",
    favoriteCityTitle: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©:",
    favoriteBtnTitle: "Ù†Ø¬Ù…Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©",
  }
};

function windDirection(deg) {
  const directions = lang === "fa"
    ? ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨"]
    : ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„ ØºØ±Ø¨"];
  return directions[Math.round(deg / 45) % 8];
}

function toggleLanguage() {
  lang = lang === "fa" ? "ar" : "fa";
  langToggle.textContent = lang === "fa" ? "AR" : "FA";
  headerTitle.textContent = translations[lang].header;
  searchInput.placeholder = translations[lang].placeholder;
  getLocationBtn.textContent = translations[lang].locationBtn;
  commentsTitle.textContent = translations[lang].commentsTitle;
  commentInput.placeholder = translations[lang].commentPlaceholder;
  submitCommentBtn.textContent = translations[lang].sendBtn;
  searchBtn.textContent = lang === "fa" ? "ğŸ” Ø¬Ø³ØªØ¬Ùˆ" : "ğŸ” Ø¨Ø­Ø«";
  updateDateDisplay();
  if (searchInput.value.trim() !== "") {
    fetchWeather(searchInput.value.trim());
  }
  renderFavoriteStar();
}

langToggle.addEventListener("click", toggleLanguage);

function saveFavoriteCity(city) {
  localStorage.setItem("favorite_city", city);
}

function getFavoriteCity() {
  return localStorage.getItem("favorite_city") || null;
}

function removeFavoriteCity() {
  localStorage.removeItem("favorite_city");
}

function renderFavoriteStar() {
  const city = searchInput.value.trim();
  const star = document.querySelector(".city-header .star");
  if (!star) return;
  if (city && getFavoriteCity() === city) {
    star.textContent = "â˜…";
    star.title = translations[lang].favoriteBtnTitle + " (Ø­Ø°Ù)";
  } else {
    star.textContent = "â˜†";
    star.title = translations[lang].favoriteBtnTitle + " (Ø§ÙØ²ÙˆØ¯Ù†)";
  }
}

function toggleFavoriteCity(starEl) {
  const city = searchInput.value.trim();
  if (!city) return alert(lang === "fa" ? "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯." : "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.");
  if (getFavoriteCity() === city) {
    removeFavoriteCity();
    starEl.textContent = "â˜†";
    alert(translations[lang].favoriteRemoved);
  } else {
    saveFavoriteCity(city);
    starEl.textContent = "â˜…";
    alert(translations[lang].favoriteAdded);
  }
}

async function fetchWeather(city) {
  forecastDiv.innerHTML = lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª..." : "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric&lang=${lang}`);
    const data = await res.json();
    if (!data.list) throw new Error();
    searchInput.value = data.city.name;
    displayForecast(data.list);
  } catch {
    forecastDiv.innerHTML = translations[lang].errorFetch;
  }
}

function displayForecast(list) {
  // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆØ²
  const days = {};
  list.forEach(item => {
    const day = item.dt_txt.split(" ")[0];
    if (!days[day]) days[day] = [];
    days[day].push(item);
  });

  forecastDiv.innerHTML = "";

  // Ø¹Ù†ÙˆØ§Ù† Ø´Ù‡Ø± Ø¨Ø§ Ø³ØªØ§Ø±Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ
  const cityName = searchInput.value.trim();
  const favStar = getFavoriteCity() === cityName ? "â˜…" : "â˜†";

  const cityHeader = document.createElement("div");
  cityHeader.className = "city-header";
  cityHeader.innerHTML = `
    ${cityName}
    <span class="star" title="${translations[lang].favoriteBtnTitle}">${favStar}</span>
  `;
  forecastDiv.appendChild(cityHeader);

  // Ø³ØªØ§Ø±Ù‡ Ú©Ù„ÛŒÚ©
  cityHeader.querySelector(".star").addEventListener("click", function(){
    toggleFavoriteCity(this);
  });

  Object.keys(days).slice(0, 5).forEach(day => {
    const dayItems = days[day];
    // Ø¨ÛŒØ´ÛŒÙ†Ù‡ Ø¯Ù…Ø§ Ø¯Ø± Ø±ÙˆØ² (Ø­Ø¯ÙˆØ¯ 06:00 ØªØ§ 18:00)
    const dayTemps = dayItems.filter(i => {
      const hour = +i.dt_txt.split(" ")[1].slice(0,2);
      return hour >= 6 && hour < 18;
    });
    const maxDayTemp = dayTemps.length ? Math.max(...dayTemps.map(i => i.main.temp_max)) : null;
    const dayIcon = dayTemps.length ? dayTemps[0].weather[0].icon : "01d";
    const dayDesc = dayTemps.length ? dayTemps[0].weather[0].description : "";

    // Ú©Ù…ÛŒÙ†Ù‡ Ø¯Ù…Ø§ Ø¯Ø± Ø´Ø¨ (18:00 ØªØ§ 06:00 Ø±ÙˆØ² Ø¨Ø¹Ø¯)
    const nightTemps = dayItems.filter(i => {
      const hour = +i.dt_txt.split(" ")[1].slice(0,2);
      return hour >= 18 || hour < 6;
    });
    const minNightTemp = nightTemps.length ? Math.min(...nightTemps.map(i => i.main.temp_min)) : null;
    const nightIcon = nightTemps.length ? nightTemps[0].weather[0].icon : "01n";
    const nightDesc = nightTemps.length ? nightTemps[0].weather[0].description : "";

    // Ù…Ù‚Ø¯Ø§Ø± Ø±Ø·ÙˆØ¨ØªØŒ ÙØ´Ø§Ø±ØŒ Ø¨Ø§Ø±Ù†Ø¯Ú¯ÛŒØŒ Ø¨Ø§Ø¯ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡ Ø±ÙˆØ²
    const firstItem = dayItems[0];
    const humidity = firstItem.main.humidity;
    const pressure = firstItem.main.pressure;
    const rain = firstItem.rain ? firstItem.rain["3h"] || 0 : 0;
    const windSpeed = firstItem.wind.speed;
    const windDeg = firstItem.wind.deg;
    const windDir = windDirection(windDeg);

    // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ùˆ Ø§ÛŒØ§Ù… Ù‡ÙØªÙ‡ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ lang Ùˆ Ø±ÙˆØ² Ù…ÛŒÙ„Ø§Ø¯ÛŒ
    const dateParts = day.split("-");
    const gy = parseInt(dateParts[0], 10);
    const gm = parseInt(dateParts[1], 10);
    const gd = parseInt(dateParts[2], 10);

    const [jy, jm, jd] = toJalaali(gy, gm, gd);

    const jsWeekdayIndex = new Date(gy, gm -1, gd).getDay(); // 0 ÛŒÚ©Ø´Ù†Ø¨Ù‡ Ø¯Ø± Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø³Øª
    // Ú†ÙˆÙ† Ù…Ø§ Ù‡ÙØªÙ‡ Ø±Ø§ Ø´Ù†Ø¨Ù‡ ØªØ§ Ø¬Ù…Ø¹Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ ÙˆÙ„ÛŒ JS Ø´Ù†Ø¨Ù‡=6 Ù†ÛŒØ³ØªØŒ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
    // Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¹Ø±Ø¨ÛŒ Ø§Ø² Ø§ÛŒØ§Ù… Ù‡ÙØªÙ‡ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ…:
    // jsWeekdayIndex: 0 = Sunday = ÛŒÚ©Ø´Ù†Ø¨Ù‡/Ø§Ù„Ø£Ø­Ø¯

    const weekdayFa = weekdaysFa[jsWeekdayIndex];
    const weekdayAr = weekdaysAr[jsWeekdayIndex];

    const displayWeekday = lang === "fa" ? weekdayFa : weekdayAr;
    const displayDate = `${jy}/${jm.toString().padStart(2,"0")}/${jd.toString().padStart(2,"0")}`;

    const dayDiv = document.createElement("div");
    dayDiv.className = "day";

    dayDiv.innerHTML = `
      <div><strong>${lang === "fa" ? "Ø±ÙˆØ²" : "Ø§Ù„ÙŠÙˆÙ…"}: ${displayWeekday} - ${displayDate}</strong></div>
      <div class="day-section" title="${dayDesc}">
        <div>
          <div>${translations[lang].tempMax}</div>
          <img src="https://openweathermap.org/img/wn/${dayIcon}@2x.png" alt="${dayDesc}" />
          <div>${maxDayTemp !== null ? maxDayTemp.toFixed(1) + "Â°C" : "-"}</div>
          <div>${translations[lang].status}: ${dayDesc}</div>
        </div>
      </div>
      <div class="day-section" title="${nightDesc}">
        <div>
          <div>${translations[lang].tempMin}</div>
          <img src="https://openweathermap.org/img/wn/${nightIcon}@2x.png" alt="${nightDesc}" />
          <div>${minNightTemp !== null ? minNightTemp.toFixed(1) + "Â°C" : "-"}</div>
          <div>${translations[lang].status}: ${nightDesc}</div>
        </div>
      </div>
      <div class="day-section" style="background:#0096c7; font-size: 0.95rem; flex-wrap: wrap; justify-content: center;">
        <div>${translations[lang].humidity}: ${humidity}%</div>
        <div>${translations[lang].pressure}: ${pressure} hPa</div>
        <div>${translations[lang].precipitation}: ${rain} mm</div>
        <div>${translations[lang].windSpeed}: ${windSpeed} m/s</div>
        <div>${translations[lang].windDirection}: ${windDir}</div>
      </div>
    `;

    forecastDiv.appendChild(dayDiv);
  });
}

// Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Enter
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const city = searchInput.value.trim();
    if (city) fetchWeather(city);
  }
});

// Ø¯Ú©Ù…Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù„ÛŒÚ©
searchBtn.addEventListener("click", () => {
  const city = searchInput.value.trim();
  if (city) fetchWeather(city);
});

// Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†
getLocationBtn.addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert(lang === "fa" ? "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² GPS Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯." : "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS.");
    return;
  }
  navigator.geolocation.getCurrentPosition(position => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${lang}`)
      .then(res => res.json())
      .then(data => {
        if (!data.list) throw new Error();
        searchInput.value = data.city.name;
        displayForecast(data.list);
      })
      .catch(() => {
        alert(lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª." : "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
      });
  }, () => {
    alert(lang === "fa" ? "Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø¯ Ø´Ø¯." : "ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.");
  });
});

// Ù†Ø¸Ø±Ø§Øª
function loadComments() {
  const comments = JSON.parse(localStorage.getItem("comments") || "[]");
  commentsContainer.innerHTML = "";
  comments.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.textContent = c;
    commentsContainer.appendChild(div);
  });
}

submitCommentBtn.addEventListener("click", () => {
  const comment = commentInput.value.trim();
  if (!comment) {
    alert(translations[lang].alertEmptyComment);
    return;
  }
  const comments = JSON.parse(localStorage.getItem("comments") || "[]");
  comments.push(comment);
  localStorage.setItem("comments", JSON.stringify(comments));
  commentInput.value = "";
  loadComments();
  alert(translations[lang].alertCommentSaved);
});

function updateDateDisplay(){
  const now = new Date();
  const gy = now.getFullYear();
  const gm = now.getMonth() + 1;
  const gd = now.getDate();
  const [jy, jm, jd] = toJalaali(gy, gm, gd);
  const jsWeekdayIndex = now.getDay();
  const weekdayFa = weekdaysFa[jsWeekdayIndex];
  const weekdayAr = weekdaysAr[jsWeekdayIndex];
  dateDisplay.textContent = lang === "fa" ? `Ø§Ù…Ø±ÙˆØ²: ${weekdayFa} - ${jy}/${jm.toString().padStart(2,"0")}/${jd.toString().padStart(2,"0")}` : `Ø§Ù„ÙŠÙˆÙ…: ${weekdayAr} - ${jy}/${jm.toString().padStart(2,"0")}/${jd.toString().padStart(2,"0")}`;
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
const apiKey = "dc9c93f51cdd375d459483c2a9f86d88";

loadComments();
updateDateDisplay();
fetchWeather("Ø§Ù‡ÙˆØ§Ø²");
</script>
</body>
</html>
