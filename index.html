<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>هواشناسی پیشرفته</title>
<style>
  body {
    font-family: sans-serif;
    background: #0077b6;
    color: #fff;
    margin: 0;
    padding: 0;
    direction: rtl;
  }
  header {
    background: linear-gradient(to left, #023e8a, #0096c7);
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    position: relative;
  }
  #language-toggle {
    position: absolute;
    left: 1rem;
    top: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  #search-container {
    padding: 1rem;
    text-align: center;
  }
  #searchInput {
    padding: 0.5rem;
    width: 50%;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
    max-width: 400px;
  }
  #searchBtn {
    padding: 0.5rem 1rem;
    border-radius: 5px;
    border: none;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
    margin-right: 10px;
  }
  #get-location {
    padding: 0.5rem 1rem;
    border-radius: 5px;
    border: none;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
  }
  #forecast {
    max-width: 900px;
    margin: 1rem auto;
    padding: 0 1rem;
  }
  .city-header {
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    position: relative;
    padding-left: 40px;
    user-select: none;
  }
  .star {
    position: absolute;
    left: 0;
    top: 0;
    font-size: 2.2rem;
    color: gold;
    cursor: pointer;
    user-select: none;
  }
  .day {
    background: #023047;
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
  }
  .day-section {
    background: #0077b6;
    margin-top: 10px;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #fffbf5;
  }
  .day-section div {
    flex: 1;
    text-align: center;
  }
  .day-section img {
    width: 72px;
    height: 72px;
    vertical-align: middle;
  }
  #comments-section {
    max-width: 900px;
    margin: 2rem auto;
    background: #023047;
    border-radius: 8px;
    padding: 1rem;
  }
  #commentInput {
    width: 100%;
    height: 80px;
    border-radius: 5px;
    border: none;
    padding: 0.5rem;
    resize: vertical;
    font-size: 1rem;
  }
  #submitComment {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
    font-weight: bold;
  }
  #commentsContainer {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
    color: #fff;
  }
  footer {
    text-align: center;
    padding: 1rem;
    color: #ddd;
    background: #010a13;
    margin-top: 2rem;
  }
  a {
    color: #ffb703;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  #date-display {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: bold;
    color: #ffb703;
  }

  /* استایل تبلیغ تمام صفحه */
  #splash-ad {
    position: fixed;
    top: 0; right: 0; bottom: 0; left: 0;
    background: #023047 url('https://via.placeholder.com/600x400?text=تبلیغ+شما') center center no-repeat;
    background-size: contain;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    user-select: none;
    flex-direction: column;
  }
  #splash-ad button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1.2rem;
    border: none;
    border-radius: 8px;
    background: #ffb703;
    color: #023047;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- تبلیغ تمام صفحه -->
<div id="splash-ad">
  <div>تبلیغ ویژه شما اینجا</div>
  <button id="skipAdBtn">رد کردن تبلیغ</button>
</div>

<header>
  <div id="header-title">پیش‌بینی آب‌وهوا</div>
  <button id="language-toggle">AR</button>
</header>

<div id="search-container">
  <input type="text" id="searchInput" placeholder="نام شهر یا روستا را وارد کنید..." />
  <button id="searchBtn">🔍 جستجو</button>
  <button id="get-location">📍 موقعیت من</button>
  <div id="date-display"></div>
</div>

<div id="forecast"></div>

<div id="comments-section">
  <h3 id="comments-title">نظرات و پیشنهادات</h3>
  <textarea id="commentInput" placeholder="نظر خود را اینجا بنویسید..."></textarea>
  <br />
  <button id="submitComment">ارسال</button>
  <div id="commentsContainer"></div>
</div>

<footer>
  تماس با ما: <a href="tel:09332356547">09332356547</a> |
  اینستاگرام: <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a> |
  ایمیل: <a href="mailto:mehdi1eidani@gmail.com">mehdi1eidani@gmail.com</a><br />
  تمام حقوق متعلق به Mehdi Eidani است
</footer>

<script>
// --- اسکریپت تبلیغ ---
const splashAd = document.getElementById('splash-ad');
const skipBtn = document.getElementById('skipAdBtn');
const adTimeout = setTimeout(() => {
  splashAd.style.display = 'none';
}, 5000);
skipBtn.addEventListener('click', () => {
  clearTimeout(adTimeout);
  splashAd.style.display = 'none';
});

// --- کدهای هواشناسی ---

function toJalaali(gy, gm, gd) {
  const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
  let jy, jm, jd, gy2, days;

  gy2 = (gm > 2) ? (gy + 1) : gy;
  days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) + gd + g_d_m[gm -1];
  jy = -1595 + (33 * Math.floor(days / 12053));
  days %= 12053;
  jy += 4 * Math.floor(days / 1461);
  days %= 1461;
  if(days > 365){
    jy += Math.floor((days - 1) / 365);
    days = (days -1) % 365;
  }
  if(days < 186){
    jm = 1 + Math.floor(days / 31);
    jd = 1 + (days % 31);
  } else {
    jm = 7 + Math.floor((days - 186) / 30);
    jd = 1 + ((days -186) % 30);
  }
  return [jy, jm, jd];
}

const weekdaysFa = ["یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنج‌شنبه","جمعه","شنبه"];
const weekdaysAr = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];

const langToggle = document.getElementById("language-toggle");
const headerTitle = document.getElementById("header-title");
const searchInput = document.getElementById("searchInput");
const forecastDiv = document.getElementById("forecast");
const getLocationBtn = document.getElementById("get-location");
const searchBtn = document.getElementById("searchBtn");
const dateDisplay = document.getElementById("date-display");
const commentInput = document.getElementById("commentInput");
const submitCommentBtn = document.getElementById("submitComment");
const commentsContainer = document.getElementById("commentsContainer");
const commentsTitle = document.getElementById("comments-title");

let lang = "fa";

const translations = {
  fa: {
    header: "پیش‌بینی آب‌وهوا",
    placeholder: "نام شهر یا روستا را وارد کنید...",
    locationBtn: "📍 موقعیت من",
    commentsTitle: "نظرات و پیشنهادات",
    commentPlaceholder: "نظر خود را اینجا بنویسید...",
    sendBtn: "ارسال",
    alertEmptyComment: "لطفا یک نظر وارد کنید.",
    alertCommentSaved: "نظر شما ثبت شد.",
    errorFetch: "❗ خطا در دریافت اطلاعات، دوباره تلاش کنید.",
    wind: "باد",
    windSpeed: "سرعت باد",
    windDirection: "جهت باد",
    precipitation: "نسبت بارندگی",
    tempMax: "دمای بیشینه (روز)",
    tempMin: "دمای کمینه (شب)",
    favoriteAdded: "به علاقه‌مندی‌ها اضافه شد.",
    favoriteRemoved: "از علاقه‌مندی‌ها حذف شد.",
    humidity: "رطوبت",
    pressure: "فشار",
    status: "وضعیت",
    hour: "ساعت",
    temp: "دما",
    cityPlaceholder: "نام شهر یا روستا را وارد کنید...",
    favoriteCityTitle: "شهر علاقه‌مند:",
    favoriteBtnTitle: "ستاره برای علاقه‌مندی",
  },
  ar: {
    header: "توقعات الطقس",
    placeholder: "أدخل اسم المدينة أو القرية...",
    locationBtn: "📍 موقعي",
    commentsTitle: "آراء وملاحظات",
    commentPlaceholder: "اكتب تعليقك هنا...",
    sendBtn: "إرسال",
    alertEmptyComment: "يرجى إدخال تعليق.",
    alertCommentSaved: "تم حفظ تعليقك.",
    errorFetch: "❗ خطأ في تحميل البيانات، حاول مرة أخرى.",
    wind: "الرياح",
    windSpeed: "سرعة الرياح",
    windDirection: "اتجاه الرياح",
    precipitation: "نسبة الهطول",
    tempMax: "درجة الحرارة العظمى (نهارًا)",
    tempMin: "درجة الحرارة الصغرى (ليلًا)",
    favoriteAdded: "أُضيف إلى المفضلة.",
    favoriteRemoved: "تم الحذف من المفضلة.",
    humidity: "الرطوبة",
    pressure: "الضغط",
    status: "الحالة",
    hour: "الساعة",
    temp: "درجة الحرارة",
    cityPlaceholder: "أدخل اسم المدينة أو القرية...",
    favoriteCityTitle: "المدينة المفضلة:",
    favoriteBtnTitle: "نجمة للإضافة للمفضلة",
  }
};

function windDirection(deg) {
  const directions = lang === "fa"
    ? ["شمال", "شمال‌شرق", "شرق", "جنوب‌شرق", "جنوب", "جنوب‌غرب", "غرب", "شمال‌غرب"]
    : ["شمال", "شمال شرق", "شرق", "جنوب شرق", "جنوب", "جنوب غرب", "غرب", "شمال غرب"];
  return directions[Math.round(deg / 45) % 8];
}

function toggleLanguage() {
  lang = lang === "fa" ? "ar" : "fa";
  langToggle.textContent = lang === "fa" ? "AR" : "FA";
  headerTitle.textContent = translations[lang].header;
  searchInput.placeholder = translations[lang].placeholder;
  getLocationBtn.textContent = translations[lang].locationBtn;
  commentsTitle.textContent = translations[lang].commentsTitle;
  commentInput.placeholder = translations[lang].commentPlaceholder;
  submitCommentBtn.textContent = translations[lang].sendBtn;
  searchBtn.textContent = lang === "fa" ? "🔍 جستجو" : "🔍 بحث";
  updateDateDisplay();
  if (searchInput.value.trim() !== "") {
    fetchWeather(searchInput.value.trim());
  }
  renderFavoriteStar();
}

langToggle.addEventListener("click", toggleLanguage);

function saveFavoriteCity(city) {
  localStorage.setItem("favorite_city", city);
}

function getFavoriteCity() {
  return localStorage.getItem("favorite_city") || null;
}

function removeFavoriteCity() {
  localStorage.removeItem("favorite_city");
}

function renderFavoriteStar() {
  const city = searchInput.value.trim();
  const star = document.querySelector(".city-header .star");
  if (!star) return;
  if (city && getFavoriteCity() === city) {
    star.textContent = "★";
    star.title = translations[lang].favoriteBtnTitle + " (حذف)";
  } else {
    star.textContent = "☆";
    star.title = translations[lang].favoriteBtnTitle + " (افزودن)";
  }
}

function toggleFavoriteCity(starEl) {
  const city = searchInput.value.trim();
  if (!city) return alert(lang === "fa" ? "لطفا نام شهر را وارد کنید." : "يرجى إدخال اسم المدينة.");
  if (getFavoriteCity() === city) {
    removeFavoriteCity();
    starEl.textContent = "☆";
    alert(translations[lang].favoriteRemoved);
  } else {
    saveFavoriteCity(city);
    starEl.textContent = "★";
    alert(translations[lang].favoriteAdded);
  }
}

async function fetchWeather(city) {
  forecastDiv.innerHTML = lang === "fa" ? "در حال دریافت اطلاعات..." : "جارٍ تحميل البيانات...";
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric&lang=${lang}`);
    const data = await res.json();
    if (!data.list) throw new Error();
    searchInput.value = data.city.name;
    displayForecast(data.list);
  } catch {
    forecastDiv.innerHTML = translations[lang].errorFetch;
  }
}

function displayForecast(list) {
  const days = {};
  list.forEach(item => {
    const day = item.dt_txt.split(" ")[0];
    if (!days[day]) days[day] = [];
    days[day].push(item);
  });

  forecastDiv.innerHTML = "";

  const cityName = searchInput.value.trim();
  const favStar = getFavoriteCity() === cityName ? "★" : "☆";

  const cityHeader = document.createElement("div");
  cityHeader.className = "city-header";
  cityHeader.innerHTML = `
    ${cityName}
    <span class="star" title="${translations[lang].favoriteBtnTitle}">${favStar}</span>
  `;
  forecastDiv.appendChild(cityHeader);

  cityHeader.querySelector(".star").addEventListener("click", function(){
    toggleFavoriteCity(this);
  });

  Object.keys(days).slice(0, 5).forEach(day => {
    const dayItems = days[day];
    const dayTemps = dayItems.filter(i => {
      const hour = +i.dt_txt.split(" ")[1].slice(0,2);
      return hour >= 6 && hour < 18;
    });
    const maxDayTemp = dayTemps.length ? Math.max(...dayTemps.map(i => i.main.temp_max)) : null;
    const dayIcon = dayTemps.length ? dayTemps[0].weather[0].icon : "01d";
    const dayDesc = dayTemps.length ? dayTemps[0].weather[0].description : "";

    const nightTemps = dayItems.filter(i => {
      const hour = +i.dt_txt.split(" ")[1].slice(0,2);
      return hour >= 18 || hour < 6;
    });
    const minNightTemp = nightTemps.length ? Math.min(...nightTemps.map(i => i.main.temp_min)) : null;
    const nightIcon = nightTemps.length ? nightTemps[0].weather[0].icon : "01n";
    const nightDesc = nightTemps.length ? nightTemps[0].weather[0].description : "";

    const firstItem = dayItems[0];
    const humidity = firstItem.main.humidity;
    const pressure = firstItem.main.pressure;
    const rain = firstItem.rain ? firstItem.rain["3h"] || 0 : 0;
    const windSpeed = firstItem.wind.speed;
    const windDeg = firstItem.wind.deg;
    const windDir = windDirection(windDeg);

    const dateParts = day.split("-");
    const gy = parseInt(dateParts[0], 10);
    const gm = parseInt(dateParts[1], 10);
    const gd = parseInt(dateParts[2], 10);
    const [jy, jm, jd] = toJalaali(gy, gm, gd);
    const dateStrFa = `${jd}/${jm}/${jy}`;
    const dateObj = new Date(day);
    const weekday = lang === "fa" ? weekdaysFa[dateObj.getDay()] : weekdaysAr[dateObj.getDay()];

    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    dayDiv.innerHTML = `
      <div style="font-weight:bold; font-size:1.3rem; margin-bottom:5px;">${weekday} - ${dateStrFa}</div>
      <div class="day-section">
        <div>
          <div>${lang === "fa" ? "روز" : "نهار"}</div>
          <img src="https://openweathermap.org/img/wn/${dayIcon}@2x.png" alt="${dayDesc}" />
          <div>${Math.round(maxDayTemp)} °C</div>
          <div>${dayDesc}</div>
        </div>
        <div>
          <div>${lang === "fa" ? "شب" : "ليل"}</div>
          <img src="https://openweathermap.org/img/wn/${nightIcon}@2x.png" alt="${nightDesc}" />
          <div>${Math.round(minNightTemp)} °C</div>
          <div>${nightDesc}</div>
        </div>
        <div>
          <div>${translations[lang].humidity}</div>
          <div>${humidity} %</div>
        </div>
        <div>
          <div>${translations[lang].pressure}</div>
          <div>${pressure} hPa</div>
        </div>
        <div>
          <div>${translations[lang].wind}</div>
          <div>${windSpeed} m/s</div>
          <div>${windDir}</div>
        </div>
        <div>
          <div>${translations[lang].precipitation}</div>
          <div>${rain} mm</div>
        </div>
      </div>
    `;
    forecastDiv.appendChild(dayDiv);
  });
}

function updateDateDisplay() {
  const now = new Date();
  const gy = now.getFullYear();
  const gm = now.getMonth() +1;
  const gd = now.getDate();
  const weekday = lang === "fa" ? weekdaysFa[now.getDay()] : weekdaysAr[now.getDay()];
  const [jy, jm, jd] = toJalaali(gy, gm, gd);
  dateDisplay.textContent = `${weekday} - ${jd}/${jm}/${jy}`;
}

// نظرات و پیشنهادات
function loadComments() {
  const comments = JSON.parse(localStorage.getItem("comments") || "[]");
  commentsContainer.innerHTML = "";
  comments.forEach(c => {
    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #555";
    div.style.padding = "6px 0";
    div.textContent = c;
    commentsContainer.appendChild(div);
  });
}

function saveComment(text) {
  const comments = JSON.parse(localStorage.getItem("comments") || "[]");
  comments.push(text);
  localStorage.setItem("comments", JSON.stringify(comments));
}

submitCommentBtn.addEventListener("click", () => {
  const comment = commentInput.value.trim();
  if (!comment) {
    alert(translations[lang].alertEmptyComment);
    return;
  }
  saveComment(comment);
  commentInput.value = "";
  alert(translations[lang].alertCommentSaved);
  loadComments();
});

// جستجو
searchBtn.addEventListener("click", () => {
  const city = searchInput.value.trim();
  if(city) {
    fetchWeather(city);
  }
});

// موقعیت مکانی
getLocationBtn.addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert(lang === "fa" ? "موقعیت‌یاب پشتیبانی نمی‌شود." : "الموقع غير مدعوم.");
    return;
  }
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${lang}`);
      const data = await res.json();
      if (!data.name) throw new Error();
      searchInput.value = data.name;
      fetchWeather(data.name);
    } catch {
      alert(translations[lang].errorFetch);
    }
  }, () => {
    alert(lang === "fa" ? "موقعیت‌یابی فعال نیست." : "تعذر الحصول على الموقع.");
  });
});


// نمایش اولیه
updateDateDisplay();
loadComments();
const favoriteCity = getFavoriteCity();
if (favoriteCity) {
  searchInput.value = favoriteCity;
  fetchWeather(favoriteCity);
} else {
  fetchWeather("اهواز");
}
</script>
</body>
</html>
