<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>وضعیت آب‌وهوا</title>
  <style>
    body {
      background: #111;
      color: #f0f0f0;
      font-family: "Tahoma", sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header, footer {
      padding: 1rem;
      background-color: #222;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      margin: 5px;
    }
    .forecast {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .day-card, .hour-card {
      border: 1px solid #444;
      border-radius: 8px;
      margin: 8px;
      padding: 10px;
      background-color: #1a1a1a;
      width: 220px;
    }
    .hour-card {
      background-color: #2a2a2a;
    }
    .weather-icon {
      width: 60px;
    }
    .ad-box {
      margin: 15px 0;
      background-color: #333;
      padding: 10px;
      border-radius: 8px;
    }
    .settings {
      margin: 15px 0;
    }
    iframe {
      width: 100%;
      height: 250px;
      border: none;
    }
    .hidden {
      display: none;
    }
    .language-btn {
      position: absolute;
      left: 10px;
      top: 10px;
    }
    .day-details {
      background: #222;
      padding: 5px;
      margin-top: 8px;
      text-align: left;
      direction: rtl;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="title">وضعیت آب‌وهوا</h1>
    <button onclick="toggleLang()" class="language-btn" id="langToggle">AR</button>
  </header>

  <div class="settings">
    <input type="text" id="cityInput" placeholder="نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)" />
    <button onclick="searchCity()">🔍 جستجو</button>
  </div>

  <div class="ad-box">
    <a href="tel:09332356547" id="callLink">📞 تماس با 09332356547</a><br>
    <a href="https://instagram.com/mehdi.eidani" target="_blank">📸 اینستاگرام: @mehdi.eidani</a><br>
    <a href="mailto:mehdi1eidani@gmail.com">✉️ ایمیل: mehdi1eidani@gmail.com</a>
  </div>

  <div>
    <h2 id="cityName"></h2>
    <p id="shamsiDate"></p>
    <iframe id="mapFrame" src=""></iframe>
  </div>

  <h3>📅 پیش‌بینی روزانه</h3>
  <div class="forecast" id="dailyForecast"></div>

  <h3>🕐 پیش‌بینی ساعتی</h3>
  <div class="forecast" id="hourlyForecast"></div>

  <footer>
    <p>تمامی حقوق محفوظ است - Mehdi Eidani</p>
  </footer>

<script>
  const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88";
  let currentLang = "fa";

  const labels = {
    fa: {
      title: "وضعیت آب‌وهوا",
      searchPlaceholder: "نام شهر یا روستا (مثلاً اهواز یا Kazemi Do)",
      call: "📞 تماس با 09332356547",
      forecastDaily: "📅 پیش‌بینی روزانه",
      forecastHourly: "🕐 پیش‌بینی ساعتی"
    },
    ar: {
      title: "حالة الطقس",
      searchPlaceholder: "أدخل اسم المدينة أو القرية",
      call: "📞 اتصل بـ 09332356547",
      forecastDaily: "📅 التوقعات اليومية",
      forecastHourly: "🕐 التوقعات كل ساعة"
    }
  };

  function toggleLang() {
    currentLang = currentLang === "fa" ? "ar" : "fa";
    document.documentElement.lang = currentLang;
    document.getElementById("title").innerText = labels[currentLang].title;
    document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
    document.getElementById("langToggle").innerText = currentLang === "fa" ? "AR" : "FA";
    document.getElementById("callLink").innerText = labels[currentLang].call;
    document.querySelector("h3").innerText = labels[currentLang].forecastDaily;
  }

  function toShamsi(date) {
    const d = new Date(date);
    return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
      dateStyle: 'full'
    }).format(d);
  }

  async function searchCity() {
    const city = document.getElementById("cityInput").value.trim();
    if (!city) return;

    try {
      const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${API_KEY}`);
      const geoData = await geoRes.json();
      if (!geoData.length) {
        alert("❌ شهر یا روستا یافت نشد.");
        return;
      }

      const { lat, lon, name, country } = geoData[0];
      document.getElementById("cityName").innerText = `${name}, ${country}`;
      document.getElementById("mapFrame").src =
        `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.2},${lat-0.2},${lon+0.2},${lat+0.2}&layer=mapnik`;

      const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=${currentLang}&appid=${API_KEY}`);
      const data = await weatherRes.json();

      document.getElementById("shamsiDate").innerText = "📅 تاریخ امروز: " + toShamsi(Date.now());
      renderForecast(data);
    } catch (e) {
      alert("⚠️ خطا در دریافت اطلاعات، لطفاً دوباره تلاش کنید.");
      console.error(e);
    }
  }

  function renderForecast(data) {
    const daily = {};
    const dailyForecast = document.getElementById("dailyForecast");
    const hourlyForecast = document.getElementById("hourlyForecast");
    dailyForecast.innerHTML = "";
    hourlyForecast.innerHTML = "";

    data.list.forEach(entry => {
      const date = entry.dt_txt.split(" ")[0];
      const hour = entry.dt_txt.split(" ")[1].slice(0, 5);
      const icon = `https://openweathermap.org/img/wn/${entry.weather[0].icon}@2x.png`;

      if (!daily[date]) daily[date] = [];
      daily[date].push({ ...entry, hour, icon });
    });

    Object.keys(daily).forEach(date => {
      const items = daily[date];
      const dayAvg = (items.reduce((a, b) => a + b.main.temp, 0) / items.length).toFixed(1);
      const min = Math.min(...items.map(i => i.main.temp_min)).toFixed(1);
      const max = Math.max(...items.map(i => i.main.temp_max)).toFixed(1);
      const icon = items[0].icon;
      const desc = items[0].weather[0].description;

      const card = document.createElement("div");
      card.className = "day-card";
      card.innerHTML = `
        <div><strong>${toShamsi(date)}</strong></div>
        <img class="weather-icon" src="${icon}" />
        <div>${desc}</div>
        <div>🌡️ ${min}°C ~ ${max}°C</div>
        <button onclick="toggleDetails('${date}')">🔽 جزئیات</button>
        <div id="details-${date}" class="hidden day-details">
          ${items.map(e => `
            <div>
              ⏰ ${e.hour} | ${e.main.temp}°C | ${e.weather[0].description}<br>
              💧 رطوبت: ${e.main.humidity}% | 💨 باد: ${e.wind.speed} m/s - جهت ${e.wind.deg}°<br>
              🔽 فشار: ${e.main.pressure} hPa
            </div><hr>
          `).join("")}
        </div>
      `;
      dailyForecast.appendChild(card);
    });
  }

  function toggleDetails(id) {
    const el = document.getElementById("details-" + id);
    el.classList.toggle("hidden");
  }

  window.onload = () => {
    document.getElementById("cityInput").value = "اهواز";
    searchCity();
  };
</script>
</body>
</html>
