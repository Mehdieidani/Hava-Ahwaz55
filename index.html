<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>هواشناسی پیشرفته با ثبت‌نام اختیاری و چت</title>
<style>
  body {
    font-family: 'Tahoma', sans-serif;
    margin: 0; padding: 0;
    background: #0077b6;
    color: #fff;
    direction: rtl;
    transition: background 0.3s, color 0.3s;
  }
  header {
    background: linear-gradient(to left, #023e8a, #0096c7);
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    position: relative;
  }
  button {
    cursor: pointer;
  }
  #settings-btn {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 5px;
    font-weight: bold;
  }
  #container {
    max-width: 900px;
    margin: 1rem auto;
    padding: 0 1rem;
  }
  #weather-section {
    background: #023047;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    min-height: 150px;
  }
  #chat-section {
    background: #023047;
    border-radius: 10px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    height: 400px;
  }
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    background: #011f4b;
    border-radius: 5px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .message {
    margin-bottom: 0.5rem;
    padding: 0.5rem 0.7rem;
    border-radius: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .message.user {
    background: #ffb703;
    color: #023047;
    align-self: flex-start;
  }
  .message.admin {
    background: #90e0ef;
    color: #023047;
    align-self: flex-end;
  }
  .message.guest {
    background: #ddd;
    color: #333;
    align-self: center;
    font-style: italic;
  }
  #chat-input {
    display: flex;
  }
  #chat-input textarea {
    flex-grow: 1;
    resize: none;
    padding: 0.5rem;
    border-radius: 5px 0 0 5px;
    border: none;
    font-size: 1rem;
  }
  #chat-input button {
    background: #ffb703;
    border: none;
    color: #023047;
    padding: 0 1rem;
    font-weight: bold;
    border-radius: 0 5px 5px 0;
  }
  #settings-modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #023047;
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 0 10px #0008;
    display: none;
    z-index: 1000;
    width: 350px;
    max-height: 90vh;
    overflow-y: auto;
  }
  #settings-modal h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
  }
  #settings-modal label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
  }
  #settings-modal input[type=text],
  #settings-modal input[type=password],
  #settings-modal input[type=tel],
  #settings-modal select {
    width: 100%;
    padding: 0.4rem;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
  }
  #settings-modal input[type=range] {
    width: 100%;
  }
  #settings-modal button.close-settings {
    margin-top: 1rem;
    background: #ff5722;
    border: none;
    color: white;
    padding: 0.6rem;
    width: 100%;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
  }
  #settings-modal button.action-btn {
    background: #ffb703;
    border: none;
    color: #023047;
    padding: 0.6rem;
    width: 100%;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 0.5rem;
  }
  #settings-modal .error {
    color: #f44336;
    margin-bottom: 0.5rem;
  }
  #user-info {
    margin-top: 0.5rem;
    text-align: center;
    font-weight: bold;
  }
  /* تم تاریک */
  body.dark {
    background: #011627;
    color: #eee;
  }
  body.dark header {
    background: linear-gradient(to left, #001f3f, #004080);
  }
  body.dark #weather-section,
  body.dark #chat-section,
  body.dark #settings-modal {
    background: #001f3f;
    color: #eee;
  }
  body.dark #chat-messages {
    background: #001733;
  }
  /* فونت‌ها */
  body.font-tahoma { font-family: 'Tahoma', sans-serif; }
  body.font-vazir { font-family: 'Vazir', sans-serif; }
  body.font-irsans { font-family: 'IRANSans', sans-serif; }
  body.font-sahel { font-family: 'Sahel', sans-serif; }
</style>

<!-- فونت‌های وب -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/iransans-web@3.1.1/dist/css/iransans.css" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v2.0.1/dist/font-face.css" rel="stylesheet" type="text/css" />

</head>
<body class="font-tahoma">

<header>
  هواشناسی پیشرفته
  <button id="settings-btn" title="تنظیمات">⚙️</button>
</header>

<div id="container">

  <!-- بخش هواشناسی -->
  <section id="weather-section">
    <div id="weather-app">
      <p>اینجا پیش‌بینی هواشناسی قرار می‌گیرد...</p>
    </div>
  </section>

  <!-- بخش چت (همیشه فعال) -->
  <section id="chat-section">
    <div id="chat-messages"></div>
    <div id="chat-input">
      <textarea id="chat-text" rows="2" placeholder="پیام خود را بنویسید..."></textarea>
      <button id="chat-send">ارسال</button>
    </div>
  </section>

</div>

<!-- پنجره تنظیمات -->
<div id="settings-modal">
  <h3>تنظیمات</h3>

  <!-- ثبت نام / ورود -->
  <div id="auth-container">
    <div id="auth-error" class="error"></div>
    <form id="auth-form">
      <label for="phone">شماره موبایل:</label>
      <input type="tel" id="phone" name="phone" placeholder="مثال: 09123456789" pattern="09[0-9]{9}" />

      <label for="password">رمز عبور:</label>
      <input type="password" id="password" name="password" minlength="6" />

      <div id="register-fields" style="display:none;">
        <label for="password-repeat">تکرار رمز عبور:</label>
        <input type="password" id="password-repeat" name="password-repeat" minlength="6" />

        <label for="recovery-question">سوال بازیابی رمز:</label>
        <input type="text" id="recovery-question" name="recovery-question" />
      </div>

      <button type="submit" class="action-btn" id="auth-submit">ورود</button>
    </form>
    <div id="auth-toggle" style="text-align:center; margin-top: 10px; cursor:pointer; color:#ffb703;">ثبت نام کنید</div>
    <div id="user-info"></div>
    <button id="logout-btn" class="action-btn" style="display:none; background:#f44336;">خروج از حساب</button>
  </div>

  <hr style="margin: 1rem 0; border-color: #ffb703;" />

  <!-- تنظیمات ظاهری -->
  <label for="theme-select">تم:</label>
  <select id="theme-select">
    <option value="light">روشن</option>
    <option value="dark">تاریک</option>
  </select>

  <label for="font-select">فونت:</label>
  <select id="font-select">
    <option value="font-tahoma">Tahoma</option>
    <option value="font-vazir">Vazir</option>
    <option value="font-irsans">IRANSans</option>
    <option value="font-sahel">Sahel</option>
  </select>

  <label for="font-size-range">اندازه فونت:</label>
  <input type="range" id="font-size-range" min="12" max="28" value="16" />

  <button class="close-settings">بستن</button>
</div>

<script>
  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const closeSettingsBtn = document.querySelector('.close-settings');

  // باز و بسته کردن پنل تنظیمات
  settingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'block';
  });
  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'none';
  });

  // --- تنظیمات ظاهری ---
  const themeSelect = document.getElementById('theme-select');
  const fontSelect = document.getElementById('font-select');
  const fontSizeRange = document.getElementById('font-size-range');

  themeSelect.addEventListener('change', () => {
    if(themeSelect.value === 'dark'){
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
    localStorage.setItem('theme', themeSelect.value);
  });
  fontSelect.addEventListener('change', () => {
    document.body.classList.remove('font-tahoma','font-vazir','font-irsans','font-sahel');
    document.body.classList.add(fontSelect.value);
    localStorage.setItem('font', fontSelect.value);
  });
  fontSizeRange.addEventListener('input', () => {
    document.body.style.fontSize = fontSizeRange.value + 'px';
    localStorage.setItem('fontSize', fontSizeRange.value);
  });

  function applySettingsFromStorage(){
    const theme = localStorage.getItem('theme') || 'light';
    themeSelect.value = theme;
    if(theme === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');

    const font = localStorage.getItem('font') || 'font-tahoma';
    fontSelect.value = font;
    document.body.classList.remove('font-tahoma','font-vazir','font-irsans','font-sahel');
    document.body.classList.add(font);

    const fontSize = localStorage.getItem('fontSize') || '16';
    fontSizeRange.value = fontSize;
    document.body.style.fontSize = fontSize + 'px';
  }

  window.addEventListener('load', applySettingsFromStorage);

  // --- ثبت‌نام و ورود ---

  const authForm = document.getElementById('auth-form');
  const authToggle = document.getElementById('auth-toggle');
  const authError = document.getElementById('auth-error');
  const registerFields = document.getElementById('register-fields');
  const authSubmit = document.getElementById('auth-submit');
  const userInfo = document.getElementById('user-info');
  const logoutBtn = document.getElementById('logout-btn');

  let isRegisterMode = false; // حالت فعلی: ورود
  let currentUser = null;

  // دریافت کاربران از localStorage
  function getUsers() {
    return JSON.parse(localStorage.getItem('users') || '{}');
  }
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  // ثبت نام کاربر
  function registerUser(phone, password, recoveryQuestion) {
    const users = getUsers();
    if(users[phone]) return { success:false, message: 'این شماره قبلاً ثبت شده است.' };
    users[phone] = { password, recoveryQuestion, messages: [] };
    saveUsers(users);
    return { success:true };
  }

  // ورود کاربر
  function loginUser(phone, password) {
    const users = getUsers();
    if(!users[phone]) return { success:false, message: 'این شماره ثبت نشده است.' };
    if(users[phone].password !== password) return { success:false, message: 'رمز عبور اشتباه است.' };
    return { success:true, user: users[phone] };
  }

  // ذخیره پیام برای کاربر
  function saveMessage(phone, message, sender) {
    const users = getUsers();
    if(!users[phone]) return;
    users[phone].messages.push({ sender, text: message, time: new Date().toISOString() });
    saveUsers(users);
  }

  // بارگذاری پیام‌ها برای کاربر
  function loadMessages(phone) {
    const users = getUsers();
    if(!users[phone]) return [];
    return users[phone].messages || [];
  }

  // نمایش پیام‌ها در چت
  const chatMessages = document.getElementById('chat-messages');
  function renderMessages(messages) {
    chatMessages.innerHTML = "";
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender === 'user' ? 'user' : 'admin');
      const time = new Date(msg.time).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
      div.textContent = `[${time}] ${msg.text}`;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // حالت ثبت نام / ورود
  authToggle.addEventListener('click', () => {
    isRegisterMode = !isRegisterMode;
    authError.textContent = '';
    if(isRegisterMode){
      authSubmit.textContent = 'ثبت نام';
      registerFields.style.display = 'block';
      authToggle.textContent = 'ورود کنید';
    } else {
      authSubmit.textContent = 'ورود';
      registerFields.style.display = 'none';
      authToggle.textContent = 'ثبت نام کنید';
    }
  });

  // ثبت نام یا ورود
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    authError.textContent = '';

    const phone = authForm.phone.value.trim();
    const password = authForm.password.value.trim();

    if(isRegisterMode){
      const passwordRepeat = authForm['password-repeat'].value.trim();
      const recoveryQuestion = authForm['recovery-question'].value.trim();

      if(!phone || !password || !passwordRepeat || !recoveryQuestion){
        authError.textContent = 'لطفاً همه فیلدها را پر کنید.';
        return;
      }
      if(password !== passwordRepeat){
        authError.textContent = 'رمز عبور و تکرار آن مطابقت ندارند.';
        return;
      }
      if(password.length < 6){
        authError.textContent = 'رمز عبور باید حداقل 6 کاراکتر باشد.';
        return;
      }
      const res = registerUser(phone, password, recoveryQuestion);
      if(!res.success){
        authError.textContent = res.message;
        return;
      }
      alert('ثبت نام موفقیت‌آمیز بود. لطفاً وارد شوید.');
      isRegisterMode = false;
      authToggle.click();
      authForm.reset();
    } else {
      if(!phone || !password){
        authError.textContent = 'شماره موبایل و رمز عبور را وارد کنید.';
        return;
      }
      const res = loginUser(phone, password);
      if(!res.success){
        authError.textContent = res.message;
        return;
      }
      currentUser = phone;
      userInfo.textContent = `کاربر: ${currentUser}`;
      logoutBtn.style.display = 'block';
      authForm.style.display = 'none';
      authToggle.style.display = 'none';
      authError.textContent = '';
      settingsModal.style.display = 'none';
      loadAndRenderMessages();
    }
  });

  // خروج
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    userInfo.textContent = '';
    logoutBtn.style.display = 'none';
    authForm.style.display = 'block';
    authToggle.style.display = 'block';
    chatMessages.innerHTML = '';
  });

  // ارسال پیام در چت
  const chatSendBtn = document.getElementById('chat-send');
  const chatText = document.getElementById('chat-text');

  chatSendBtn.addEventListener('click', () => {
    const text = chatText.value.trim();
    if(!text) return;

    const time = new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});

    if(currentUser){
      // ذخیره پیام برای کاربر
      saveMessage(currentUser, text, 'user');
      appendMessage({sender:'user', text, time: new Date().toISOString()});
    } else {
      // برای مهمان، فقط نمایش میده بدون ذخیره
      appendGuestMessage(text, time);
    }

    chatText.value = '';
  });

  // اضافه کردن پیام کاربر
  function appendMessage(msg) {
    const div = document.createElement('div');
    div.classList.add('message', msg.sender === 'user' ? 'user' : 'admin');
    const time = new Date(msg.time).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
    div.textContent = `[${time}] ${msg.text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // اضافه کردن پیام مهمان (بدون ذخیره)
  function appendGuestMessage(text, time) {
    const div = document.createElement('div');
    div.classList.add('message', 'guest');
    div.textContent = `[${time}] ${text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // بارگذاری پیام‌ها برای کاربر و نمایش
  function loadAndRenderMessages(){
    if(!currentUser) return;
    const messages = loadMessages(currentUser);
    renderMessages(messages);
  }

</script>

</body>
</html>
