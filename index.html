<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚</title>
<link href="https://cdn.jsdelivr.net/npm/vazir-font@v1.1.2/dist/font-face.css" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body {
    font-family: Vazir, sans-serif;
    margin: 0; padding: 0; background: #eef6fb; color: #222;
    direction: rtl;
  }
  header {
    background: #2196f3; color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
  }
  header h1 {
    margin: 0; font-size: 1.6rem;
  }
  #langToggle {
    background: white; border: none; padding: 8px 15px; border-radius: 8px; color: #2196f3; font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
  }
  #searchSection {
    margin: 15px 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
  }
  #cityInput {
    width: 260px; padding: 10px 12px; font-size: 1rem; border-radius: 8px; border: 1.5px solid #2196f3;
    outline: none;
  }
  #searchBtn {
    background: #2196f3; border: none; padding: 10px 18px; border-radius: 8px; color: white; font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
  }
  #cityName {
    margin: 12px auto; text-align: center; font-size: 1.3rem; font-weight: bold; color: #0b3d91;
  }
  #mapFrame {
    display: block; margin: 10px auto; border-radius: 12px; border: none;
    width: 90vw; max-width: 600px; height: 280px;
  }
  /* Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡ */
  #dailyForecast {
    display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; padding: 15px 10px;
  }
  .day-card {
    background: white; border-radius: 16px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    width: 120px; padding: 10px 10px 18px; text-align: center;
    font-size: 0.95rem;
  }
  .day-card h3 {
    margin: 6px 0 10px; font-weight: bold; font-size: 1.1rem;
  }
  .day-icon {
    width: 64px; height: 64px;
  }
  .temp-day, .temp-night {
    margin: 6px 0; font-weight: 600;
  }
  /* Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ */
  #hourlyForecast {
    margin: 20px auto; max-width: 95vw; overflow-x: auto; padding-bottom: 10px;
  }
  #hourlyForecast .hour-card {
    display: inline-block; background: white; border-radius: 14px; padding: 10px 14px; margin: 0 8px;
    width: 110px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    text-align: center; font-size: 0.9rem;
  }
  .hour-time {
    font-weight: bold; margin-bottom: 8px;
  }
  .hour-icon {
    width: 40px; height: 40px;
  }
  .hour-temp {
    margin: 6px 0; font-weight: 600;
  }
  .hour-desc {
    font-size: 0.85rem; color: #555;
  }
  .hour-wind, .hour-humidity {
    font-size: 0.8rem; color: #777; margin-top: 4px;
  }
  /* Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø¨Ø§Ø¯ */
  #plots {
    margin: 30px auto; max-width: 650px;
  }
  /* ØªØ¨Ù„ÛŒØºØ§Øª ØªÙ…Ø§Ø³ */
  .ad-box {
    position: fixed; bottom: 15px; left: 15px;
    background: #fdf5e6; border: 2px solid #f39c12; border-radius: 14px;
    padding: 8px 14px; font-weight: bold; color: #b35e00;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    cursor: pointer;
    user-select: none;
  }
  .ad-box a {
    color: #b35e00; text-decoration: none;
  }
  @media (max-width: 480px) {
    #dailyForecast {
      justify-content: center;
    }
    #hourlyForecast .hour-card {
      width: 90px;
      margin: 0 6px;
      padding: 8px 10px;
      font-size: 0.8rem;
    }
    #plots {
      width: 95vw;
    }
  }
</style>
</head>
<body>

<header>
  <h1 id="title">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ</h1>
  <button id="langToggle" onclick="toggleLang()">AR</button>
</header>

<section id="searchSection">
  <input id="cityInput" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)" />
  <button id="searchBtn" onclick="searchCity()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
</section>

<div id="cityName">Ø§Ù‡ÙˆØ§Ø²</div>
<iframe id="mapFrame" src="" allowfullscreen loading="lazy"></iframe>

<section id="dailyForecast"></section>

<section id="hourlyForecast"></section>

<div id="plots"></div>

<div class="ad-box">
  <a href="tel:09332356547" id="callLink">ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ 09332356547</a>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88";
let currentLang = "fa";

const labels = {
  fa: {
    title: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ",
    searchPlaceholder: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)",
    cityNotFound: "Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.",
    dailyTitle: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡",
    hourlyTitle: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ",
    tempDay: "Ø±ÙˆØ²",
    tempNight: "Ø´Ø¨",
    wind: "Ø¨Ø§Ø¯",
    humidity: "Ø±Ø·ÙˆØ¨Øª",
    call: "ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ 09332356547",
    directionLabels: ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚ÛŒ", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚ÛŒ", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨ÛŒ", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨ÛŒ"],
  },
  ar: {
    title: "ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø·Ù‚Ø³",
    searchPlaceholder: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©",
    cityNotFound: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.",
    dailyTitle: "ØªÙˆÙ‚Ø¹Ø§Øª Ù¥ Ø£ÙŠØ§Ù…",
    hourlyTitle: "ØªÙˆÙ‚Ø¹Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø©",
    tempDay: "Ù†Ù‡Ø§Ø±",
    tempNight: "Ù„ÙŠÙ„",
    wind: "Ø§Ù„Ø±ÙŠØ§Ø­",
    humidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
    call: "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù€ 09332356547",
    directionLabels: ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ"],
  }
};

function toggleLang(){
  currentLang = currentLang === "fa" ? "ar" : "fa";
  document.getElementById("title").innerText = labels[currentLang].title;
  document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
  document.getElementById("langToggle").innerText = currentLang === "fa" ? "AR" : "FA";
  document.getElementById("callLink").innerText = labels[currentLang].call;
  renderForecast(lastWeatherData);
}

function degToDir(deg){
  const d = labels[currentLang].directionLabels;
  return d[Math.round(deg / 45) % 8];
}

let lastWeatherData = null;

async function searchCity(){
  const city = document.getElementById("cityInput").value.trim();
  if(!city) return;
  try {
    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`);
    const geoData = await geoRes.json();
    if(!geoData.length){
      alert(labels[currentLang].cityNotFound);
      return;
    }
    const { lat, lon, name, country } = geoData[0];
    document.getElementById("cityName").innerText = `${name}, ${country}`;
    document.getElementById("mapFrame").src =
      `https://www.openstreetmap.org/export/embed.html?bbox=${lon - 0.2},${lat - 0.2},${lon + 0.2},${lat + 0.2}&layer=mapnik`;

    const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=${currentLang}&appid=${API_KEY}`);
    const weatherData = await weatherRes.json();
    lastWeatherData = weatherData;
    renderForecast(weatherData);
  } catch(e){
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
    console.error(e);
  }
}

function renderForecast(data){
  if(!data) return;

  // Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡
  const dailySection = document.getElementById("dailyForecast");
  dailySection.innerHTML = `<h2 style="text-align:center;margin-bottom:12px;">${labels[currentLang].dailyTitle}</h2>`;
  // Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø±ÙˆØ²Ù‡Ø§
  let dailyMap = {};
  data.list.forEach(item=>{
    const date = item.dt_txt.split(" ")[0];
    if(!dailyMap[date]) dailyMap[date] = [];
    dailyMap[date].push(item);
  });
  const days = Object.keys(dailyMap).slice(0,5);

  days.forEach(day => {
    // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§ÛŒ Ø±ÙˆØ² Ùˆ Ø´Ø¨
    const dayTemps = dailyMap[day].filter(i=> {
      const hour = parseInt(i.dt_txt.split(" ")[1].split(":")[0]);
      return hour >= 6 && hour <= 18;
    });
    const nightTemps = dailyMap[day].filter(i=>{
      const hour = parseInt(i.dt_txt.split(" ")[1].split(":")[0]);
      return hour < 6 || hour > 18;
    });

    const avgDayTemp = dayTemps.reduce((a,b)=>a+b.main.temp,0)/dayTemps.length || 0;
    const avgNightTemp = nightTemps.reduce((a,b)=>a+b.main.temp,0)/nightTemps.length || 0;
    // Ø¢ÛŒÚ©ÙˆÙ† ØºØ§Ù„Ø¨ Ø±ÙˆØ²
    const dayIcon = dayTemps.length ? dayTemps[0].weather[0].icon : dailyMap[day][0].weather[0].icon;
    // ØªÙˆØ¶ÛŒØ­ ØºØ§Ù„Ø¨ Ø±ÙˆØ²
    const dayDesc = dayTemps.length ? dayTemps[0].weather[0].description : dailyMap[day][0].weather[0].description;

    dailySection.innerHTML += `
      <div class="day-card">
        <h3>${day}</h3>
        <img src="https://openweathermap.org/img/wn/${dayIcon}@2x.png" alt="weather icon" class="day-icon" />
        <div class="temp-day">${labels[currentLang].tempDay}: ${avgDayTemp.toFixed(1)}Â°C</div>
        <div class="temp-night">${labels[currentLang].tempNight}: ${avgNightTemp.toFixed(1)}Â°C</div>
        <div>${dayDesc}</div>
      </div>
    `;
  });

  // Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ
  const hourlySection = document.getElementById("hourlyForecast");
  hourlySection.innerHTML = `<h2 style="text-align:center;margin-bottom:12px;">${labels[currentLang].hourlyTitle}</h2>`;
  // ÙÙ‚Ø· 24 Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡
  const next24 = data.list.slice(0,8);

  next24.forEach(item=>{
    const hour = item.dt_txt.split(" ")[1].slice(0,5);
    const windDir = degToDir(item.wind.deg);
    hourlySection.innerHTML += `
      <div class="hour-card">
        <div class="hour-time">${hour}</div>
        <img src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png" alt="icon" class="hour-icon" />
        <div class="hour-temp">${item.main.temp.toFixed(1)}Â°C</div>
        <div class="hour-desc">${item.weather[0].description}</div>
        <div class="hour-wind">${labels[currentLang].wind}: ${item.wind.speed} m/s ${windDir}</div>
        <div class="hour-humidity">${labels[currentLang].humidity}: ${item.main.humidity}%</div>
      </div>
    `;
  });

  // Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ù…Ø§ Ùˆ Ø¨Ø§Ø¯
  plotCharts(next24);
}

function plotCharts(hourlyData){
  // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ 8 Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡
  const hours = hourlyData.map(i=>i.dt_txt.split(" ")[1].slice(0,5));
  const temps = hourlyData.map(i=>i.main.temp);
  const winds = hourlyData.map(i=>i.wind.speed);

  const tempTrace = {
    x: hours,
    y: temps,
    type: 'scatter',
    mode: 'lines+markers',
    name: labels[currentLang].tempDay,
    line: {color: '#ff6b6b'},
  };
  const windTrace = {
    x: hours,
    y: winds,
    type: 'scatter',
    mode: 'lines+markers',
    name: labels[currentLang].wind,
    line: {color: '#1e90ff'},
  };

  const layout = {
    margin: {t: 30, b: 40, l: 50, r: 20},
    legend: {x: 0, y: 1},
    yaxis: {title: 'Ù…Ù‚Ø¯Ø§Ø±'},
    xaxis: {title: 'Ø³Ø§Ø¹Øª'},
    font: {family: 'Vazir, sans-serif'},
    height: 320,
    hovermode: 'x unified',
  };

  Plotly.newPlot('plots', [tempTrace, windTrace], layout, {responsive: true});
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø§Ù‡ÙˆØ§Ø²
window.onload = () => {
  document.getElementById("cityInput").value = "Ø§Ù‡ÙˆØ§Ø²";
  searchCity();
};
</script>

</body>
</html>
