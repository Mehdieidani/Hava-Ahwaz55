<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ - Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø±ÙˆØ² Ùˆ Ø´Ø¨</title>
<link href="https://cdn.jsdelivr.net/npm/vazir-font@v1.1.2/dist/font-face.css" rel="stylesheet" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-oGZj6j7l75Qo6Sj01WZb2n08+36a3L8aV7Qw+iYXF0k="
  crossorigin=""
/>
<style>
  body {
    font-family: Vazir, sans-serif;
    margin: 0;
    background: linear-gradient(to top, #001529, #0a2749);
    color: #eee;
    direction: rtl;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background-color: #003366;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
  }
  #langToggle {
    background: #00509e;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: bold;
  }
  main {
    display: flex;
    flex-wrap: wrap;
    padding: 1rem;
    gap: 1rem;
    flex: 1;
  }
  #leftPanel {
    flex: 1 1 320px;
    max-width: 400px;
    background: #013a63;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  #searchSection {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  #cityInput {
    flex: 1;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  #searchBtn {
    background: #00509e;
    color: white;
    border: none;
    padding: 0 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  #favorites {
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  #favorites button {
    background: #00509e;
    color: white;
    border: none;
    margin: 0 0.2rem 0.2rem 0.2rem;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
  }
  #favorites button:hover {
    background: #1a73e8;
  }
  #currentWeather {
    background: #01497c;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
  }
  #currentWeather img {
    width: 100px;
    height: 100px;
  }
  #currentWeather h2 {
    margin: 0.5rem 0;
  }
  #currentWeather .temp {
    font-size: 2.8rem;
    font-weight: 700;
  }
  #currentWeather .desc {
    font-size: 1.2rem;
    margin: 0.5rem 0;
  }
  #currentWeather .details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.7rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    text-align: right;
  }
  #forecastContainer {
    background: #013a63;
    flex: 2 1 600px;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  #dailyForecast {
    display: flex;
    gap: 0.7rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  .day-card {
    background: #00509e;
    flex: 0 0 120px;
    border-radius: 10px;
    padding: 0.5rem;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
    text-align: center;
  }
  .day-card.active,
  .day-card:hover {
    background: #1a73e8;
  }
  .day-card h3 {
    margin: 0;
    font-size: 1rem;
  }
  .day-card img {
    display: block;
    margin: 0.3rem auto;
    width: 60px;
    height: 60px;
  }
  .day-card .temp-day,
  .day-card .temp-night {
    font-size: 1rem;
    font-weight: 700;
    margin-top: 0.2rem;
  }
  #hourlyForecast {
    margin-top: 1rem;
    max-height: 400px;
    overflow-y: auto;
    background: #01497c;
    border-radius: 12px;
    padding: 1rem;
  }
  .hour-group {
    margin-bottom: 1rem;
  }
  .hour-group-header {
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    padding: 0.4rem;
    background: #00509e;
    border-radius: 6px;
    user-select: none;
    margin-bottom: 0.5rem;
  }
  .hour-group-content {
    display: none;
    max-height: 300px;
    overflow-y: auto;
    border-radius: 6px;
  }
  .hour-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.8rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #0277bd;
  }
  .hour-card img {
    width: 48px;
    height: 48px;
  }
  .hour-info {
    flex: 1;
  }
  .hour-info div {
    margin-bottom: 0.2rem;
    font-size: 0.9rem;
  }
  .detail-label {
    font-weight: 700;
  }
  #map {
    height: 300px;
    border-radius: 12px;
    margin-top: 1rem;
  }
  footer {
    text-align: center;
    padding: 1rem;
    font-size: 0.9rem;
    background: #002143;
    color: #bbb;
  }
  footer a {
    color: #3399ff;
    text-decoration: none;
    margin: 0 0.5rem;
  }
  footer a:hover {
    text-decoration: underline;
  }
  /* Scrollbar for daily forecast */
  #dailyForecast::-webkit-scrollbar {
    height: 8px;
  }
  #dailyForecast::-webkit-scrollbar-thumb {
    background: #3399ff;
    border-radius: 10px;
  }
  #dailyForecast::-webkit-scrollbar-track {
    background: #013a63;
  }
  /* Scrollbar for hourly forecast */
  #hourlyForecast::-webkit-scrollbar {
    width: 8px;
  }
  #hourlyForecast::-webkit-scrollbar-thumb {
    background: #3399ff;
    border-radius: 10px;
  }
  #hourlyForecast::-webkit-scrollbar-track {
    background: #013a63;
  }

  /* Responsive */
  @media (max-width: 900px) {
    main {
      flex-direction: column;
    }
    #forecastContainer {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header>
  <h1 id="title">ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§</h1>
  <button id="langToggle" onclick="toggleLang()">AR</button>
</header>

<main>
  <section id="leftPanel">
    <div id="searchSection">
      <input id="cityInput" type="text" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)" />
      <button id="searchBtn" onclick="searchCity()">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div id="favorites"></div>
    <div id="currentWeather"></div>
  </section>

  <section id="forecastContainer">
    <div id="dailyForecast"></div>
    <div id="hourlyForecast"></div>
    <div id="map"></div>
  </section>
</main>

<footer>
  <div>ØªÙ…Ø§Ø³: <a href="tel:09332356547">09332356547</a></div>
  <div>Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: <a href="https://instagram.com/mehdi.eidani" target="_blank">@mehdi.eidani</a></div>
  <div>Ø§ÛŒÙ…ÛŒÙ„: <a href="mailto:mehdi1eidani@gmail.com">mehdi1eidani@gmail.com</a></div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-oW7l7NhKX0iSXXEe4BfPvvCJS8+PpL3e2pA6cd9vXNk="
  crossorigin="">
</script>
<script>
  const API_KEY = "dc9c93f51cdd375d459483c2a9f86d88";
  let currentLang = "fa";
  let currentUnits = "metric";
  let currentCity = null;
  let map, mapMarker;

  const labels = {
    fa: {
      title: "ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§",
      searchPlaceholder: "Ù†Ø§Ù… Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù‡ÙˆØ§Ø² ÛŒØ§ Kazemi Do)",
      searchBtn: "Ø¬Ø³ØªØ¬Ùˆ",
      hourlyTitleDay: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ Ø±ÙˆØ²",
      hourlyTitleNight: "Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ Ø´Ø¨",
      temp: "Ø¯Ù…Ø§",
      humidity: "Ø±Ø·ÙˆØ¨Øª",
      pressure: "ÙØ´Ø§Ø± Ù‡ÙˆØ§",
      windSpeed: "Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯",
      windDir: "Ø¬Ù‡Øª Ø¨Ø§Ø¯",
      sunrise: "Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨",
      sunset: "ØºØ±ÙˆØ¨ Ø¢ÙØªØ§Ø¨",
      aqi: "Ú©ÛŒÙÛŒØª Ù‡ÙˆØ§",
      favoritesTitle: "Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡",
      addFav: "Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§",
      removeFav: "Ø­Ø°Ù Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§",
      noFav: "Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.",
      errorCity: "Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.",
      callText: "ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ 09332356547",
      instagram: "Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…",
      email: "Ø§ÛŒÙ…ÛŒÙ„",
      visibility: "Ø¯ÛŒØ¯ Ø§ÙÙ‚ÛŒ",
      uvIndex: "Ø´Ø§Ø®Øµ UV",
      pop: "Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´",
      feelsLike: "Ø§Ø­Ø³Ø§Ø³ ÙˆØ§Ù‚Ø¹ÛŒ",
      dewPoint: "Ù†Ù‚Ø·Ù‡ Ø´Ø¨Ù†Ù…",
      clouds: "Ø§Ø¨Ø±Ù‡Ø§",
      description: "ØªÙˆØ¶ÛŒØ­Ø§Øª",
      day: "Ø±ÙˆØ²",
      night: "Ø´Ø¨"
    },
    ar: {
      title: "Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³",
      searchPlaceholder: "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø±ÙŠØ©",
      searchBtn: "Ø¨Ø­Ø«",
      hourlyTitleDay: "ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±",
      hourlyTitleNight: "ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ù„ÙŠÙ„",
      temp: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©",
      humidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
      pressure: "Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¬ÙˆÙŠ",
      windSpeed: "Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­",
      windDir: "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­",
      sunrise: "Ø´Ø±ÙˆÙ‚ Ø§Ù„Ø´Ù…Ø³",
      sunset: "ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³",
      aqi: "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡",
      favoritesTitle: "Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©",
      addFav: "Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø§Øª",
      removeFav: "Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª",
      noFav: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ù† Ù…ÙØ¶Ù„Ø©.",
      errorCity: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.",
      callText: "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù€ 09332356547",
      instagram: "Ø§Ù†Ø³ØªØºØ±Ø§Ù…",
      email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
      visibility: "Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙÙ‚ÙŠØ©",
      uvIndex: "Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø´Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠØ©",
      pop: "Ø§Ø­ØªÙ…Ø§Ù„ Ù‡Ø·ÙˆÙ„ Ø§Ù„Ø£Ù…Ø·Ø§Ø±",
      feelsLike: "Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ³Ø©",
      dewPoint: "Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ø¯Ù‰",
      clouds: "Ø§Ù„ØºÙŠÙˆÙ…",
      description: "Ø§Ù„ÙˆØµÙ",
      day: "Ù†Ù‡Ø§Ø±",
      night: "Ù„ÙŠÙ„"
    }
  };

  let favorites = JSON.parse(localStorage.getItem("favorites_weather")) || [];

  function toggleLang() {
    currentLang = currentLang === "fa" ? "ar" : "fa";
    document.getElementById("title").innerText = labels[currentLang].title;
    document.getElementById("cityInput").placeholder = labels[currentLang].searchPlaceholder;
    document.getElementById("searchBtn").innerText = labels[currentLang].searchBtn;
    renderFavorites();
    renderCurrentWeather(currentCity);
  }

  function toggleFavorite(cityName) {
    if (favorites.includes(cityName)) {
      favorites = favorites.filter(c => c !== cityName);
    } else {
      favorites.push(cityName);
    }
    localStorage.setItem("favorites_weather", JSON.stringify(favorites));
    renderFavorites();
  }

  function renderFavorites() {
    const favDiv = document.getElementById("favorites");
    favDiv.innerHTML = "";
    if (favorites.length === 0) {
      favDiv.innerText = labels[currentLang].noFav;
      return;
    }
    favorites.forEach(city => {
      const btn = document.createElement("button");
      btn.textContent = city;
      btn.onclick = () => {
        document.getElementById("cityInput").value = city;
        searchCity();
      };
      favDiv.appendChild(btn);
    });
  }

  async function searchCity() {
    const city = document.getElementById("cityInput").value.trim();
    if (!city) return alert(labels[currentLang].errorCity);

    try {
      const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`);
      const geoData = await geoRes.json();
      if (!geoData.length) return alert(labels[currentLang].errorCity);

      const { lat, lon, name, country } = geoData[0];
      currentCity = { lat, lon, name, country };

      if (!map) initMap(lat, lon);
      else {
        map.setView([lat, lon], 10);
        if (mapMarker) map.removeLayer(mapMarker);
        mapMarker = L.marker([lat, lon]).addTo(map).bindPopup(`${name}, ${country}`).openPopup();
      }

      const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`);
      const weatherData = await weatherRes.json();

      const currentRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${currentUnits}&lang=${currentLang}&appid=${API_KEY}`);
      const currentData = await currentRes.json();

      const aqiRes = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`);
      const aqiData = await aqiRes.json();

      renderCurrentWeather(currentData, aqiData);
      renderForecast(weatherData);
    } catch (e) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
      console.error(e);
    }
  }

  function degToDirection(deg) {
    const directionsFa = ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨"];
    const directionsAr = ["Ø´Ù…Ø§Ù„", "Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ", "Ø´Ø±Ù‚", "Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ", "Ø¬Ù†ÙˆØ¨", "Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ", "ØºØ±Ø¨", "Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ"];
    const directions = currentLang === "fa" ? directionsFa : directionsAr;
    const index = Math.round(deg / 45) % 8;
    return directions[index];
  }

  function renderCurrentWeather(currentData, aqiData) {
    if (!currentData) return;
    const container = document.getElementById("currentWeather");
    container.innerHTML = "";

    const cityName = `${currentData.name}, ${currentData.sys.country}`;
    const iconUrl = `https://openweathermap.org/img/wn/${currentData.weather[0].icon}@4x.png`;
    const desc = currentData.weather[0].description;
    const temp = currentData.main.temp.toFixed(1);
    const humidity = currentData.main.humidity;
    const pressure = currentData.main.pressure;
    const windSpeed = currentData.wind.speed.toFixed(1);
    const windDeg = currentData.wind.deg;
    const visibility = currentData.visibility / 1000;
    const sunrise = new Date(currentData.sys.sunrise * 1000);
    const sunset = new Date(currentData.sys.sunset * 1000);
    const sunriseStr = sunrise.toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG", {hour: "2-digit", minute: "2-digit"});
    const sunsetStr = sunset.toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG", {hour: "2-digit", minute: "2-digit"});

    let aqiText = "";
    if (aqiData && aqiData.list && aqiData.list.length) {
      const aqi = aqiData.list[0].main.aqi;
      const aqiMapFa = ["Ø®ÙˆØ¨", "Ù†Ø³Ø¨ØªØ§ Ø®ÙˆØ¨", "Ù…ØªÙˆØ³Ø·", "Ø¨Ø¯", "Ø¨Ø³ÛŒØ§Ø± Ø¨Ø¯"];
      const aqiMapAr = ["Ø¬ÙŠØ¯", "Ø¬ÙŠØ¯ Ø¥Ù„Ù‰ Ø­Ø¯ Ù…Ø§", "Ù…ØªÙˆØ³Ø·", "Ø³ÙŠØ¡", "Ø³ÙŠØ¡ Ø¬Ø¯Ø§"];
      const aqiMap = currentLang === "fa" ? aqiMapFa : aqiMapAr;
      aqiText = `${labels[currentLang].aqi}: ${aqiMap[aqi-1]}`;
    }

    container.innerHTML = `
      <h2>${cityName}</h2>
      <img src="${iconUrl}" alt="${desc}" />
      <div class="temp">${temp}Â°C</div>
      <div class="desc">${desc}</div>
      <div class="details">
        <div><span class="detail-label">${labels[currentLang].humidity}:</span> ${humidity}%</div>
        <div><span class="detail-label">${labels[currentLang].pressure}:</span> ${pressure} hPa</div>
        <div><span class="detail-label">${labels[currentLang].windSpeed}:</span> ${windSpeed} m/s</div>
        <div><span class="detail-label">${labels[currentLang].windDir}:</span> ${degToDirection(windDeg)}</div>
        <div><span class="detail-label">${labels[currentLang].visibility}:</span> ${visibility.toFixed(1)} km</div>
        <div><span class="detail-label">${labels[currentLang].sunrise}:</span> ${sunriseStr}</div>
        <div><span class="detail-label">${labels[currentLang].sunset}:</span> ${sunsetStr}</div>
        <div>${aqiText}</div>
      </div>
      <button onclick="toggleFavorite('${currentData.name}')">
        ${favorites.includes(currentData.name) ? labels[currentLang].removeFav : labels[currentLang].addFav}
      </button>
    `;
  }

  // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Ùˆ Ø´Ø¨
  function groupForecastByDayNight(forecastList, sunriseTimestamp, sunsetTimestamp) {
    // sunriseTimestamp Ùˆ sunsetTimestamp Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡ ÛŒÙˆÙ†ÛŒÚ©Ø³ Ù‡Ø³ØªÙ†Ø¯
    // Ø±ÙˆØ² = Ø§Ø² Ø·Ù„ÙˆØ¹ ØªØ§ ØºØ±ÙˆØ¨ØŒ Ø´Ø¨ = Ø¨Ù‚ÛŒÙ‡ Ø³Ø§Ø¹Ø§Øª
    const dayData = [];
    const nightData = [];

    forecastList.forEach(item => {
      const time = item.dt;
      // Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡ Ø·Ù„ÙˆØ¹ ØªØ§ ØºØ±ÙˆØ¨ Ø¨Ø§Ø´Ø¯ Ø±ÙˆØ² Ø§Ø³Øª
      if (time >= sunriseTimestamp && time < sunsetTimestamp) {
        dayData.push(item);
      } else {
        nightData.push(item);
      }
    });
    return { dayData, nightData };
  }

  function calcAverage(dataArray, key) {
    if (!dataArray.length) return null;
    const sum = dataArray.reduce((acc, cur) => acc + cur.main[key], 0);
    return (sum / dataArray.length).toFixed(1);
  }

  function renderForecast(weatherData) {
    if (!weatherData || !weatherData.list || !weatherData.city) return;

    const dailyDiv = document.getElementById("dailyForecast");
    const hourlyDiv = document.getElementById("hourlyForecast");
    dailyDiv.innerHTML = "";
    hourlyDiv.innerHTML = "";

    // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆØ²
    const daysMap = new Map();
    weatherData.list.forEach(item => {
      const dateStr = new Date(item.dt * 1000).toISOString().slice(0, 10);
      if (!daysMap.has(dateStr)) daysMap.set(dateStr, []);
      daysMap.get(dateStr).push(item);
    });

    // Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ² Ùˆ Ø´Ø¨
    const daysArr = Array.from(daysMap.entries());

    // Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø®ÙˆØ±Ø´ÛŒØ¯ Ø±ÙˆØ² Ø§ÙˆÙ„ (Ø¨Ø±Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø±ÙˆØ² Ùˆ Ø´Ø¨)
    const sunrise = weatherData.city.sunrise || weatherData.list[0].sys?.sunrise || 0;
    const sunset = weatherData.city.sunset || weatherData.list[0].sys?.sunset || 0;

    // Ø³Ø§Ø®Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
    daysArr.forEach(([date, items], idx) => {
      // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§ÛŒ Ø±ÙˆØ² Ùˆ Ø´Ø¨ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
      // Ú†ÙˆÙ† API Ù…Ù…Ú©Ù† Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚ Ù†Ø¯Ù‡ØŒ Ù…Ø§ Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø±Ùˆ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
      // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø±Ùˆ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø§Ú¯Ù‡ Ø¯Ø§Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯)
      // Ø³Ø§Ø¯Ù‡â€ŒØªØ±: Ø§Ø² Ù‡Ù…Ø§Ù† Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø±ÙˆØ² Ø§ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ú©Ù…ÛŒ Ø®Ø·Ø§ Ø¯Ø§Ø±Ù‡ ÙˆÙ„ÛŒ Ú©Ø§ÙÛŒ Ø§Ø³Øª)

      // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Ùˆ Ø´Ø¨
      // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¢ÛŒØªÙ… Ø³Ø§Ø¹Øª Ø¯Ù‚ÛŒÙ‚ Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù¾Ø³ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒÙ… Ø¨Ø§ Ø³Ø§Ø¹Øª Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø³Ø§Ø¹ØªØ´ Ø±Ùˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù†ÛŒÙ…
      const dateObj = new Date(date + "T00:00:00");
      // Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø¢Ù† Ø±ÙˆØ² (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯) Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒÙ… (Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯Ù†ØŒ Ø§Ø² Ø±ÙˆØ² Ø§ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
      let sr = sunrise;
      let ss = sunset;

      // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ùˆ Ø´Ø¨
      const { dayData, nightData } = groupForecastByDayNight(items, sr, ss);

      // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§ Ø±ÙˆØ² Ùˆ Ø´Ø¨
      const avgDayTemp = calcAverage(dayData, "temp") ?? "-";
      const avgNightTemp = calcAverage(nightData, "temp") ?? "-";

      // Ø¢ÛŒÚ©ÙˆÙ† Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù…Ø§ÛŒ Ø±ÙˆØ² ÛŒØ§ Ø´Ø¨ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øª (Ø§Ú¯Ø± Ø¯Ù…Ø§ÛŒ Ø±ÙˆØ² Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯ØŒ Ø¢ÛŒÚ©ÙˆÙ† Ø±ÙˆØ² Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¢ÛŒÚ©ÙˆÙ† Ø´Ø¨)
      const iconCode = dayData.length > 0 ? dayData[0].weather[0].icon : (nightData.length > 0 ? nightData[0].weather[0].icon : "01d");

      const dateObjLocale = new Date(date + "T00:00:00");
      const optionsFa = { weekday: "short", day: "numeric", month: "numeric" };
      const optionsAr = { weekday: "short", day: "numeric", month: "numeric" };
      const dayName = dateObjLocale.toLocaleDateString(currentLang === "fa" ? "fa-IR" : "ar-EG", currentLang === "fa" ? optionsFa : optionsAr);

      const card = document.createElement("div");
      card.className = "day-card";
      card.dataset.index = idx;
      card.innerHTML = `
        <h3>${dayName}</h3>
        <img src="https://openweathermap.org/img/wn/${iconCode}@2x.png" alt="weather" />
        <div class="temp-day">${labels[currentLang].day}: ${avgDayTemp}Â°C</div>
        <div class="temp-night">${labels[currentLang].night}: ${avgNightTemp}Â°C</div>
      `;
      card.onclick = () => showHourlyForecast(items, idx);
      dailyDiv.appendChild(card);
    });

    // Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ²
    if (daysArr.length) showHourlyForecast(daysArr[0][1], 0);
  }

  // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø±ÙˆØ² Ùˆ Ø´Ø¨ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†
  function showHourlyForecast(dayItems, dayIndex) {
    const hourlyDiv = document.getElementById("hourlyForecast");
    hourlyDiv.innerHTML = "";

    // Ø­Ø°Ù Ú©Ù„Ø§Ø³ ÙØ¹Ø§Ù„ Ø§Ø² Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ùˆ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Øª ÙØ¹Ù„ÛŒ
    document.querySelectorAll(".day-card").forEach(card => card.classList.remove("active"));
    const activeCard = document.querySelector(`.day-card[data-index='${dayIndex}']`);
    if (activeCard) activeCard.classList.add("active");

    if (!dayItems.length) return;

    // Ø¨Ø±Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø±ÙˆØ² Ùˆ Ø´Ø¨ Ø¨Ø§ÛŒØ¯ Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…
    // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ø·Ù„ÙˆØ¹ Ùˆ ØºØ±ÙˆØ¨ Ù†Ø¯Ø§Ø´ØªÛŒÙ… Ø§Ø² Ø³Ø§Ø¹Øª 6 ØµØ¨Ø­ Ùˆ 18 Ø¹ØµØ± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ø² Ø±ÙˆØ² Ùˆ Ø´Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const sunriseTimestamp = dayItems[0].sys?.sunrise || (new Date(dayItems[0].dt * 1000).setHours(6, 0, 0, 0) / 1000);
    const sunsetTimestamp = dayItems[0].sys?.sunset || (new Date(dayItems[0].dt * 1000).setHours(18, 0, 0, 0) / 1000);

    // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ùˆ Ø´Ø¨
    const { dayData, nightData } = groupForecastByDayNight(dayItems, sunriseTimestamp, sunsetTimestamp);

    // Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø±ÙˆØ²
    const dayGroup = document.createElement("div");
    dayGroup.className = "hour-group";
    const dayHeader = document.createElement("div");
    dayHeader.className = "hour-group-header";
    dayHeader.textContent = labels[currentLang].hourlyTitleDay;
    dayGroup.appendChild(dayHeader);

    const dayContent = document.createElement("div");
    dayContent.className = "hour-group-content";
    dayGroup.appendChild(dayContent);

    dayHeader.onclick = () => {
      dayContent.style.display = dayContent.style.display === "block" ? "none" : "block";
    };

    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø¹ØªÛŒ Ø±ÙˆØ²
    dayData.forEach(item => {
      const hourCard = createHourCard(item);
      dayContent.appendChild(hourCard);
    });

    // Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø´Ø¨
    const nightGroup = document.createElement("div");
    nightGroup.className = "hour-group";
    const nightHeader = document.createElement("div");
    nightHeader.className = "hour-group-header";
    nightHeader.textContent = labels[currentLang].hourlyTitleNight;
    nightGroup.appendChild(nightHeader);

    const nightContent = document.createElement("div");
    nightContent.className = "hour-group-content";
    nightGroup.appendChild(nightContent);

    nightHeader.onclick = () => {
      nightContent.style.display = nightContent.style.display === "block" ? "none" : "block";
    };

    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø¹ØªÛŒ Ø´Ø¨
    nightData.forEach(item => {
      const hourCard = createHourCard(item);
      nightContent.appendChild(hourCard);
    });

    hourlyDiv.appendChild(dayGroup);
    hourlyDiv.appendChild(nightGroup);

    // Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú¯Ø±ÙˆÙ‡ Ø±ÙˆØ² Ùˆ Ø¨Ø³ØªÙ‡ Ø¨ÙˆØ¯Ù† Ø´Ø¨
    dayContent.style.display = "block";
    nightContent.style.display = "none";
  }

  function createHourCard(item) {
    const date = new Date(item.dt * 1000);
    const timeStr = date.toLocaleTimeString(currentLang === "fa" ? "fa-IR" : "ar-EG", {
      hour: "2-digit",
      minute: "2-digit"
    });

    return (() => {
      const card = document.createElement("div");
      card.className = "hour-card";

      const icon = document.createElement("img");
      icon.src = `https://openweathermap.org/img/wn/${item.weather[0].icon}@2x.png`;
      icon.alt = item.weather[0].description;
      card.appendChild(icon);

      const infoDiv = document.createElement("div");
      infoDiv.className = "hour-info";

      const descDiv = document.createElement("div");
      descDiv.textContent = `${labels[currentLang].description}: ${item.weather[0].description}`;
      infoDiv.appendChild(descDiv);

      const timeDiv = document.createElement("div");
      timeDiv.innerHTML = `<span class="detail-label">Ø³Ø§Ø¹Øª:</span> ${timeStr}`;
      infoDiv.appendChild(timeDiv);

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = `<span class="detail-label">${labels[currentLang].temp}:</span> ${item.main.temp.toFixed(1)}Â°C`;
      infoDiv.appendChild(tempDiv);

      const humidityDiv = document.createElement("div");
      humidityDiv.innerHTML = `<span class="detail-label">${labels[currentLang].humidity}:</span> ${item.main.humidity}%`;
      infoDiv.appendChild(humidityDiv);

      const pressureDiv = document.createElement("div");
      pressureDiv.innerHTML = `<span class="detail-label">${labels[currentLang].pressure}:</span> ${item.main.pressure} hPa`;
      infoDiv.appendChild(pressureDiv);

      const windDiv = document.createElement("div");
      windDiv.innerHTML = `<span class="detail-label">${labels[currentLang].windSpeed}:</span> ${item.wind.speed.toFixed(1)} m/s, <span class="detail-label">${labels[currentLang].windDir}:</span> ${degToDirection(item.wind.deg)}`;
      infoDiv.appendChild(windDiv);

      card.appendChild(infoDiv);

      return card;
    })();
  }

  function initMap(lat, lon) {
    map = L.map("map").setView([lat, lon], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    mapMarker = L.marker([lat, lon]).addTo(map);
  }

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø´Ù‡Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù‡ÙˆØ§Ø²
  window.onload = () => {
    document.getElementById("cityInput").value = "Ø§Ù‡ÙˆØ§Ø²";
    toggleLang(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ø¨Ø§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    renderFavorites();
    searchCity();
  };
</script>

</body>
</html>
